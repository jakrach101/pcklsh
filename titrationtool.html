<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opioid Calculator (Modern Design)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- Modern Neumorphic Design --- */
        :root {
            --bg-color: #eef0f4;
            --primary-color: #0891b2; /* Cyan-600 */
            --primary-text: #0e7490; /* Cyan-700 */
            --dark-shadow: #d1d9e6;
            --light-shadow: #ffffff;
            --text-color: #4b5563; /* Gray-600 */
            --text-light: #6b7280; /* Gray-500 */
            --card-radius: 1.25rem; /* 20px */
            --input-radius: 0.75rem; /* 12px */
        }

        body { 
            font-family: 'Sarabun', sans-serif; 
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        /* Main Card Style */
        .card {
            background: var(--bg-color);
            border-radius: var(--card-radius);
            box-shadow: 8px 8px 16px var(--dark-shadow), -8px -8px 16px var(--light-shadow);
            padding: 1.25rem; /* 20px */
        }
        
        /* Input & Select Field Styles */
        .input-field, .select-field {
            width: 100%;
            border: none;
            outline: none;
            background: var(--bg-color);
            border-radius: var(--input-radius);
            padding: 0.75rem 1rem;
            font-size: 16px; /* iOS zoom fix */
            color: var(--text-color);
            box-shadow: inset 5px 5px 10px var(--dark-shadow), inset -5px -5px 10px var(--light-shadow);
            transition: all 0.2s ease-in-out;
        }
        @media (min-width: 640px) {
            .input-field, .select-field { font-size: 0.875rem; }
        }
        .input-field:focus, .select-field:focus {
            box-shadow: inset 2px 2px 4px var(--dark-shadow), inset -2px -2px 4px var(--light-shadow), 0 0 0 2px var(--primary-color);
        }
        .input-field:disabled {
            color: var(--text-light);
            box-shadow: inset 2px 2px 4px var(--dark-shadow), inset -2px -2px 4px var(--light-shadow);
            cursor: not-allowed;
        }

        .select-field { 
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.75rem center; background-repeat: no-repeat;
            background-size: 1.25em 1.25em; padding-right: 2.5rem;
        }

        /* Button Styles */
        .action-btn {
            background: var(--bg-color);
            border-radius: 9999px;
            width: 2.5rem; height: 2.5rem;
            display: inline-flex; align-items: center; justify-content: center;
            cursor: pointer;
            color: var(--text-light);
            box-shadow: 4px 4px 8px var(--dark-shadow), -4px -4px 8px var(--light-shadow);
            transition: all 0.2s ease-in-out;
            border: 1px solid rgba(255,255,255,0.5);
        }
        .action-btn:hover {
            color: var(--primary-text);
        }
        .action-btn:active {
            box-shadow: inset 3px 3px 6px var(--dark-shadow), inset -3px -3px 6px var(--light-shadow);
            transform: scale(0.98);
        }
        .pin-btn.pinned { color: #0e7490; box-shadow: inset 3px 3px 6px #a6d8e4, inset -3px -3px 6px #ffffff; }
        .pin-btn.balance-decrease { color: #c2410c; box-shadow: inset 3px 3px 6px #fbc1aa, inset -3px -3px 6px #ffffff; }
        .pin-btn.balance-increase { color: #15803d; box-shadow: inset 3px 3px 6px #bbf7d0, inset -3px -3px 6px #ffffff; }
        .pin-btn.locked { color: #be123c; box-shadow: inset 3px 3px 6px #fecdd3, inset -3px -3px 6px #ffffff; }

        .utility-btn {
            background: var(--bg-color);
            color: var(--text-light);
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: var(--input-radius);
            box-shadow: 3px 3px 6px var(--dark-shadow), -3px -3px 6px var(--light-shadow);
            transition: all 0.2s;
            font-size: 0.875rem;
            border: 1px solid rgba(255,255,255,0.5);
        }
        .utility-btn:hover { color: var(--text-color); }
        .utility-btn.active {
            background-color: var(--primary-color);
            color: white;
            box-shadow: inset 3px 3px 6px #06738f, inset -3px -3px 6px #0acff7;
        }
        .utility-btn.decrease.active { background-color: #dc2626; box-shadow: inset 3px 3px 6px #b01e1e, inset -3px -3px 6px #ff2e2e; }

        /* Modal styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.4); backdrop-filter: blur(8px);
            display: flex; align-items: center; justify-content: center; z-index: 50;
            opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content {
            position: relative;
            background: var(--bg-color);
            padding: 1.5rem;
            border-radius: var(--card-radius);
            width: 90%; max-width: 500px;
            transform: scale(0.95); transition: transform 0.3s;
            box-shadow: 12px 12px 24px rgba(0,0,0,0.2), -12px -12px 24px rgba(255,255,255,0.7);
        }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-close-btn { position: absolute; top: 0.75rem; right: 0.75rem; }

        /* Drug Row Styles */
        .drug-row {
            transition: background-color 0.3s;
            padding: 1rem 0.5rem;
            border-bottom: 1px solid var(--dark-shadow);
        }
        .drug-row:last-child { border-bottom: none; }
        .drug-row.pinned-row { background-color: #e0f2fe; }
        .drug-row.balance-decrease-row { background-color: #fff7ed; }
        .drug-row.balance-increase-row { background-color: #f0fdf4; }

        .drug-name-btn:hover .drug-name-text { color: var(--primary-text); }
        .row-mme-ref:hover { text-decoration: underline; }
    </style>
</head>
<body class="p-3 sm:p-4 md:p-8">

    <div class="max-w-4xl mx-auto space-y-6">
        
        <!-- Header -->
        <header class="flex justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Opioid Calculator</h1>
                <p class="text-sm text-gray-500">เครื่องมือคำนวณและหมุนเวียนยาแก้ปวด</p>
            </div>
            <div class="flex items-center gap-2">
                <button id="safety-checklist-btn" class="action-btn" title="Clinical Pearls">
                    <i class="fas fa-check-circle text-yellow-500"></i>
                </button>
                <button id="clear-all-btn" class="action-btn" title="ล้างข้อมูลทั้งหมด">
                    <i class="fas fa-trash text-red-500"></i>
                </button>
            </div>
        </header>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Left Column: Inputs -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- Current Opioids Card -->
                <div class="card">
                    <h2 class="text-lg font-bold text-gray-700 mb-4">Current Opioids</h2>
                    <div id="medication-section" class="space-y-2"></div>
                </div>

                <!-- Titration Tool Card -->
                <div id="titration-tool-container" class="card">
                     <div id="titration-tool-header" class="flex justify-between items-center cursor-pointer -m-2 p-2 rounded-lg">
                        <div class="flex items-center gap-3 flex-1 min-w-0">
                            <h2 class="text-lg font-bold text-gray-700">Dose Adjustment</h2>
                            <span id="titration-target-display" class="text-xs font-semibold text-cyan-700 truncate bg-cyan-50 px-2 py-1 rounded-full"></span>
                        </div>
                        <button id="titration-toggle-btn" class="action-btn w-10 h-10">
                            <i id="titration-toggle-icon" class="fas fa-chevron-down transition-transform"></i>
                        </button>
                     </div>
                     <div id="titration-tool-content" class="mt-4 space-y-4 transition-all duration-300">
                        <div class="flex justify-center">
                            <div id="titration-mode-toggle" class="flex border border-slate-200 rounded-xl p-1 text-sm bg-slate-200/50 shadow-inner">
                                 <button class="utility-btn titration-mode-btn !shadow-none !border-none" data-mode="prn">PRN</button>
                                 <button class="utility-btn titration-mode-btn !shadow-none !border-none" data-mode="percent">%</button>
                                 <button class="utility-btn titration-mode-btn !shadow-none !border-none" data-mode="balance">Balance</button>
                            </div>
                        </div>
                        <div id="prn-titration-section" class="space-y-3">
                            <div id="breakthrough-rows-container"></div>
                            <button id="add-breakthrough-btn" class="w-full text-center py-2 text-cyan-700 hover:text-cyan-900 font-semibold text-sm flex items-center justify-center gap-2 border-2 border-dashed border-cyan-200 rounded-lg hover:bg-cyan-50 transition">
                                <i class="fas fa-plus-circle"></i>
                                <span>Add Breakthrough</span>
                            </button>
                        </div>
                        <div id="percent-titration-section" class="hidden">
                            <div class="flex items-center justify-center gap-2 flex-wrap">
                                <button class="utility-btn percent-adjust-btn decrease" data-percent="-50">-50%</button>
                                <button class="utility-btn percent-adjust-btn decrease" data-percent="-25">-25%</button>
                                <button class="utility-btn percent-adjust-btn" data-percent="0">0%</button>
                                <button class="utility-btn percent-adjust-btn increase" data-percent="30">+30%</button>
                                <button class="utility-btn percent-adjust-btn increase" data-percent="50">+50%</button>
                                <input type="number" inputmode="decimal" id="custom-percent-input" class="input-field w-24 text-center" placeholder="...">
                            </div>
                        </div>
                        <div id="balance-titration-section" class="hidden text-center p-3 bg-orange-50 rounded-lg border border-orange-200">
                            <p id="balance-instruction" class="text-sm text-orange-800 font-medium"></p>
                        </div>
                     </div>
                </div>

            </div>

            <!-- Right Column: Results & Rotation -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Total MME Card -->
                <div id="total-mme-box" class="card text-center">
                    <div id="total-mme-normal-view">
                        <h2 class="text-lg font-semibold text-cyan-800">Total MME/day</h2>
                        <p id="total-mme-display" class="text-6xl font-bold text-cyan-900 my-2 tracking-tight cursor-pointer" title="คลิกเพื่อดู Quick Reference">0</p>
                        <p id="empty-state-message" class="text-gray-500 text-sm">กรอกขนาดยาเพื่อเริ่มคำนวณ</p>
                        <button id="rotate-btn" class="utility-btn bg-cyan-600 text-white hover:bg-cyan-700 active:bg-cyan-800 w-full mt-4 hidden">
                            <i class="fas fa-sync-alt mr-2"></i>
                            Opioid Rotation
                        </button>
                    </div>
                    <div id="total-mme-rotation-view" class="hidden">
                        <div class="flex justify-between items-center mb-2">
                             <h2 class="text-lg font-semibold text-red-800">Opioid Rotation</h2>
                             <button id="cancel-rotate-btn" class="action-btn w-9 h-9 bg-red-100 hover:bg-red-200" title="ยกเลิกการหมุนเวียนยา">
                                <i class="fas fa-times text-red-700"></i>
                            </button>
                        </div>
                        <div id="rotation-adjustment-display" class="text-gray-600 text-base"></div>
                    </div>
                </div>

                <!-- Rotation Tools Card -->
                <div id="rotation-tools" class="hidden card !p-0 overflow-hidden">
                    <div class="p-5">
                        <h3 class="font-bold text-green-800 text-lg">Rotation Tool</h3>
                        <div id="rotation-mme-ref" class="text-right text-xs sm:text-sm text-gray-500 -mt-5"></div>
                    </div>
                    <div class="space-y-3 bg-green-50/50 p-5 border-t border-green-200">
                        <div id="basal-recommendation" class="bg-white/70 p-3 rounded-lg shadow-sm border">
                            <div class="flex justify-between items-center flex-wrap gap-2">
                                 <label class="font-semibold text-gray-700 text-sm">Basal Dose</label>
                                 <div class="flex items-center gap-2">
                                    <select id="basal-calc-drug" class="select-field !text-xs !p-1 !rounded-md w-36 sm:w-40"></select>
                                    <button id="basal-helper-btn" class="action-btn !w-8 !h-8 text-cyan-700 hover:bg-cyan-100 hidden" title="เครื่องมือช่วยคำนวณ">
                                        <i class="fas fa-calculator"></i>
                                    </button>
                                 </div>
                            </div>
                            <div id="basal-recommendation-text" class="text-lg text-green-800 font-bold mt-2 p-2 bg-green-50 rounded-md text-center"></div>
                        </div>
                        <div id="breakthrough-recommendation" class="bg-white/70 p-3 rounded-lg shadow-sm border">
                            <div class="flex justify-between items-center flex-wrap gap-2">
                                 <label class="font-semibold text-gray-700 text-sm">Breakthrough</label>
                                 <div class="flex items-center gap-2">
                                    <select id="breakthrough-calc-drug" class="select-field !text-xs !p-1 !rounded-md w-36 sm:w-40"></select>
                                    <select id="breakthrough-calc-percent" class="select-field !text-xs !p-1 !rounded-md w-20">
                                        <option value="0.1667">1/6 TDD</option>
                                        <option value="0.15">15% TDD</option>
                                        <option value="0.1">10% TDD</option>
                                    </select>
                                 </div>
                            </div>
                            <p id="breakthrough-recommendation-text" class="text-base sm:text-lg text-green-800 font-bold mt-2 p-2 bg-green-50 rounded-md text-center"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="drug-info-modal" class="modal-overlay">
        <div class="modal-content space-y-3">
            <button id="close-drug-info-modal-btn" class="action-btn modal-close-btn">&times;</button>
            <h3 id="drug-info-title" class="text-xl font-bold text-gray-800"></h3>
            <div id="drug-info-content" class="text-sm text-gray-700 space-y-2"></div>
        </div>
    </div>

    <div id="tdd-helper-modal" class="modal-overlay">
        <div class="modal-content space-y-4">
            <button id="close-tdd-helper-modal-btn" class="action-btn modal-close-btn">&times;</button>
            <h3 class="text-lg font-bold text-gray-800">TDD from IV Rate</h3>
            <div class="bg-gray-50 p-3 rounded-lg">
                <p class="text-sm font-medium text-gray-500">ยาที่คำนวณ</p>
                <p id="tdd-helper-drug-name" class="text-lg font-bold text-cyan-700"></p>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div>
                    <label for="tdd-helper-drug-amount" class="block text-sm font-medium text-gray-700">Drug (<span id="tdd-helper-drug-unit">mg</span>)</label>
                    <input type="number" inputmode="decimal" id="tdd-helper-drug-amount" class="input-field mt-1 text-right" placeholder="100">
                </div>
                <div>
                    <label for="tdd-helper-fluid-volume" class="block text-sm font-medium text-gray-700">Volume (mL)</label>
                    <input type="number" inputmode="decimal" id="tdd-helper-fluid-volume" class="input-field mt-1 text-right" placeholder="100">
                </div>
                <div>
                    <label for="tdd-helper-rate" class="block text-sm font-medium text-gray-700">Rate (mL/hr)</label>
                    <input type="number" inputmode="decimal" id="tdd-helper-rate" class="input-field mt-1 text-right" placeholder="2">
                </div>
            </div>
            <div class="bg-blue-50 p-3 rounded-lg text-center border border-blue-200">
                <p class="text-sm font-medium text-gray-500">Calculated TDD</p>
                <p id="tdd-helper-result-display" class="text-2xl font-bold text-blue-800">0</p>
            </div>
            <button id="confirm-tdd-helper-btn" class="w-full utility-btn !bg-cyan-600 !text-white hover:!bg-cyan-700 active:!bg-cyan-800">ยืนยัน</button>
        </div>
    </div>

    <div id="csci-modal" class="modal-overlay">
        <div class="modal-content space-y-4">
            <button id="cancel-csci-modal-btn" class="action-btn modal-close-btn">&times;</button>
            <h3 class="text-lg font-bold text-gray-800">CSCI Helper</h3>
            <div class="bg-gray-50 p-3 rounded-lg">
                <p class="text-sm font-medium text-gray-500">ยาที่คำนวณ</p>
                <p id="csci-drug-name" class="text-lg font-bold text-cyan-700 mb-2"></p>
                <div class="flex justify-between items-center">
                    <label for="csci-total-dose-input" class="block text-sm font-medium text-gray-700">Dose/24hr (<span id="csci-dose-unit"></span>)</label>
                    <button id="csci-reset-dose-btn" class="action-btn !w-7 !h-7" title="Reset Dose"><i class="fas fa-undo"></i></button>
                </div>
                <input type="number" inputmode="decimal" id="csci-total-dose-input" class="input-field mt-1 text-lg font-bold text-cyan-700">
                <p id="csci-new-mme" class="text-xs text-center text-gray-500 mt-1 h-4"></p>
            </div>
            <div class="space-y-3">
                <div>
                    <label for="csci-syringe-size" class="block text-sm font-medium text-gray-700">Syringe Size</label>
                    <select id="csci-syringe-size" class="select-field mt-1"><option value="30">30 ml</option><option value="20">20 ml</option><option value="50">50 ml</option></select>
                </div>
                <div>
                    <label for="csci-total-volume" class="block text-sm font-medium text-gray-700">Total Volume (ml)</label>
                    <input type="number" inputmode="decimal" id="csci-total-volume" class="input-field mt-1" placeholder="e.g. 22, 24, 48">
                </div>
            </div>
            <div id="csci-result-wrapper">
                <div id="csci-error" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-3 rounded-md hidden"><p id="csci-error-text"></p></div>
                <div id="csci-result" class="bg-blue-50 p-3 rounded-lg border border-blue-200 space-y-2 hidden">
                    <p class="font-semibold">ผลการคำนวณ:</p>
                    <div class="grid grid-cols-3 gap-2 text-sm text-center">
                        <div><span class="font-medium block">Drug Vol.</span><strong id="csci-drug-volume" class="text-blue-800"></strong></div>
                        <div><span class="font-medium block">NSS Vol.</span><strong id="csci-diluent-volume" class="text-blue-800"></strong></div>
                        <div><span class="font-medium block">Rate (ml/hr)</span><strong id="csci-rate-ml" class="text-blue-800"></strong></div>
                    </div>
                    <div class="text-center mt-2"><span class="font-medium">Rate (mm/hr)</span><strong id="csci-rate-mm" class="text-blue-800 text-lg ml-2"></strong></div>
                    <div class="mt-2 pt-2 border-t border-blue-200">
                        <p class="font-semibold">ตัวอย่างการสั่งยา:</p>
                        <p id="csci-order-text" class="text-xs text-gray-700 bg-gray-100 p-2 rounded"></p>
                    </div>
                </div>
            </div>
            <button id="close-csci-modal-btn" class="w-full utility-btn !bg-cyan-600 !text-white hover:!bg-cyan-700 active:!bg-cyan-800">ยืนยัน</button>
        </div>
    </div>

    <div id="iv-infusion-modal" class="modal-overlay">
        <div class="modal-content space-y-4">
            <button id="cancel-iv-modal-btn" class="action-btn modal-close-btn">&times;</button>
            <h3 class="text-lg font-bold text-gray-800">IV Infusion Helper</h3>
            <div class="bg-gray-50 p-3 rounded-lg">
                <p class="text-sm font-medium text-gray-500">ยาที่คำนวณ</p>
                <p id="iv-drug-name" class="text-lg font-bold text-cyan-700 mb-2"></p>
                <div class="flex justify-between items-center">
                    <label for="iv-total-dose-input" class="block text-sm font-medium text-gray-700">Dose/24hr (<span id="iv-dose-unit"></span>)</label>
                     <button id="iv-reset-dose-btn" class="action-btn !w-7 !h-7" title="Reset Dose"><i class="fas fa-undo"></i></button>
                </div>
                <input type="number" inputmode="decimal" id="iv-total-dose-input" class="input-field mt-1 text-lg font-bold text-cyan-700">
                <p id="iv-new-mme" class="text-xs text-center text-gray-500 mt-1 h-4"></p>
            </div>
             <div>
                <label for="iv-fluid-volume" class="block text-sm font-medium text-gray-700">Fluid Volume (ml)</label>
                <input type="number" inputmode="decimal" id="iv-fluid-volume" class="input-field mt-1" value="100">
            </div>
            <div id="iv-result-wrapper">
                <div id="iv-error" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-3 rounded-md hidden"><p id="iv-error-text"></p></div>
                <div id="iv-result" class="bg-blue-50 p-3 rounded-lg border border-blue-200 space-y-2 hidden">
                    <p class="font-semibold">ผลการคำนวณ:</p>
                    <div class="grid grid-cols-2 gap-2 text-sm text-center">
                        <div><span class="font-medium block">Concentration</span><strong id="iv-concentration" class="text-blue-800"></strong></div>
                        <div><span class="font-medium block">Dose/hr</span><strong id="iv-dose-hr" class="text-blue-800"></strong></div>
                    </div>
                    <div class="mt-2 pt-2 border-t border-blue-200">
                        <p class="font-semibold">ตัวอย่างการสั่งยา:</p>
                        <p id="iv-order-text" class="text-xs text-gray-700 bg-gray-100 p-2 rounded"></p>
                    </div>
                </div>
            </div>
            <button id="close-iv-infusion-modal-btn" class="w-full utility-btn !bg-cyan-600 !text-white hover:!bg-cyan-700 active:!bg-cyan-800">ยืนยัน</button>
        </div>
    </div>

    <div id="safety-modal" class="modal-overlay">
        <div class="modal-content space-y-4">
            <button id="close-safety-modal-btn" class="action-btn modal-close-btn">&times;</button>
            <h3 class="text-lg font-bold text-yellow-800 flex items-center gap-2"><i class="fas fa-check-circle"></i> Clinical Pearls</h3>
            <ul class="list-disc list-inside space-y-2 text-gray-700 text-sm">
                <li><strong>การประเมินผู้ป่วย:</strong> อายุ, การทำงานของไตและตับ, ภาวะสับสน (Delirium), ประวัติการใช้ Opioids.</li>
                <li><strong>ยาที่ใช้ร่วมกัน:</strong> โดยเฉพาะกลุ่ม Benzodiazepines หรือ Gabapentinoids.</li>
                <li><strong>Incomplete Cross-Tolerance:</strong> พิจารณาลดยา 25-50% เมื่อทำการหมุนเวียนยา.</li>
                 <li><strong>เป้าหมายการรักษา:</strong> ตั้งเป้าหมาย (Goal of Care) ร่วมกับผู้ป่วยและครอบครัวเสมอ.</li>
            </ul>
            <div class="mt-4 pt-4 border-t border-yellow-200">
                <h4 class="font-semibold text-yellow-900 mb-2">ตัวอย่างรายการยา (Formulary)</h4>
                <ul class="list-disc list-inside space-y-1 text-sm text-gray-600">
                    <li>MST (10mg, 30mg)</li>
                    <li>Kapanol (20mg)</li>
                    <li>Morphine injection 10mg/ampule</li>
                    <li>Fentanyl patch (25mcg/hr)</li>
                    <li>Fentanyl injection 100mcg/ampule</li>
                    <li>Morphine IR (10mg)</li>
                    <li>Morphine Syrup (2mg/ml)</li>
                </ul>
            </div>
        </div>
    </div>

    <div id="quick-ref-modal" class="modal-overlay">
        <div class="modal-content space-y-4">
            <button id="close-quick-ref-modal-btn" class="action-btn modal-close-btn">&times;</button>
            <h3 id="quick-ref-title" class="text-lg font-bold text-gray-800">Quick Reference</h3>
            <div class="bg-gray-50 p-3 rounded-lg text-center">
                <p class="text-sm font-medium text-gray-500">MME/day</p>
                <p id="quick-ref-mme-total" class="text-2xl font-bold text-cyan-700"></p>
            </div>
            <div id="quick-ref-list" class="space-y-2"></div>
        </div>
    </div>


<script>
// The entire JavaScript from the original file is placed here, unchanged.
// This ensures all functionality remains identical.
document.addEventListener('DOMContentLoaded', () => {

    // --- CONFIGURATION ---
    const DRUG_CONFIG = {
        'fentanyl_patch': { 
            name: 'Fentanyl Patch', 
            factor: 2.4, unit: 'mcg/hr', type: 'patch', isBasal: true, step: 12.5,
            info: `
                <p><strong>Onset:</strong> 12-24 ชั่วโมง, ออกฤทธิ์เต็มที่ 72 ชั่วโมง</p>
                <p><strong>ข้อควรระวัง:</strong></p>
                <ul class="list-disc list-inside pl-4">
                    <li>ไม่เหมาะสำหรับแก้ปวดเฉียบพลัน (Acute Pain) หรือในผู้ป่วยที่ยังปรับยาไม่คงที่</li>
                    <li>ไข้สูง (Fever > 40°C) อาจเพิ่มการดูดซึมยาได้ถึง 1/3</li>
                    <li>แนะนำให้ทิ้งแผ่นแปะที่ใช้แล้วอย่างถูกวิธี (พับด้านกาวเข้าหากัน)</li>
                    <li>เป็นตัวเลือกที่ดีในผู้ป่วยไตวายรุนแรง (Severe Renal Impairment)</li>
                </ul>
            `
        },
        'mst_10': { 
            name: 'MST 10mg', 
            factor: 1, unit: 'เม็ด/day', type: 'oral', isBasal: true, strength: 10, step: 1,
            info: `
                <p><strong>Onset:</strong> ~1 ชั่วโมง, ออกฤทธิ์นาน 8-12 ชั่วโมง</p>
                <p><strong>ข้อควรระวัง:</strong></p>
                <ul class="list-disc list-inside pl-4">
                    <li>ห้ามหัก แบ่ง หรือเคี้ยวยาเม็ด</li>
                    <li>ควรระวังการใช้ในผู้ป่วยไตวาย (eGFR < 30 ml/min) เนื่องจาก Metabolites (M3G, M6G) อาจสะสมและเกิดพิษได้</li>
                </ul>
            `
        },
        'mst_30': { 
            name: 'MST 30mg', 
            factor: 1, unit: 'เม็ด/day', type: 'oral', isBasal: true, strength: 30, step: 1,
            info: `
                <p><strong>Onset:</strong> ~1 ชั่วโมง, ออกฤทธิ์นาน 8-12 ชั่วโมง</p>
                <p><strong>ข้อควรระวัง:</strong></p>
                <ul class="list-disc list-inside pl-4">
                    <li>ห้ามหัก แบ่ง หรือเคี้ยวยาเม็ด</li>
                    <li>ควรระวังการใช้ในผู้ป่วยไตวาย (eGFR < 30 ml/min) เนื่องจาก Metabolites (M3G, M6G) อาจสะสมและเกิดพิษได้</li>
                </ul>
            `
        },
        'kapanol_20': { 
            name: 'Kapanol 20mg', 
            factor: 1, unit: 'แคปซูล/day', type: 'oral', isBasal: true, strength: 20, step: 1,
            info: `
                <p><strong>Onset:</strong> ~1 ชั่วโมง, ออกฤทธิ์นาน 12-24 ชั่วโมง</p>
                <p><strong>ข้อควรระวัง:</strong></p>
                <ul class="list-disc list-inside pl-4">
                    <li>ห้ามเคี้ยวเม็ด Granules ข้างใน แต่สามารถเปิดแคปซูลแล้วโรยบนอาหารเหลวได้ (สำหรับผู้ป่วยมีปัญหาการกลืน)</li>
                    <li>ควรระวังการใช้ในผู้ป่วยไตวาย (eGFR < 30 ml/min) เช่นเดียวกับ MST</li>
                </ul>
            `
        },
        'morphine_iv_sc': { 
            name: 'Morphine IV/SC', 
            factor: 3, unit: 'mg/day', type: 'injectable', isBasal: true, isBreakthrough: true,
            info: `
                <p><strong>Onset:</strong> IV ~5 นาที, SC ~15-30 นาที</p>
                <p><strong>ข้อควรระวัง:</strong></p>
                <ul class="list-disc list-inside pl-4">
                    <li>ใช้สำหรับผู้ป่วยที่มีอาการปวดรุนแรง หรือไม่สามารถรับประทานยาได้</li>
                    <li>ต้องปรับลดขนาดยาในผู้ป่วยไตวาย (eGFR < 30 ml/min) และติดตามอาการข้างเคียงอย่างใกล้ชิด</li>
                </ul>
            `
        },
        'fentanyl_iv_sc': { 
            name: 'Fentanyl IV/SC', 
            factor: 0.3, unit: 'mcg/day', type: 'injectable', isBasal: true, isBreakthrough: true,
            info: `
                <p><strong>Onset:</strong> IV ~1-2 นาที, ออกฤทธิ์สั้น (30-60 นาที)</p>
                <p><strong>ข้อดี:</strong></p>
                <ul class="list-disc list-inside pl-4">
                    <li>เป็นตัวเลือกที่ปลอดภัยในผู้ป่วยไตวายรุนแรง (Severe Renal Impairment)</li>
                    <li>เหมาะสำหรับ Titrate อาการปวดที่รุนแรงและต้องการการตอบสนองที่รวดเร็ว</li>
                </ul>
            `
        },
        'morphine_ir_tab_10': { 
            name: 'Morphine IR 10mg', 
            factor: 1, unit: 'เม็ด/day', type: 'oral', isBreakthrough: true, strength: 10, step: 1,
            info: `
                <p><strong>Onset:</strong> 30-60 นาที, ออกฤทธิ์นาน 4-6 ชั่วโมง</p>
                <p><strong>การใช้งาน:</strong></p>
                <ul class="list-disc list-inside pl-4">
                    <li>ใช้สำหรับบรรเทาอาการปวดกำเริบ (Breakthrough Pain)</li>
                    <li>ขนาดยาที่ใช้通常คิดเป็น 10-15% ของขนาดยาหลักต่อวัน (Total Daily Dose)</li>
                </ul>
            `
        },
        'morphine_syrup': { 
            name: 'Morphine Syrup 2mg/ml', 
            factor: 1, unit: 'mL/day', type: 'oral', isBreakthrough: true, strength: 2,
            info: `
                <p><strong>Onset:</strong> 30-60 นาที, ออกฤทธิ์นาน 4-6 ชั่วโมง</p>
                <p><strong>การใช้งาน:</strong></p>
                <ul class="list-disc list-inside pl-4">
                    <li>ใช้สำหรับบรรเทาอาการปวดกำเริบ (Breakthrough Pain) โดยเฉพาะในผู้ป่วยที่มีปัญหาการกลืน</li>
                    <li>ง่ายต่อการปรับขนาดยา (Titration) ทีละน้อย</li>
                </ul>
            `
        },
    };

    const ROTATION_DRUGS = {
        'fentanyl_patch': { name: 'Fentanyl Patch', factor: 2.4, unit: 'mcg/hr', allowedDoses: [12.5, 25, 50, 75, 100] },
        'morphine_sr': { 
            name: 'Morphine SR', factor: 1, unit: 'mg/day',
            prescriptionHelper: {
                strengths: [
                    { name: 'MST 30mg', value: 30, unit: 'เม็ด' },
                    { name: 'Kapanol 20mg', value: 20, unit: 'แคปซูล' },
                    { name: 'MST 10mg', value: 10, unit: 'เม็ด' }
                ]
            }
        },
        'morphine_iv_infusion': { name: 'Morphine (IV Infusion)', factor: 3, unit: 'mg/day', helper: 'iv_infusion', drugInfo: { name: 'Morphine', concentration: 10, unit: 'mg/ml' } },
        'fentanyl_iv_infusion': { name: 'Fentanyl (IV Infusion)', factor: 0.3, unit: 'mcg/day', helper: 'iv_infusion', drugInfo: { name: 'Fentanyl', concentration: 50, unit: 'mcg/ml' } },
        'morphine_csci': { name: 'Morphine (CSCI)', factor: 3, unit: 'mg/day', helper: 'csci', drugInfo: { name: 'Morphine', concentration: 10, unit: 'mg/ml' } },
        'fentanyl_csci': { name: 'Fentanyl (CSCI)', factor: 0.3, unit: 'mcg/day', helper: 'csci', drugInfo: { name: 'Fentanyl', concentration: 50, unit: 'mcg/ml' } },
    };

    const SYRINGE_DATA = { 'BD': { 20: { length: 88.0 }, 30: { length: 87.5 }, 50: { length: 123.0 } } };
    const LOCAL_STORAGE_KEY = 'opioidCalculatorDataV5_Modern'; // Updated version key

    // --- STATE ---
    let pinnedDrugKey = null;
    let rotationMME = null; 
    let titrationMode = 'prn';
    let percentAdjustment = 0;
    let prnCount = 0;
    let balancePair = { decreaseKey: null, increaseKey: null };
    let isBalancingFromUser = false;
    let rotationDoseInfo = { drugKey: '', dose: 0, helperResult: null, originalDose: 0 };
    let tddHelperTargetKey = null;
    let lockedDrugs = [];
    let isTitrationToolCollapsed = false;

    // --- DOM ELEMENTS ---
    const elements = {
        medSection: document.getElementById('medication-section'),
        titrationToolContainer: document.getElementById('titration-tool-container'),
        titrationToolHeader: document.getElementById('titration-tool-header'),
        titrationToolContent: document.getElementById('titration-tool-content'),
        titrationToggleBtn: document.getElementById('titration-toggle-btn'),
        titrationToggleIcon: document.getElementById('titration-toggle-icon'),
        titrationModeToggle: document.getElementById('titration-mode-toggle'),
        titrationTargetDisplay: document.getElementById('titration-target-display'),
        prnTitrationSection: document.getElementById('prn-titration-section'),
        percentTitrationSection: document.getElementById('percent-titration-section'),
        balanceTitrationSection: document.getElementById('balance-titration-section'),
        balanceInstruction: document.getElementById('balance-instruction'),
        breakthroughRowsContainer: document.getElementById('breakthrough-rows-container'),
        addBreakthroughBtn: document.getElementById('add-breakthrough-btn'),
        totalMmeBox: document.getElementById('total-mme-box'),
        totalMmeNormalView: document.getElementById('total-mme-normal-view'),
        totalMmeRotationView: document.getElementById('total-mme-rotation-view'),
        totalMmeDisplay: document.getElementById('total-mme-display'),
        rotationMmeRef: document.getElementById('rotation-mme-ref'),
        rotationAdjustmentDisplay: document.getElementById('rotation-adjustment-display'),
        emptyStateMessage: document.getElementById('empty-state-message'),
        clearAllBtn: document.getElementById('clear-all-btn'),
        rotateBtn: document.getElementById('rotate-btn'),
        cancelRotateBtn: document.getElementById('cancel-rotate-btn'),
        rotationTools: document.getElementById('rotation-tools'),
        basalRecommendation: document.getElementById('basal-recommendation'),
        basalCalcDrug: document.getElementById('basal-calc-drug'),
        basalRecommendationText: document.getElementById('basal-recommendation-text'),
        basalHelperBtn: document.getElementById('basal-helper-btn'),
        breakthroughRecommendation: document.getElementById('breakthrough-recommendation'),
        safetyChecklistBtn: document.getElementById('safety-checklist-btn'),
        safetyModal: document.getElementById('safety-modal'),
        closeSafetyModalBtn: document.getElementById('close-safety-modal-btn'),
        customPercentInput: document.getElementById('custom-percent-input'),
        percentAdjustButtons: document.querySelectorAll('.percent-adjust-btn'),
        breakthroughCalcDrug: document.getElementById('breakthrough-calc-drug'),
        breakthroughCalcPercent: document.getElementById('breakthrough-calc-percent'),
        breakthroughRecommendationText: document.getElementById('breakthrough-recommendation-text'),
        drugInfoModal: document.getElementById('drug-info-modal'),
        closeDrugInfoModalBtn: document.getElementById('close-drug-info-modal-btn'),
        drugInfoTitle: document.getElementById('drug-info-title'),
        drugInfoContent: document.getElementById('drug-info-content'),
        tddHelperModal: document.getElementById('tdd-helper-modal'),
        closeTddHelperModalBtn: document.getElementById('close-tdd-helper-modal-btn'),
        confirmTddHelperBtn: document.getElementById('confirm-tdd-helper-btn'),
        tddHelperDrugName: document.getElementById('tdd-helper-drug-name'),
        tddHelperDrugUnit: document.getElementById('tdd-helper-drug-unit'),
        tddHelperDrugAmount: document.getElementById('tdd-helper-drug-amount'),
        tddHelperFluidVolume: document.getElementById('tdd-helper-fluid-volume'),
        tddHelperRate: document.getElementById('tdd-helper-rate'),
        tddHelperResultDisplay: document.getElementById('tdd-helper-result-display'),
        csciModal: document.getElementById('csci-modal'), closeCsciModalBtn: document.getElementById('close-csci-modal-btn'), cancelCsciModalBtn: document.getElementById('cancel-csci-modal-btn'), csciDrugName: document.getElementById('csci-drug-name'), csciTotalDoseInput: document.getElementById('csci-total-dose-input'), csciDoseUnit: document.getElementById('csci-dose-unit'), csciNewMme: document.getElementById('csci-new-mme'), csciSyringeSize: document.getElementById('csci-syringe-size'), csciTotalVolume: document.getElementById('csci-total-volume'), csciResultWrapper: document.getElementById('csci-result-wrapper'), csciError: document.getElementById('csci-error'), csciErrorText: document.getElementById('csci-error-text'), csciResult: document.getElementById('csci-result'), csciDrugVolume: document.getElementById('csci-drug-volume'), csciDiluentVolume: document.getElementById('csci-diluent-volume'), csciRateMl: document.getElementById('csci-rate-ml'), csciRateMm: document.getElementById('csci-rate-mm'), csciOrderText: document.getElementById('csci-order-text'), csciResetDoseBtn: document.getElementById('csci-reset-dose-btn'),
        ivInfusionModal: document.getElementById('iv-infusion-modal'), closeIvInfusionModalBtn: document.getElementById('close-iv-infusion-modal-btn'), cancelIvModalBtn: document.getElementById('cancel-iv-modal-btn'), ivDrugName: document.getElementById('iv-drug-name'), ivTotalDoseInput: document.getElementById('iv-total-dose-input'), ivDoseUnit: document.getElementById('iv-dose-unit'), ivNewMme: document.getElementById('iv-new-mme'), ivFluidVolume: document.getElementById('iv-fluid-volume'), ivError: document.getElementById('iv-error'), ivErrorText: document.getElementById('iv-error-text'), ivResult: document.getElementById('iv-result'), ivConcentration: document.getElementById('iv-concentration'), ivDoseHr: document.getElementById('iv-dose-hr'), ivOrderText: document.getElementById('iv-order-text'), ivResetDoseBtn: document.getElementById('iv-reset-dose-btn'),
        quickRefModal: document.getElementById('quick-ref-modal'),
        closeQuickRefModalBtn: document.getElementById('close-quick-ref-modal-btn'),
        quickRefTitle: document.getElementById('quick-ref-title'),
        quickRefMmeTotal: document.getElementById('quick-ref-mme-total'),
        quickRefList: document.getElementById('quick-ref-list'),
    };

    function initialize() {
        createMedicationInputs();
        populateDropdowns();
        setupEventListeners();
        loadFromLocalStorage();
    }

    // --- UI CREATION ---
    function createMedicationInputs() {
        elements.medSection.innerHTML = ''; 
        Object.keys(DRUG_CONFIG).forEach(key => {
            const config = DRUG_CONFIG[key];
            if (!config.isBasal) return;
            
            const stepAttribute = config.step ? `step="${config.step}"` : '';
            const tddHelperButton = (key === 'morphine_iv_sc' || key === 'fentanyl_iv_sc') 
                ? `<button class="action-btn tdd-helper-btn !w-10 !h-10 text-cyan-600" data-key="${key}" title="คำนวณ TDD จาก Rate"><i class="fas fa-calculator"></i></button>` 
                : '<span class="w-10 h-10"></span>';

            const inputHtml = `
                <div class="drug-row" data-row-key="${key}">
                    <div class="grid grid-cols-12 gap-x-2 items-center">
                        <!-- Drug Name & MME -->
                        <div class="col-span-12 sm:col-span-6">
                            <button class="drug-name-btn text-left w-full group" data-key="${key}">
                                <span class="font-semibold text-gray-800 text-base drug-name-text">${config.name}</span>
                            </button>
                            <button class="row-mme-ref" data-key="${key}">
                                <span class="font-bold text-cyan-700 text-sm">MME: <span id="mme-${key}">0</span></span>
                                <span id="mg-day-${key}" class="text-xs text-gray-500 ml-2"></span>
                            </button>
                        </div>
                        <!-- Input & Actions -->
                        <div class="col-span-12 sm:col-span-6 mt-2 sm:mt-0">
                            <div class="flex items-center gap-2">
                                <div class="flex-1 relative">
                                    <input type="number" inputmode="decimal" id="dose-${key}" data-key="${key}" class="input-field base-drug-input text-right w-full" placeholder="0" ${stepAttribute}>
                                    <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs pointer-events-none">${config.unit}</span>
                                    <div id="dose-change-${key}" class="text-xs text-red-600 font-medium text-center mt-1"></div>
                                </div>
                                ${tddHelperButton}
                                <button class="action-btn pin-btn !w-10 !h-10" data-key="${key}" title="คลิกเพื่อเลือก, ดับเบิลคลิกเพื่อล็อก">
                                    <i id="pin-icon-${key}" class="fas fa-thumbtack"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
            elements.medSection.insertAdjacentHTML('beforeend', inputHtml);
        });
    }
    
    function addBreakthroughRow(data = {key: '', dose: ''}) {
        prnCount++;
        const newRow = document.createElement('div');
        newRow.className = 'grid grid-cols-12 gap-2 items-center prn-row';
        newRow.innerHTML = `
            <div class="col-span-6"><select class="select-field w-full prn-drug-select" data-id="${prnCount}"></select></div>
            <div class="col-span-5"><input type="number" inputmode="decimal" class="input-field w-full prn-dose-input text-right" placeholder="0" data-id="${prnCount}"></div>
            <div class="col-span-1"><button class="action-btn !w-9 !h-9 text-red-500 remove-prn-btn"><i class="fas fa-trash-alt"></i></button></div>
            <div class="col-span-12 text-center"><span class="text-gray-500 text-xs prn-dose-unit" data-id="${prnCount}"></span></div>
        `;
        const select = newRow.querySelector('.prn-drug-select');
        select.innerHTML = '<option value="">-- เลือกยา --</option>';
        Object.keys(DRUG_CONFIG).forEach(key => {
            if (DRUG_CONFIG[key].isBreakthrough) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = DRUG_CONFIG[key].name;
                select.appendChild(option);
            }
        });
        elements.breakthroughRowsContainer.appendChild(newRow);
        if(data.key) {
            newRow.querySelector('.prn-drug-select').value = data.key;
            newRow.querySelector('.prn-dose-input').value = data.dose;
            const unitEl = newRow.querySelector('.prn-dose-unit');
            unitEl.textContent = DRUG_CONFIG[data.key]?.unit || '';
        }
    }

    function populateDropdowns() {
        elements.breakthroughCalcDrug.innerHTML = '';
        Object.keys(DRUG_CONFIG).forEach(key => {
            if (DRUG_CONFIG[key].isBreakthrough) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = DRUG_CONFIG[key].name;
                elements.breakthroughCalcDrug.appendChild(option);
            }
        });
        elements.basalCalcDrug.innerHTML = '';
        Object.keys(ROTATION_DRUGS).forEach(key => {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = ROTATION_DRUGS[key].name;
            elements.basalCalcDrug.appendChild(option);
        });
    }

    // --- CALCULATION & RENDER LOGIC (Identical to original) ---
    function calculateAndRender() {
        if (isBalancingFromUser) return;
        let totalMME = 0;
        let hasInput = false;

        // Reset UI states
        document.querySelectorAll('.drug-row.pinned-row, .pin-btn.pinned, .drug-row.balance-decrease-row, .drug-row.balance-increase-row, .pin-btn.balance-decrease, .pin-btn.balance-increase, .pin-btn.locked').forEach(el => {
            el.classList.remove('pinned-row', 'pinned', 'balance-decrease-row', 'balance-increase-row', 'balance-decrease', 'balance-increase', 'locked');
        });
        document.querySelectorAll('[id^="dose-change-"]').forEach(el => el.innerHTML = '');
        elements.titrationTargetDisplay.textContent = '';

        // Apply lock states first
        document.querySelectorAll('.base-drug-input').forEach(input => input.disabled = false);
        lockedDrugs.forEach(key => {
            const input = document.getElementById(`dose-${key}`);
            if (input) input.disabled = true;
            const pinBtn = document.querySelector(`.pin-btn[data-key="${key}"]`);
            if(pinBtn) pinBtn.classList.add('locked');
            const pinIcon = document.getElementById(`pin-icon-${key}`);
            if(pinIcon) {
                pinIcon.classList.remove('fa-thumbtack');
                pinIcon.classList.add('fa-lock');
            }
        });
        // Reset non-locked pin icons
        Object.keys(DRUG_CONFIG).forEach(key => {
            if (!lockedDrugs.includes(key)) {
                const pinIcon = document.getElementById(`pin-icon-${key}`);
                if (pinIcon) {
                    pinIcon.classList.remove('fa-lock');
                    pinIcon.classList.add('fa-thumbtack');
                }
            }
        });


        handleUIMode();

        let baseMME = 0;
        document.querySelectorAll('.drug-row').forEach(row => {
            const key = row.dataset.rowKey;
            const input = document.getElementById(`dose-${key}`);
            const config = DRUG_CONFIG[key];
            let individualMme = 0;
            const userDose = parseFloat(input.value);
            if (!isNaN(userDose) && userDose > 0) {
                hasInput = true;
                const doseForCalc = userDose * (config.strength || 1);
                individualMme = doseForCalc * config.factor;
            }
            document.getElementById(`mme-${key}`).textContent = Math.round(individualMme);
            baseMME += individualMme;
            const mgDaySpan = document.getElementById(`mg-day-${key}`);
            if (mgDaySpan) {
                if (config.strength && config.factor !== 1 && !isNaN(userDose) && userDose > 0) {
                    mgDaySpan.textContent = `(${(userDose * config.strength).toFixed(0)} mg)`;
                } else {
                    mgDaySpan.textContent = '';
                }
            }
        });

        let titrationMME = 0;
        if (titrationMode === 'prn' && !isTitrationToolCollapsed) {
            document.querySelectorAll('.prn-row').forEach(row => {
                const key = row.querySelector('.prn-drug-select').value;
                const dose = parseFloat(row.querySelector('.prn-dose-input').value) || 0;
                if (dose > 0 && key && DRUG_CONFIG[key]) {
                    hasInput = true;
                    const config = DRUG_CONFIG[key];
                    const doseForCalc = dose * (config.strength || 1);
                    titrationMME += doseForCalc * config.factor;
                }
            });
        } else if (titrationMode === 'percent' && percentAdjustment !== 0 && rotationMME === null && !isTitrationToolCollapsed) {
            let baseForTitration = 0;
            if (pinnedDrugKey && !lockedDrugs.includes(pinnedDrugKey)) {
                const pinnedInput = document.getElementById(`dose-${pinnedDrugKey}`);
                const pinnedConfig = DRUG_CONFIG[pinnedDrugKey];
                const pinnedDose = parseFloat(pinnedInput.value) || 0;
                baseForTitration = (pinnedDose > 0) ? (pinnedDose * (pinnedConfig.strength || 1)) * pinnedConfig.factor : 0;
            } else if (!pinnedDrugKey) {
                // If no drug is pinned, titrate all non-locked drugs
                document.querySelectorAll('.base-drug-input:not(:disabled)').forEach(input => {
                    const key = input.dataset.key;
                    const config = DRUG_CONFIG[key];
                    const dose = parseFloat(input.value) || 0;
                    if (dose > 0) {
                        baseForTitration += (dose * (config.strength || 1)) * config.factor;
                    }
                });
            }
            titrationMME = baseForTitration * (percentAdjustment / 100);
            updateDoseChangeIndicators(percentAdjustment);
        }
        
        totalMME = baseMME + titrationMME;
        
        if (rotationMME !== null) {
            const adjustedMME = rotationMME * (1 + (percentAdjustment / 100));
            elements.totalMmeNormalView.classList.add('hidden');
            elements.totalMmeRotationView.classList.remove('hidden');
            elements.rotationMmeRef.innerHTML = `From <strong class="text-gray-800">${rotationMME.toFixed(0)} MME</strong>`;
            if (percentAdjustment !== 0) {
                const arrow = percentAdjustment > 0 ? '▲' : '▼';
                const color = percentAdjustment > 0 ? 'text-green-600' : 'text-red-600';
                elements.rotationAdjustmentDisplay.innerHTML = `New Goal: <strong class="text-lg text-cyan-900">${Math.round(adjustedMME)}</strong> MME <span class="text-sm ${color}">(${arrow}${percentAdjustment > 0 ? '+' : ''}${percentAdjustment.toFixed(1)}%)</span>`;
            } else {
                elements.rotationAdjustmentDisplay.innerHTML = `Goal: <strong class="text-lg text-cyan-900">${rotationMME.toFixed(0)}</strong> MME`;
            }
            elements.rotationTools.classList.remove('hidden');
            updateBasalRecommendation(adjustedMME);
            updateBreakthroughRecommendation(adjustedMME);
            document.querySelectorAll('.base-drug-input').forEach(input => input.disabled = true);
            totalMME = adjustedMME;
        } else {
            elements.totalMmeNormalView.classList.remove('hidden');
            elements.totalMmeRotationView.classList.add('hidden');
            elements.rotationTools.classList.add('hidden');
            // Re-apply lock state after potential disable-all from rotation mode
            lockedDrugs.forEach(key => {
                const input = document.getElementById(`dose-${key}`);
                if (input) input.disabled = true;
            });
        }
        
        elements.totalMmeDisplay.textContent = Math.round(totalMME);
        elements.emptyStateMessage.style.display = hasInput || rotationMME !== null ? 'none' : 'block';
        elements.rotateBtn.classList.toggle('hidden', totalMME <= 0 || rotationMME !== null);

        saveToLocalStorage();
    }
    
    function handleUIMode() {
        document.querySelectorAll('.titration-mode-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.mode === titrationMode));
        elements.prnTitrationSection.classList.toggle('hidden', titrationMode !== 'prn');
        elements.percentTitrationSection.classList.toggle('hidden', titrationMode !== 'percent' && titrationMode !== 'balance');
        elements.balanceTitrationSection.classList.toggle('hidden', titrationMode !== 'balance');
        
        if (titrationMode === 'percent') {
            if (pinnedDrugKey) {
                document.querySelector(`.drug-row[data-row-key="${pinnedDrugKey}"]`)?.classList.add('pinned-row');
                document.querySelector(`.pin-btn[data-key="${pinnedDrugKey}"]`)?.classList.add('pinned');
                elements.titrationTargetDisplay.textContent = `Titrating: ${DRUG_CONFIG[pinnedDrugKey].name}`;
            } else {
                elements.titrationTargetDisplay.textContent = 'Titrating All';
            }
        } else if (titrationMode === 'balance') {
            const { decreaseKey, increaseKey } = balancePair;
            if (decreaseKey) {
                document.querySelector(`.drug-row[data-row-key="${decreaseKey}"]`)?.classList.add('balance-decrease-row');
                document.querySelector(`.pin-btn[data-key="${decreaseKey}"]`)?.classList.add('balance-decrease');
            }
            if (increaseKey) {
                document.querySelector(`.drug-row[data-row-key="${increaseKey}"]`)?.classList.add('balance-increase-row');
                document.querySelector(`.pin-btn[data-key="${increaseKey}"]`)?.classList.add('balance-increase');
            }
            if (!decreaseKey) {
                elements.balanceInstruction.innerHTML = `<i class="fas fa-arrow-down text-red-600"></i> คลิก <i class="fas fa-thumbtack"></i> ของ <strong class="text-red-600">ยาที่จะลด</strong>`;
            } else if (!increaseKey) {
                elements.balanceInstruction.innerHTML = `<i class="fas fa-arrow-up text-green-700"></i> คลิก <i class="fas fa-thumbtack"></i> ของ <strong class="text-green-700">ยาที่จะเพิ่ม</strong>`;
            } else {
                elements.balanceInstruction.innerHTML = `<i class="fas fa-check-circle text-blue-600"></i> พร้อมปรับสมดุล!`;
            }
        } else {
            elements.titrationTargetDisplay.textContent = '';
        }
    }
    
    function updateDoseChangeIndicators(percent, balancePairKeys = null) {
        const keysToUpdate = balancePairKeys ? [balancePairKeys.decreaseKey, balancePairKeys.increaseKey] : (pinnedDrugKey ? [pinnedDrugKey] : Object.keys(DRUG_CONFIG).filter(k => DRUG_CONFIG[k].isBasal && !lockedDrugs.includes(k)));
        
        keysToUpdate.forEach(key => {
            const row = document.querySelector(`.drug-row[data-row-key="${key}"]`);
            if (!row) return;

            const input = document.getElementById(`dose-${key}`);
            const originalDose = parseFloat(input.dataset.originalDose || input.value) || 0;
            if (originalDose === 0 && !balancePairKeys) return;

            let newDose;
            if (balancePairKeys) {
                newDose = parseFloat(input.value) || 0;
            } else {
                newDose = originalDose * (1 + percent / 100);
            }

            const indicator = document.getElementById(`dose-change-${key}`);
            const color = newDose > originalDose ? 'text-green-600' : 'text-red-600';
            
            if (Math.abs(newDose - originalDose) > 0.01) {
                indicator.innerHTML = `<span class="${color}">${formatDose(originalDose)} &rarr; ${formatDose(newDose)}</span>`;
            }
        });
    }

    function handlePinClick(key) {
        if (rotationMME !== null || lockedDrugs.includes(key)) return; 

        if (titrationMode === 'percent') {
            pinnedDrugKey = (pinnedDrugKey === key) ? null : key;
        } else if (titrationMode === 'balance') {
            const { decreaseKey, increaseKey } = balancePair;
            if (!decreaseKey && key !== increaseKey) {
                balancePair.decreaseKey = key;
            } else if (key === decreaseKey) {
                balancePair.decreaseKey = null;
            } else if (!increaseKey && key !== decreaseKey) {
                balancePair.increaseKey = key;
            } else if (key === increaseKey) {
                balancePair.increaseKey = null;
            }
        }
        calculateAndRender();
    }

    function handlePinDoubleClick(key) {
        const index = lockedDrugs.indexOf(key);
        if (index > -1) {
            lockedDrugs.splice(index, 1); // Unlock
        } else {
            lockedDrugs.push(key); // Lock
        }
        if (lockedDrugs.includes(balancePair.decreaseKey) || lockedDrugs.includes(balancePair.increaseKey)) {
            balancePair = { decreaseKey: null, increaseKey: null };
        }
        if (lockedDrugs.includes(pinnedDrugKey)) {
            pinnedDrugKey = null;
        }
        calculateAndRender();
    }

    function handlePercentAdjustment(percent, fromUserInput = true) {
        percentAdjustment = percent;
        if(fromUserInput) {
            elements.customPercentInput.value = percent;
        }
        elements.percentAdjustButtons.forEach(b => b.classList.toggle('active', Math.abs(parseInt(b.dataset.percent) - percent) < 1));

        if (fromUserInput && titrationMode === 'balance' && balancePair.decreaseKey && balancePair.increaseKey) {
            performBalance(percent);
        } else {
            calculateAndRender();
        }
    }

    function performBalance(percent) {
        const { decreaseKey, increaseKey } = balancePair;
        if(!decreaseKey || !increaseKey) return;
        const decConfig = DRUG_CONFIG[decreaseKey];
        const incConfig = DRUG_CONFIG[increaseKey];

        const decInput = document.getElementById(`dose-${decreaseKey}`);
        const incInput = document.getElementById(`dose-${increaseKey}`);

        const decOriginalDose = parseFloat(decInput.dataset.originalDose);
        const incOriginalDose = parseFloat(incInput.dataset.originalDose);
        
        const decOriginalMME = (decOriginalDose * (decConfig.strength || 1)) * decConfig.factor;
        
        let mmeToTransfer = decOriginalMME * (percent / 100);
        let newDecMME = decOriginalMME - mmeToTransfer;
        
        const incOriginalMME = (incOriginalDose * (incConfig.strength || 1)) * incConfig.factor;
        let newIncMME = incOriginalMME + mmeToTransfer;

        if (newDecMME < 0) { newIncMME += newDecMME; newDecMME = 0; }
        if (newIncMME < 0) { newDecMME += newIncMME; newIncMME = 0; }

        const newDecDoseRaw = (newDecMME / decConfig.factor) / (decConfig.strength || 1);
        const newIncDoseRaw = (newIncMME / incConfig.factor) / (incConfig.strength || 1);

        const newDecDose = roundToStep(newDecDoseRaw, decConfig.step || 0.1);
        const newIncDose = roundToStep(newIncDoseRaw, incConfig.step || 0.1);

        isBalancingFromUser = true;
        decInput.value = newDecDose > 0 ? formatDose(newDecDose) : '';
        incInput.value = newIncDose > 0 ? formatDose(newIncDose) : '';
        isBalancingFromUser = false;
        
        calculateAndRender();
        updateDoseChangeIndicators(percent, balancePair);
    }

    function performBalanceFromDoseChange(changedKey, newDose) {
        const { decreaseKey, increaseKey } = balancePair;
        if (!decreaseKey || !increaseKey) return;

        isBalancingFromUser = true;

        const decConfig = DRUG_CONFIG[decreaseKey];
        const incConfig = DRUG_CONFIG[increaseKey];
        const decInput = document.getElementById(`dose-${decreaseKey}`);
        const incInput = document.getElementById(`dose-${increaseKey}`);
        const decOriginalDose = parseFloat(decInput.dataset.originalDose);
        const incOriginalDose = parseFloat(incInput.dataset.originalDose);
        const decOriginalMME = (decOriginalDose * (decConfig.strength || 1)) * decConfig.factor;
        const incOriginalMME = (incOriginalDose * (incConfig.strength || 1)) * incConfig.factor;
        const pairTotalMME = decOriginalMME + incOriginalMME;

        let newDecMME, newIncMME;

        if (changedKey === decreaseKey) {
            newDecMME = (newDose * (decConfig.strength || 1)) * decConfig.factor;
            newIncMME = pairTotalMME - newDecMME;
            if (newIncMME < 0) { newDecMME += newIncMME; newIncMME = 0; }
            const newIncDoseRaw = (newIncMME / incConfig.factor) / (incConfig.strength || 1);
            incInput.value = formatDose(roundToStep(newIncDoseRaw, incConfig.step || 0.1));
        } else { // changedKey === increaseKey
            newIncMME = (newDose * (incConfig.strength || 1)) * incConfig.factor;
            newDecMME = pairTotalMME - newIncMME;
            if (newDecMME < 0) { newIncMME += newDecMME; newDecMME = 0; }
            const newDecDoseRaw = (newDecMME / decConfig.factor) / (decConfig.strength || 1);
            decInput.value = formatDose(roundToStep(newDecDoseRaw, decConfig.step || 0.1));
        }
        
        let newPercent = 0;
        if (decOriginalMME > 0) {
            const mmeMoved = decOriginalMME - newDecMME;
            newPercent = (mmeMoved / decOriginalMME) * 100;
        }
        
        elements.customPercentInput.value = newPercent.toFixed(1);
        handlePercentAdjustment(newPercent, false);
        
        isBalancingFromUser = false;
        calculateAndRender();
        updateDoseChangeIndicators(newPercent, balancePair);
    }
    
    function roundToStep(value, step) {
        if (!step || step <= 0 || value <=0) return value;
        return Math.round(value / step) * step;
    }

    function formatDose(dose) {
        if (dose <= 0) return '';
        return parseFloat(dose.toFixed(4));
    }
    
    function setTitrationMode(mode) {
        titrationMode = mode;
        pinnedDrugKey = null;
        if (mode !== 'balance') {
            balancePair = { decreaseKey: null, increaseKey: null };
            document.querySelectorAll('.base-drug-input').forEach(input => {
                if (input.dataset.originalDose) {
                    input.value = input.dataset.originalDose > 0 ? input.dataset.originalDose : '';
                    delete input.dataset.originalDose;
                }
            });
        } else {
            document.querySelectorAll('.base-drug-input:not(:disabled)').forEach(input => {
                input.dataset.originalDose = parseFloat(input.value) || 0;
            });
        }
        handlePercentAdjustment(0);
        calculateAndRender();
    }

    function handleRotateClick() {
        const isEnteringRotation = rotationMME === null;
        rotationMME = isEnteringRotation ? parseFloat(elements.totalMmeDisplay.textContent) : null;
        
        if (isEnteringRotation) {
            setTitrationMode('percent');
        }
        calculateAndRender();
    }

    function generatePrescriptionHtml(totalDose, strengthsConfig) {
        const smallestStrength = Math.min(...strengthsConfig.map(s => s.value));
        if (smallestStrength <= 0) return `<p>${totalDose.toFixed(0)} mg/day</p>`;

        const roundedDose = Math.round(totalDose / smallestStrength) * smallestStrength;
        
        let remainingDose = roundedDose;
        const prescriptionItems = [];

        strengthsConfig.forEach(strengthInfo => {
            const numUnits = Math.floor(remainingDose / strengthInfo.value);
            if (numUnits > 0) {
                prescriptionItems.push({ name: strengthInfo.name, count: numUnits, unit: strengthInfo.unit, strength: strengthInfo.value });
                remainingDose %= strengthInfo.value;
            }
        });

        if (prescriptionItems.length === 0 && roundedDose > 0) {
            return `<p class="text-lg">${roundedDose} mg/day</p><p class="text-xs text-gray-600 mt-1 font-normal">ไม่สามารถจัดยาจาก Formulary ที่มีได้</p>`;
        }
        
        let regimenSuggestion = '';
        const mst30 = prescriptionItems.find(p => p.strength === 30);
        if (mst30 && mst30.count > 0 && roundedDose % 30 === 0 && roundedDose > 0) {
             if (mst30.count === 3) regimenSuggestion = `แนะนำ: <strong>${mst30.name} (1) oral q 8 hr</strong>`;
             else if (mst30.count === 2) regimenSuggestion = `แนะนำ: <strong>${mst30.name} (1) oral q 12 hr</strong>`;
        }

        const listHtml = prescriptionItems.map(item => `<li>${item.name}: ${item.count} ${item.unit}</li>`).join('');

        return `<div class="text-left w-full"><p class="text-lg font-bold text-green-900">${roundedDose} mg/day</p><ul class="list-disc list-inside mt-1 text-xs text-gray-700 space-y-1 pl-2">${listHtml}</ul><p class="text-xs text-gray-600 mt-2">${regimenSuggestion}</p></div>`;
    }


    function updateBasalRecommendation(currentMME) {
        const key = elements.basalCalcDrug.value;
        const config = ROTATION_DRUGS[key];
        elements.basalHelperBtn.classList.toggle('hidden', !config.helper);

        if (!key || !currentMME) {
            elements.basalRecommendationText.innerHTML = ''; return;
        }
        
        const equivalentDose = currentMME / config.factor;
        
        if (rotationDoseInfo.drugKey !== key || Math.abs(rotationDoseInfo.originalDose - equivalentDose) > 0.01) {
             rotationDoseInfo = { drugKey: key, dose: equivalentDose, originalDose: equivalentDose, helperResult: null };
        }
        
        let recommendationText = '';

        if (rotationDoseInfo.helperResult) {
            recommendationText = rotationDoseInfo.helperResult;
        } else if (config.prescriptionHelper) {
            recommendationText = generatePrescriptionHtml(equivalentDose, config.prescriptionHelper.strengths);
        } else if (key === 'fentanyl_patch') {
             const doseMcgHr = roundToStep(equivalentDose, 12.5);
             recommendationText = `<div class="w-full"><p class="text-lg">${doseMcgHr} mcg/hr</p><p class="text-xs text-gray-600 mt-1 font-normal">Fentanyl ${doseMcgHr} mcg/hr patch, change q 72h.</p></div>`;
        } else {
             recommendationText = `<p class="text-lg">${Math.round(equivalentDose)} ${config.unit.split('/')[0]}</p>`;
        }
        elements.basalRecommendationText.innerHTML = recommendationText;
    }
    
    function updateBreakthroughRecommendation(currentMME) {
        const key = elements.breakthroughCalcDrug.value;
        const percent = parseFloat(elements.breakthroughCalcPercent.value);
        if(!key || !percent || !currentMME) {
            elements.breakthroughRecommendationText.innerHTML = ''; return;
        };

        const breakthroughMME = currentMME * percent;
        const config = DRUG_CONFIG[key];
        const doseInMg_raw = breakthroughMME / config.factor;
        let recommendationText = '';

        if (config.strength) {
            const doseInUnit_raw = doseInMg_raw / config.strength;
            const finalDose = roundToStep(doseInUnit_raw, config.step || 1);
            if (finalDose > 0) {
                recommendationText = `<strong>${finalDose} ${config.unit.split('/')[0]}</strong> <span class="text-xs text-gray-500 font-normal">(~${(finalDose * config.strength).toFixed(1)} mg)</span> q 4-6h PRN`;
            } else {
                recommendationText = `<span class="text-xs text-gray-500 font-normal">ขนาดยาน้อยเกินไป</span>`;
            }
        } else { 
            const finalDose = Math.round(doseInMg_raw);
            if (finalDose > 0) {
                recommendationText = `<strong>${finalDose} ${config.unit.split('/')[0]}</strong> q 4-6h PRN`;
            } else {
                recommendationText = `<span class="text-xs text-gray-500 font-normal">ขนาดยาน้อยเกินไป</span>`;
            }
        }
        elements.breakthroughRecommendationText.innerHTML = recommendationText;
    }

    function openDrugInfoModal(key) {
        const config = DRUG_CONFIG[key];
        if (!config || !config.info) return;
        elements.drugInfoTitle.textContent = config.name;
        elements.drugInfoContent.innerHTML = config.info;
        elements.drugInfoModal.classList.add('visible');
    }

    function openTddHelperModal(key) {
        tddHelperTargetKey = key;
        const config = DRUG_CONFIG[key];
        elements.tddHelperDrugName.textContent = config.name;
        elements.tddHelperDrugUnit.textContent = config.unit.split('/')[0];
        elements.tddHelperDrugAmount.value = '';
        elements.tddHelperFluidVolume.value = '';
        elements.tddHelperRate.value = '';
        elements.tddHelperResultDisplay.textContent = '0';
        elements.tddHelperModal.classList.add('visible');
    }

    function calculateTddFromRate() {
        const drugAmount = parseFloat(elements.tddHelperDrugAmount.value);
        const fluidVolume = parseFloat(elements.tddHelperFluidVolume.value);
        const rate = parseFloat(elements.tddHelperRate.value);

        if (isNaN(drugAmount) || isNaN(fluidVolume) || isNaN(rate) || fluidVolume === 0) {
            elements.tddHelperResultDisplay.textContent = '...';
            return;
        }

        const concentration = drugAmount / fluidVolume;
        const tdd = concentration * rate * 24;
        elements.tddHelperResultDisplay.textContent = tdd.toFixed(2);
    }

    function applyTddFromHelper() {
        const resultTDD = parseFloat(elements.tddHelperResultDisplay.textContent);
        if (!isNaN(resultTDD) && tddHelperTargetKey) {
            const targetInput = document.getElementById(`dose-${tddHelperTargetKey}`);
            targetInput.value = resultTDD.toFixed(2);
            elements.tddHelperModal.classList.remove('visible');
            calculateAndRender();
        }
    }

    function calculateCsci() {
        const adjustedDose = parseFloat(elements.csciTotalDoseInput.value) || 0;
        const drugKey = rotationDoseInfo.drugKey;
        if(!drugKey) return;
        const config = ROTATION_DRUGS[drugKey];
        if (!config || config.helper !== 'csci') return;
        const drugInfo = config.drugInfo;
        
        const syringeSize = parseFloat(elements.csciSyringeSize.value);
        const totalVolume = parseFloat(elements.csciTotalVolume.value) || 0;
        const syringeLength = SYRINGE_DATA.BD[syringeSize]?.length;

        const newMME = adjustedDose * config.factor;
        elements.csciNewMme.textContent = adjustedDose > 0 ? `~ ${Math.round(newMME)} MME/day` : '';

        elements.csciResult.classList.add('hidden');
        elements.csciError.classList.add('hidden');

        if (totalVolume <= 0 || !syringeLength || adjustedDose <= 0) {
            rotationDoseInfo.helperResult = null;
            if (rotationMME !== null) updateBasalRecommendation(newMME);
            return;
        }

        const drugVolume = adjustedDose / drugInfo.concentration;

        if (drugVolume > totalVolume || totalVolume > syringeSize) {
            elements.csciErrorText.textContent = `ปริมาตรไม่ถูกต้อง`;
            elements.csciError.classList.remove('hidden'); return;
        }

        const diluentVolume = totalVolume - drugVolume;
        const rateMlPerHour = totalVolume / 24;
        const rateMmPerHour = (totalVolume / syringeSize) * (syringeLength / 24);
        
        elements.csciDrugVolume.innerHTML = `${drugVolume.toFixed(2)} ml`;
        elements.csciDiluentVolume.textContent = `${diluentVolume.toFixed(2)} ml`;
        elements.csciRateMl.textContent = `${rateMlPerHour.toFixed(2)}`;
        elements.csciRateMm.textContent = `${rateMmPerHour.toFixed(2)}`;
        const orderText = `${drugInfo.name} ${adjustedDose.toFixed(0)} ${drugInfo.unit.split('/')[0]} + NSS to ${totalVolume}ml, CSCI @ ${rateMmPerHour.toFixed(2)} mm/hr.`;
        elements.csciOrderText.textContent = orderText;
        rotationDoseInfo.helperResult = `<div class="w-full"><p class="text-lg">${Math.round(adjustedDose)} ${config.unit.split('/')[0]}</p><p class="text-xs text-gray-600 mt-1 font-normal">${orderText}</p></div>`;
        elements.csciResult.classList.remove('hidden');
    }

    function calculateIvInfusion() {
        const adjustedDose = parseFloat(elements.ivTotalDoseInput.value) || 0;
        const drugKey = rotationDoseInfo.drugKey;
         if(!drugKey) return;
        const config = ROTATION_DRUGS[drugKey];
        if (!config || config.helper !== 'iv_infusion') return;
        const drugInfo = config.drugInfo;
        
        const newMME = adjustedDose * config.factor;
        elements.ivNewMme.textContent = adjustedDose > 0 ? `~ ${Math.round(newMME)} MME/day` : '';

        elements.ivResult.classList.add('hidden');
        elements.ivError.classList.add('hidden');

        const fluidVolume = parseFloat(elements.ivFluidVolume.value) || 0;
        if (fluidVolume <= 0 || adjustedDose <= 0) {
             rotationDoseInfo.helperResult = null;
             if (rotationMME !== null) updateBasalRecommendation(newMME);
             return;
        }

        const drugAmountInUnit = adjustedDose;
        const drugVolumeMl = drugAmountInUnit / drugInfo.concentration;
        if (drugVolumeMl > fluidVolume) {
            elements.ivErrorText.textContent = `Drug vol (${drugVolumeMl.toFixed(1)}ml) > fluid vol (${fluidVolume}ml)`;
            elements.ivError.classList.remove('hidden'); return;
        }

        const rateMlPerHour = fluidVolume / 24;
        const finalConcentration = drugAmountInUnit / fluidVolume;
        const dosePerHour = finalConcentration * rateMlPerHour;

        elements.ivConcentration.textContent = `${finalConcentration.toFixed(2)} ${drugInfo.unit}/ml`;
        elements.ivDoseHr.textContent = `${dosePerHour.toFixed(2)} ${drugInfo.unit.split('/')[0]}/hr`;
        const orderText = `${drugInfo.name} ${Math.round(drugAmountInUnit)} ${drugInfo.unit.split('/')[0]} + NSS to ${fluidVolume}mL, IV drip @ ${rateMlPerHour.toFixed(1)} mL/hr`;
        elements.ivOrderText.textContent = orderText;

        elements.ivResult.classList.remove('hidden');
        rotationDoseInfo.helperResult = `<div class="w-full"><p class="text-lg">${Math.round(adjustedDose)} ${config.unit.split('/')[0]}</p><p class="text-xs text-gray-600 mt-1 font-normal">${orderText}</p></div>`;
    }

    function openHelperModal() {
        const key = elements.basalCalcDrug.value;
        const config = ROTATION_DRUGS[key];
        if (!config.helper) return;

        const dose = rotationDoseInfo.dose;
        const drugInfo = config.drugInfo;

        if (config.helper === 'csci') {
            elements.csciDrugName.textContent = drugInfo.name;
            elements.csciDoseUnit.textContent = config.unit.split('/')[0];
            elements.csciTotalDoseInput.value = Math.round(dose);
            elements.csciTotalVolume.value = '';
            elements.csciModal.classList.add('visible');
            calculateCsci();
        } else if (config.helper === 'iv_infusion') {
            elements.ivDrugName.textContent = drugInfo.name;
            elements.ivDoseUnit.textContent = config.unit.split('/')[0];
            elements.ivTotalDoseInput.value = Math.round(dose);
            elements.ivInfusionModal.classList.add('visible');
            calculateIvInfusion();
        }
    }

    function openQuickRefModal(mme, drugKey = null) {
        const quickRefList = elements.quickRefList;
        quickRefList.innerHTML = '';
        
        if (drugKey) {
            elements.quickRefTitle.textContent = `Ref: ${DRUG_CONFIG[drugKey].name}`;
        } else {
            elements.quickRefTitle.textContent = 'Total MME Quick Reference';
        }

        elements.quickRefMmeTotal.textContent = Math.round(mme);
        const refDrugs = ['fentanyl_patch', 'morphine_sr', 'morphine_iv_infusion', 'fentanyl_iv_infusion'];
        refDrugs.forEach(key => {
            const config = ROTATION_DRUGS[key];
            if (config) {
                const equivalentDose = mme / config.factor;
                const doseText = (key === 'fentanyl_patch') 
                    ? roundToStep(equivalentDose, 12.5).toFixed(1) 
                    : Math.round(equivalentDose);
                const rowHtml = `<div class="flex justify-between items-center bg-white p-2 rounded-md border"><span class="font-medium text-gray-700 text-sm">${config.name}</span><span class="font-bold text-green-700">${doseText} ${config.unit}</span></div>`;
                quickRefList.insertAdjacentHTML('beforeend', rowHtml);
            }
        });
        elements.quickRefModal.classList.add('visible');
    }
    
    function closeHelperModal(type) {
        const inputEl = (type === 'csci') ? elements.csciTotalDoseInput : elements.ivTotalDoseInput;
        const finalUserDose = parseFloat(inputEl.value) || 0;
        const drugKey = rotationDoseInfo.drugKey;
        const config = ROTATION_DRUGS[drugKey];
        
        if (config && rotationMME > 0) {
            const finalMME = finalUserDose * config.factor;
            const pctChange = ((finalMME / rotationMME) - 1) * 100;
            handlePercentAdjustment(pctChange);
        }

        if (type === 'csci') {
            calculateCsci(); 
            elements.csciModal.classList.remove('visible');
        } else {
            calculateIvInfusion();
            elements.ivInfusionModal.classList.remove('visible');
        }
        
        calculateAndRender();
    }
    
    function toggleTitrationTool() {
        isTitrationToolCollapsed = !isTitrationToolCollapsed;
        elements.titrationToolContent.classList.toggle('hidden');
        elements.titrationToggleIcon.classList.toggle('rotate-180');
        calculateAndRender();
    }

    function saveToLocalStorage() {
        const baseDoses = {};
        document.querySelectorAll('.base-drug-input').forEach(input => { baseDoses[input.dataset.key] = input.value; });
        const prnDoses = Array.from(document.querySelectorAll('.prn-row')).map(row => ({ key: row.querySelector('.prn-drug-select').value, dose: row.querySelector('.prn-dose-input').value })).filter(d => d.key && d.dose);
        const state = { baseDoses, prnDoses, titrationMode, percentAdjustment, pinnedDrugKey, rotationMME, rotationDoseInfo, balancePair, lockedDrugs, isTitrationToolCollapsed, rotationTools: { basalDrug: elements.basalCalcDrug.value, breakthroughDrug: elements.breakthroughCalcDrug.value, breakthroughPercent: elements.breakthroughCalcPercent.value } };
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(state));
    }

    function loadFromLocalStorage() {
        const savedState = localStorage.getItem(LOCAL_STORAGE_KEY);
        if (!savedState) { addBreakthroughRow(); calculateAndRender(); return; }
        try {
            const state = JSON.parse(savedState);
            Object.keys(state.baseDoses).forEach(key => { if (document.getElementById(`dose-${key}`)) document.getElementById(`dose-${key}`).value = state.baseDoses[key]; });
            elements.breakthroughRowsContainer.innerHTML = '';
            if (state.prnDoses && state.prnDoses.length > 0) { state.prnDoses.forEach(data => addBreakthroughRow(data)); } else { addBreakthroughRow(); }
            rotationMME = state.rotationMME || null;
            lockedDrugs = state.lockedDrugs || [];
            if (state.isTitrationToolCollapsed) {
                toggleTitrationTool();
            }
            setTitrationMode(state.titrationMode || 'prn');
            pinnedDrugKey = state.pinnedDrugKey || null;
            balancePair = state.balancePair || { decreaseKey: null, increaseKey: null };
            rotationDoseInfo = state.rotationDoseInfo || { drugKey: '', dose: 0, helperResult: null, originalDose: 0 };
            if (state.rotationTools) {
                elements.basalCalcDrug.value = state.rotationTools.basalDrug;
                elements.breakthroughCalcDrug.value = state.rotationTools.breakthroughDrug;
                elements.breakthroughCalcPercent.value = state.rotationTools.breakthroughPercent;
            }
            handlePercentAdjustment(state.percentAdjustment || 0);
            calculateAndRender();
        } catch (error) { console.error("Failed to load state:", error); clearAllInputs(); }
    }

    function clearAllInputs() {
        localStorage.removeItem(LOCAL_STORAGE_KEY);
        document.querySelectorAll('input[type="number"]').forEach(i => { i.value = ''; delete i.dataset.originalDose; });
        document.querySelectorAll('select').forEach(s => { if(!s.closest('#rotation-tools')) s.selectedIndex = 0; });
        elements.breakthroughRowsContainer.innerHTML = '';
        addBreakthroughRow();
        rotationMME = null;
        lockedDrugs = [];
        rotationDoseInfo = { drugKey: '', dose: 0, helperResult: null, originalDose: 0 };
        if (isTitrationToolCollapsed) {
            toggleTitrationTool();
        }
        setTitrationMode('prn');
    }

    function setupEventListeners() {
        elements.medSection.addEventListener('input', e => {
            if (e.target.classList.contains('base-drug-input')) {
                const key = e.target.dataset.key;
                if (titrationMode === 'balance' && (key === balancePair.decreaseKey || key === balancePair.increaseKey)) {
                    if (!isBalancingFromUser) {
                        const newDose = parseFloat(e.target.value) || 0;
                        performBalanceFromDoseChange(key, newDose);
                    }
                } else {
                    calculateAndRender();
                }
            }
        });

        elements.medSection.addEventListener('click', e => { 
            const pinButton = e.target.closest('.pin-btn');
            if(pinButton) handlePinClick(pinButton.dataset.key);

            const tddHelperButton = e.target.closest('.tdd-helper-btn');
            if(tddHelperButton) openTddHelperModal(tddHelperButton.dataset.key);

            const drugNameButton = e.target.closest('.drug-name-btn');
            if(drugNameButton) openDrugInfoModal(drugNameButton.dataset.key);

            const rowMmeRef = e.target.closest('.row-mme-ref');
            if(rowMmeRef) {
                const key = rowMmeRef.dataset.key;
                const mme = parseFloat(document.getElementById(`mme-${key}`).textContent) || 0;
                if (mme > 0) {
                    openQuickRefModal(mme, key);
                }
            }
        });

        elements.medSection.addEventListener('dblclick', e => {
            const pinButton = e.target.closest('.pin-btn');
            if(pinButton) handlePinDoubleClick(pinButton.dataset.key);
        });
        
        elements.titrationToolHeader.addEventListener('click', (e) => {
            if (!e.target.closest('.titration-mode-btn') && !e.target.closest('a, button, input, select')) {
                 toggleTitrationTool();
            }
        });

        elements.titrationModeToggle.addEventListener('click', e => { 
            const button = e.target.closest('.titration-mode-btn'); 
            if (button && button.dataset.mode !== titrationMode) {
                setTitrationMode(button.dataset.mode);
            }
        });

        elements.percentAdjustButtons.forEach(button => button.addEventListener('click', () => handlePercentAdjustment(parseInt(button.dataset.percent, 10))));
        elements.customPercentInput.addEventListener('input', e => handlePercentAdjustment(parseFloat(e.target.value) || 0));
        elements.addBreakthroughBtn.addEventListener('click', () => { addBreakthroughRow(); calculateAndRender(); });
        elements.breakthroughRowsContainer.addEventListener('change', e => { if (e.target.classList.contains('prn-drug-select')) { e.target.closest('.prn-row').querySelector('.prn-dose-unit').textContent = (e.target.value && DRUG_CONFIG[e.target.value]) ? DRUG_CONFIG[e.target.value].unit : ''; calculateAndRender(); } });
        elements.breakthroughRowsContainer.addEventListener('input', e => { if (e.target.classList.contains('prn-dose-input')) calculateAndRender(); });
        elements.breakthroughRowsContainer.addEventListener('click', e => { if (e.target.closest('.remove-prn-btn')) { if (elements.breakthroughRowsContainer.children.length > 1) { e.target.closest('.prn-row').remove(); } else { const row = elements.breakthroughRowsContainer.firstElementChild; row.querySelector('select').value = ''; row.querySelector('input').value = ''; row.querySelector('.prn-dose-unit').textContent = ''; } calculateAndRender(); } });
        elements.clearAllBtn.addEventListener('click', clearAllInputs);
        elements.rotateBtn.addEventListener('click', handleRotateClick);
        elements.cancelRotateBtn.addEventListener('click', handleRotateClick);
        const updateRotationTools = () => { if(rotationMME !== null) { calculateAndRender(); }};
        elements.basalCalcDrug.addEventListener('change', updateRotationTools);
        elements.breakthroughCalcDrug.addEventListener('change', updateRotationTools);
        elements.breakthroughCalcPercent.addEventListener('change', updateRotationTools);
        elements.totalMmeDisplay.addEventListener('click', () => { if (rotationMME === null) { const totalMME = parseFloat(elements.totalMmeDisplay.textContent) || 0; if (totalMME > 0) openQuickRefModal(totalMME); } });
        
        elements.safetyChecklistBtn.addEventListener('click', () => elements.safetyModal.classList.add('visible'));
        [elements.closeSafetyModalBtn, elements.safetyModal].forEach(el => el.addEventListener('click', (e) => { if(e.target === el) elements.safetyModal.classList.remove('visible')}));
        elements.quickRefModal.addEventListener('click', (e) => { if (e.target === elements.quickRefModal || e.target.closest('#close-quick-ref-modal-btn')) elements.quickRefModal.classList.remove('visible'); });
        elements.basalHelperBtn.addEventListener('click', openHelperModal);
        
        elements.drugInfoModal.addEventListener('click', (e) => { if (e.target === elements.drugInfoModal || e.target.closest('#close-drug-info-modal-btn')) elements.drugInfoModal.classList.remove('visible'); });

        [elements.tddHelperDrugAmount, elements.tddHelperFluidVolume, elements.tddHelperRate].forEach(el => el.addEventListener('input', calculateTddFromRate));
        elements.confirmTddHelperBtn.addEventListener('click', applyTddFromHelper);
        elements.closeTddHelperModalBtn.addEventListener('click', () => elements.tddHelperModal.classList.remove('visible'));

        elements.csciTotalDoseInput.addEventListener('input', calculateCsci);
        elements.csciTotalVolume.addEventListener('input', calculateCsci);
        elements.csciSyringeSize.addEventListener('change', calculateCsci);
        elements.closeCsciModalBtn.addEventListener('click', () => closeHelperModal('csci'));
        elements.cancelCsciModalBtn.addEventListener('click', () => elements.csciModal.classList.remove('visible'));
        elements.csciResetDoseBtn.addEventListener('click', () => { elements.csciTotalDoseInput.value = Math.round(rotationDoseInfo.originalDose); calculateCsci(); });
        elements.ivTotalDoseInput.addEventListener('input', calculateIvInfusion);
        elements.ivFluidVolume.addEventListener('input', calculateIvInfusion);
        elements.closeIvInfusionModalBtn.addEventListener('click', () => closeHelperModal('iv_infusion'));
        elements.cancelIvModalBtn.addEventListener('click', () => elements.ivInfusionModal.classList.remove('visible'));
        elements.ivResetDoseBtn.addEventListener('click', () => { elements.ivTotalDoseInput.value = Math.round(rotationDoseInfo.originalDose); calculateIvInfusion(); });
    }

    initialize();
});
</script>

</body>
</html>
