<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opioid Calculator (Refactored)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- Base Styles --- */
        body { 
            font-family: 'Sarabun', sans-serif; 
            transition: background-color 0.3s;
        }
        .expandable-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, margin-top 0.5s ease-in-out;
        }
        .expandable-content.expanded {
            max-height: 500px; /* Adjust as needed */
        }
        .rotation-basal-row.locked {
             background-color: #f0f9ff; /* sky-50 for Material theme */
             border-color: #bae6fd; /* sky-200 for Material theme */
        }
        .theme-neumorphic .rotation-basal-row.locked {
            box-shadow: inset 3px 3px 6px #d1d9e6, inset -3px -3px 6px #ffffff;
        }

        /* --- Updated Pin Button Styles --- */
        .pin-btn.pinned {
            color: #c026d3; /* fuchsia-700 */
            background-color: #faf5ff; /* fuchsia-50 */
            box-shadow: 0 0 8px 2px rgba(192, 38, 211, 0.3);
            transform: scale(1.1);
        }
        .pin-btn.balance-decrease {
            color: #dc2626; /* red-600 */
            background-color: #fef2f2; /* red-50 */
            box-shadow: 0 0 8px 2px rgba(220, 38, 38, 0.3);
            transform: scale(1.1);
        }
        .pin-btn.balance-increase {
            color: #16a34a; /* green-600 */
            background-color: #f0fdf4; /* green-50 */
            box-shadow: 0 0 8px 2px rgba(22, 163, 74, 0.3);
            transform: scale(1.1);
        }
        .theme-neumorphic .pin-btn.pinned { 
            color: #c026d3;
            box-shadow: inset 3px 3px 6px #f5d0fe, inset -3px -3px 6px #ffffff, 0 0 8px 2px rgba(192, 38, 211, 0.3);
        }
        .theme-neumorphic .pin-btn.balance-decrease {
            box-shadow: inset 3px 3px 6px #fecdd3, inset -3px -3px 6px #ffffff, 0 0 8px 2px rgba(220, 38, 38, 0.3);
        }
        .theme-neumorphic .pin-btn.balance-increase {
            box-shadow: inset 3px 3px 6px #dcfce7, inset -3px -3px 6px #ffffff, 0 0 8px 2px rgba(22, 163, 74, 0.3);
        }


        /* --- Material Design Theme (Default) --- */
        .theme-material {
            --bg-color: #f7f8fa;
            --card-bg-color: #ffffff;
            --primary-color: #0284c7; /* sky-600 */
            --primary-color-dark: #0369a1; /* sky-700 */
            --primary-text: #075985; /* sky-800 */
            --text-color: #374151; /* gray-700 */
            --text-light: #6b7280; /* gray-500 */
            --border-color: #e5e7eb; /* gray-200 */
            --card-radius: 0.75rem;
            --input-radius: 0.5rem;
            --card-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --modal-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --modal-bg: rgba(17, 24, 39, 0.6);
            --modal-backdrop-blur: blur(4px);
        }
        .theme-material .card {
            background: var(--card-bg-color);
            border-radius: var(--card-radius);
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-color);
        }
        .theme-material .input-field, .theme-material .select-field {
            border: 1px solid var(--border-color);
            border-radius: var(--input-radius);
            background-color: #f9fafb;
        }
        .theme-material .input-field:focus, .theme-material .select-field:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(2, 132, 199, 0.2);
            background-color: var(--card-bg-color);
        }
        .theme-material .btn { border: 1px solid transparent; }
        .theme-material .btn-primary { background-color: var(--primary-color); color: white; }
        .theme-material .btn-primary:hover { background-color: var(--primary-color-dark); }
        .theme-material .btn-secondary { border-color: var(--border-color); color: var(--text-color); }
        .theme-material .btn-secondary:hover { background-color: #f0f9ff; border-color: #bae6fd; }
        .theme-material .btn-icon:hover { background-color: #f3f4f6; }
        .theme-material .stepper-btn { background-color: #f3f4f6; color: var(--text-color); }
        .theme-material .stepper-btn:hover { background-color: #e5e7eb; }

        /* --- Neumorphic Theme --- */
        .theme-neumorphic {
            --bg-color: #eef0f4;
            --card-bg-color: #eef0f4;
            --primary-color: #0891b2;
            --primary-color-dark: #0e7490;
            --primary-text: #0e7490;
            --text-color: #4b5563;
            --text-light: #6b7280;
            --border-color: transparent;
            --dark-shadow: #d1d9e6;
            --light-shadow: #ffffff;
            --card-radius: 1.25rem;
            --input-radius: 0.75rem;
            --card-shadow: 8px 8px 16px var(--dark-shadow), -8px -8px 16px var(--light-shadow);
            --modal-shadow: 12px 12px 24px rgba(0,0,0,0.2), -12px -12px 24px rgba(255,255,255,0.7);
            --modal-bg: rgba(0, 0, 0, 0.4);
            --modal-backdrop-blur: blur(8px);
        }
        .theme-neumorphic .card {
            background: var(--card-bg-color);
            border-radius: var(--card-radius);
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-color);
        }
        .theme-neumorphic .input-field, .theme-neumorphic .select-field {
            border: none;
            border-radius: var(--input-radius);
            background: var(--bg-color);
            box-shadow: inset 5px 5px 10px var(--dark-shadow), inset -5px -5px 10px var(--light-shadow);
        }
        .theme-neumorphic .input-field:focus, .theme-neumorphic .select-field:focus {
            box-shadow: inset 2px 2px 4px var(--dark-shadow), inset -2px -2px 4px var(--light-shadow), 0 0 0 2px var(--primary-color);
        }
        .theme-neumorphic .btn {
            background: var(--bg-color);
            box-shadow: 4px 4px 8px var(--dark-shadow), -4px -4px 8px var(--light-shadow);
            border: 1px solid rgba(255,255,255,0.5);
        }
        .theme-neumorphic .btn:active {
            box-shadow: inset 3px 3px 6px var(--dark-shadow), inset -3px -3px 6px var(--light-shadow);
        }
        .theme-neumorphic .btn-primary { background-color: var(--primary-color); color:white; }
        .theme-neumorphic .btn-primary:hover { background-color: var(--primary-color-dark); }
        .theme-neumorphic .stepper-btn {
             box-shadow: 3px 3px 6px var(--dark-shadow), -3px -3px 6px var(--light-shadow);
        }
        .theme-neumorphic .stepper-btn:active {
            box-shadow: inset 2px 2px 4px var(--dark-shadow), inset -2px -2px 4px var(--light-shadow);
        }


        /* --- Common Styles (apply to both themes) --- */
        body { background-color: var(--bg-color); color: var(--text-color); }
        .input-field, .select-field {
            width: 100%; padding: 0.6rem 0.75rem; transition: all 0.2s ease-in-out; font-size: 16px;
        }
        @media (min-width: 640px) { .input-field, .select-field { font-size: 0.875rem; } }
        .select-field { 
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center; background-repeat: no-repeat;
            background-size: 1.25em 1.25em; padding-right: 2.5rem;
        }
        .input-field::placeholder { color: #9ca3af; }
        .input-field:disabled { background-color: #f3f4f6; color: var(--text-light); cursor: not-allowed; }
        .btn { display: inline-flex; align-items: center; justify-content: center; font-weight: 600; padding: 0.5rem 1rem; border-radius: var(--input-radius); transition: all 0.2s ease-in-out; cursor: pointer; }
        .btn-icon { width: 2.5rem; height: 2.5rem; padding: 0; border-radius: 9999px; color: var(--text-light); transition: all 0.2s ease-in-out; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--modal-bg); backdrop-filter: var(--modal-backdrop-blur); display: flex; align-items: center; justify-content: center; z-index: 50; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { position: relative; background-color: var(--card-bg-color); padding: 1.5rem; border-radius: var(--card-radius); width: 90%; max-width: 500px; transform: scale(0.95); transition: transform 0.3s; box-shadow: var(--modal-shadow); }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-close-btn { position: absolute; top: 0.5rem; right: 0.5rem; }
        .utility-btn-group { display: inline-flex; border: 1px solid #e5e7eb; border-radius: var(--input-radius); overflow: hidden; background-color: #f3f4f6; }
        .utility-btn { background-color: transparent; color: var(--text-light); font-weight: 600; padding: 0.35rem 0.75rem; border-right: 1px solid #e5e7eb; transition: all 0.2s; font-size: 0.8rem; }
        .utility-btn:last-child { border-right: none; }
        .utility-btn:hover { background-color: #e5e7eb; }
        .utility-btn.active { background-color: var(--card-bg-color); color: var(--primary-text); box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); }
        .input-stepper { display: flex; align-items: center; }
        .input-stepper .input-field { border-radius: 0; text-align: center; -moz-appearance: textfield; }
        .input-stepper .input-field::-webkit-outer-spin-button, .input-stepper .input-field::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .stepper-btn { width: 2.5rem; height: 2.5rem; border-radius: 0; font-size: 1.2rem; line-height: 1; }
        .stepper-btn.minus { border-top-left-radius: var(--input-radius); border-bottom-left-radius: var(--input-radius); }
        .stepper-btn.plus { border-top-right-radius: var(--input-radius); border-bottom-right-radius: var(--input-radius); }
    </style>
</head>
<body class="p-3 sm:p-4 md:p-6">

    <div class="max-w-4xl mx-auto">
        <header class="flex justify-between items-center gap-4 mb-6">
            <div>
                <h1 class="text-xl sm:text-2xl font-bold text-gray-800">Opioid Equianalgesic Calculator</h1>
                <p class="text-sm text-gray-500">เครื่องมือคำนวณและหมุนเวียนยาสำหรับบุคลากรทางการแพทย์</p>
            </div>
            <div class="flex items-center gap-2">
                <button id="theme-toggle-btn" class="btn btn-icon" title="สลับ Theme">
                    <i class="fas fa-paint-brush"></i>
                </button>
                <button id="safety-checklist-btn" class="btn btn-icon" title="Clinical Pearls">
                    <i class="fas fa-check-circle text-yellow-500"></i>
                </button>
                <button id="clear-all-btn" class="btn btn-icon" title="ล้างข้อมูลทั้งหมด">
                    <i class="fas fa-trash text-red-500"></i>
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <div class="lg:col-span-2 space-y-6">
                
                <div class="card p-4 sm:p-6">
                    <h2 class="text-lg font-semibold text-gray-700 mb-4 border-b pb-3">ยา Opioids ที่ใช้อยู่ (Current Regimen)</h2>
                    <div id="medication-section" class="divide-y divide-gray-200"></div>
                </div>

                <div id="titration-tool-container" class="card p-4 sm:p-6">
                     <div id="titration-tool-header" class="flex justify-between items-center cursor-pointer mb-4">
                        <div class="flex items-center gap-3 flex-1 min-w-0">
                            <h2 class="text-lg font-semibold text-gray-700">เครื่องมือปรับยา (Dose Adjustment)</h2>
                            <span id="titration-target-display" class="text-xs font-semibold text-sky-700 truncate bg-sky-100 px-2 py-1 rounded-full"></span>
                        </div>
                        <button id="titration-toggle-btn" class="btn btn-icon -mr-2">
                            <i id="titration-toggle-icon" class="fas fa-chevron-down transition-transform"></i>
                        </button>
                     </div>
                     <div id="titration-tool-content" class="space-y-4 transition-all duration-300">
                        <div class="flex justify-center">
                            <div id="titration-mode-toggle" class="utility-btn-group">
                                 <button class="utility-btn" data-mode="prn">PRN</button>
                                 <button class="utility-btn" data-mode="percent">%</button>
                                 <button class="utility-btn" data-mode="balance">Balance</button>
                            </div>
                        </div>
                        <div id="prn-titration-section" class="space-y-3">
                            <label class="text-sm font-medium text-gray-600">ยา Breakthrough (PRN) ที่ใช้ใน 24 ชม.</label>
                            <div id="breakthrough-rows-container" class="space-y-2"></div>
                            <button id="add-breakthrough-btn" class="btn btn-secondary w-full text-sm">
                                <i class="fas fa-plus mr-2"></i>
                                <span>เพิ่มรายการยา PRN</span>
                            </button>
                        </div>
                        <div id="percent-titration-section" class="hidden">
                            <div class="flex items-center justify-center gap-2 flex-wrap bg-gray-50 p-3 rounded-lg">
                                <button class="btn btn-secondary text-red-600 percent-adjust-btn decrease" data-percent="-50">-50%</button>
                                <button class="btn btn-secondary text-red-600 percent-adjust-btn decrease" data-percent="-25">-25%</button>
                                <button class="btn btn-secondary percent-adjust-btn" data-percent="0">0%</button>
                                <button class="btn btn-secondary text-green-600 percent-adjust-btn increase" data-percent="30">+30%</button>
                                <button class="btn btn-secondary text-green-600 percent-adjust-btn increase" data-percent="50">+50%</button>
                                <input type="number" inputmode="decimal" id="custom-percent-input" class="input-field w-24 text-center" placeholder="... %">
                            </div>
                        </div>
                        <div id="balance-titration-section" class="hidden text-center p-3 bg-orange-50 rounded-lg border border-orange-200">
                            <div id="balance-instruction" class="text-sm text-orange-800 font-medium"></div>
                        </div>
                     </div>
                </div>

            </div>

            <div class="lg:col-span-1 space-y-6">
                <div id="total-mme-box" class="card text-center p-4 sm:p-6 sticky top-6">
                    <div id="total-mme-normal-view">
                        <h2 class="text-base font-semibold text-sky-800">Total Morphine Milligram Equivalents</h2>
                        <p id="total-mme-display" class="text-6xl font-bold text-sky-900 my-2 tracking-tight cursor-pointer" title="คลิกเพื่อดู Quick Reference">0</p>
                        <p class="text-sm text-gray-500">MME / day</p>
                        <p id="empty-state-message" class="text-gray-500 text-sm mt-4">กรอกขนาดยาเพื่อเริ่มคำนวณ</p>
                        <button id="rotate-btn" class="btn btn-primary w-full mt-4 hidden">
                            <i class="fas fa-sync-alt mr-2"></i>
                            เริ่มการหมุนเวียนยา (Opioid Rotation)
                        </button>
                    </div>
                    <div id="total-mme-rotation-view" class="hidden">
                         <div class="flex justify-between items-center mb-2">
                             <h2 class="text-lg font-semibold text-red-800">Opioid Rotation</h2>
                             <button id="cancel-rotate-btn" class="btn btn-icon" title="ยกเลิกการหมุนเวียนยา">
                                <i class="fas fa-times text-red-700"></i>
                            </button>
                        </div>
                        <div id="rotation-goal-display" class="text-gray-600 text-base bg-gray-50 p-3 rounded-lg"></div>
                    </div>
                </div>

                <div id="rotation-tools" class="hidden card p-4 sm:p-6">
                    <h3 class="font-semibold text-green-800 text-lg border-b pb-3 mb-4">เครื่องมือหมุนเวียนยา (Rotation Tool)</h3>
                    <div class="space-y-4">
                        <div id="basal-recommendation" class="bg-gray-50 p-3 rounded-lg border">
                            <div class="flex justify-between items-center flex-wrap gap-2 mb-2">
                                 <label class="font-semibold text-gray-700 text-sm">ยา Basal ใหม่</label>
                                 <span id="rotation-total-percent" class="text-xs font-bold"></span>
                            </div>
                            <div id="rotation-basal-rows-container" class="space-y-3"></div>
                            <button id="add-rotation-basal-btn" class="btn btn-secondary w-full text-sm mt-3">
                                <i class="fas fa-plus mr-2"></i>
                                <span>เพิ่มยา Basal</span>
                            </button>
                            <button id="recalculate-mme-btn" class="btn btn-primary w-full text-sm mt-2 hidden" data-state="confirm">
                                <i class="fas fa-calculator mr-2"></i>
                                <span>ยืนยันและคำนวณ MME สุดท้าย</span>
                            </button>
                        </div>
                        <div id="breakthrough-recommendation" class="bg-gray-50 p-3 rounded-lg border">
                            <div class="flex justify-between items-center flex-wrap gap-2 mb-2">
                                 <label class="font-semibold text-gray-700 text-sm">ยา Breakthrough ใหม่</label>
                                 <div class="flex items-center gap-2">
                                    <select id="breakthrough-calc-drug" class="select-field !text-xs !p-1.5 !rounded-md w-36 sm:w-40"></select>
                                    <select id="breakthrough-calc-percent" class="select-field !text-xs !p-1.5 !rounded-md w-24">
                                        <option value="0.1667">1/6 TDD</option>
                                        <option value="0.15">15% TDD</option>
                                        <option value="0.1">10% TDD</option>
                                    </select>
                                 </div>
                            </div>
                            <p id="breakthrough-recommendation-text" class="text-base sm:text-lg text-green-800 font-bold mt-2 p-2 bg-green-100 rounded-md text-center"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <footer class="text-center mt-8 text-xs text-gray-400">
            <p>Developed with <i class="fas fa-heart text-red-400"></i> by Gang FM</p>
        </footer>
    </div>

    <div id="guided-reduction-modal" class="modal-overlay">
        <div class="modal-content space-y-4">
             <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2"><i class="fas fa-shield-alt text-blue-500"></i> เพื่อความปลอดภัยในการหมุนเวียนยา</h3>
             <div class="bg-gray-50 p-3 rounded-lg text-center">
                <p class="text-sm font-medium text-gray-500">MME ปัจจุบันของคุณคือ</p>
                <p id="reduction-source-mme" class="text-2xl font-bold text-sky-700"></p>
            </div>
             <p class="text-sm text-gray-700">ตามหลักปฏิบัติ แนะนำให้ลดขนาดยาลง 25-50% เพื่อป้องกันผลข้างเคียง (Incomplete cross-tolerance) หรือคงขนาดยาเดิม (ลด 0%) หากต้องการ</p>
             <div class="space-y-2">
                <button class="btn btn-secondary w-full reduction-choice-btn" data-percent="0">คงขนาดยาเดิม (ลด 0%)</button>
                <button class="btn btn-secondary w-full reduction-choice-btn" data-percent="25">ลด 25% (แนะนำโดยทั่วไป)</button>
                <button class="btn btn-secondary w-full reduction-choice-btn" data-percent="50">ลด 50%</button>
             </div>
             <div class="flex items-center gap-2">
                <label for="reduction-custom-percent" class="text-sm font-medium">กำหนดเอง:</label>
                <input type="number" id="reduction-custom-percent" class="input-field w-24 text-center" placeholder="%">
             </div>
             <div class="flex justify-end gap-3 mt-4">
                <button id="cancel-reduction-btn" class="btn btn-secondary">ยกเลิก</button>
                <button id="confirm-reduction-btn" class="btn btn-primary">ยืนยันเป้าหมาย MME</button>
             </div>
        </div>
    </div>
    
    <div id="drug-info-modal" class="modal-overlay">
        <div class="modal-content space-y-3">
            <button class="btn btn-icon modal-close-btn" data-modal-id="drug-info-modal">&times;</button>
            <h3 id="drug-info-title" class="text-xl font-bold text-gray-800"></h3>
            <div id="drug-info-content" class="text-sm text-gray-700 space-y-2"></div>
        </div>
    </div>
    <div id="tdd-helper-modal" class="modal-overlay">
        <div class="modal-content space-y-4">
            <button class="btn btn-icon modal-close-btn" data-modal-id="tdd-helper-modal">&times;</button>
            <h3 class="text-lg font-bold text-gray-800">คำนวณ TDD จาก IV Rate</h3>
            <div class="bg-gray-50 p-3 rounded-lg">
                <p class="text-sm font-medium text-gray-500">ยาที่คำนวณ</p>
                <p id="tdd-helper-drug-name" class="text-lg font-bold text-sky-700"></p>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div>
                    <label for="tdd-helper-drug-amount" class="block text-sm font-medium text-gray-700">Drug (<span id="tdd-helper-drug-unit">mg</span>)</label>
                    <input type="number" inputmode="decimal" id="tdd-helper-drug-amount" class="input-field mt-1 text-right" placeholder="100">
                </div>
                <div>
                    <label for="tdd-helper-fluid-volume" class="block text-sm font-medium text-gray-700">Volume (mL)</label>
                    <input type="number" inputmode="decimal" id="tdd-helper-fluid-volume" class="input-field mt-1 text-right" placeholder="100">
                </div>
                <div>
                    <label for="tdd-helper-rate" class="block text-sm font-medium text-gray-700">Rate (mL/hr)</label>
                    <input type="number" inputmode="decimal" id="tdd-helper-rate" class="input-field mt-1 text-right" placeholder="2">
                </div>
            </div>
            <div class="bg-blue-50 p-3 rounded-lg text-center border border-blue-200">
                <p class="text-sm font-medium text-gray-500">Calculated TDD</p>
                <p id="tdd-helper-result-display" class="text-2xl font-bold text-blue-800">0</p>
            </div>
            <button id="confirm-tdd-helper-btn" class="btn btn-primary w-full">ยืนยัน</button>
        </div>
    </div>
    <div id="safety-modal" class="modal-overlay">
        <div class="modal-content space-y-4">
            <button class="btn btn-icon modal-close-btn" data-modal-id="safety-modal">&times;</button>
            <h3 class="text-lg font-bold text-yellow-800 flex items-center gap-2"><i class="fas fa-check-circle"></i> Clinical Pearls</h3>
            <div class="space-y-4">
                <div>
                    <h4 class="font-semibold text-gray-800">ข้อควรพิจารณาหลัก</h4>
                    <ul class="list-disc list-inside space-y-2 text-gray-700 text-sm mt-1">
                        <li><strong>การประเมินผู้ป่วย:</strong> อายุ, การทำงานของไตและตับ, ภาวะสับสน (Delirium), ประวัติการใช้ Opioids.</li>
                        <li><strong>ยาที่ใช้ร่วมกัน:</strong> โดยเฉพาะกลุ่ม Benzodiazepines หรือ Gabapentinoids.</li>
                        <li><strong>Incomplete Cross-Tolerance:</strong> พิจารณาลดยา 25-50% เมื่อทำการหมุนเวียนยา.</li>
                        <li><strong>เป้าหมายการรักษา:</strong> ตั้งเป้าหมาย (Goal of Care) ร่วมกับผู้ป่วยและครอบครัวเสมอ.</li>
                    </ul>
                </div>
                <div class="border-t pt-3">
                    <h4 class="font-semibold text-gray-800">รายการยา Opioids ในโรงพยาบาล</h4>
                    <ul class="list-disc list-inside space-y-1 text-gray-700 text-sm mt-1">
                        <li>Morphine Syrup 2 mg/mL</li>
                        <li>Morphine IR 10 mg (tablet)</li>
                        <li>MST 10 mg, 30 mg (tablet)</li>
                        <li>Kapanol 20 mg (capsule)</li>
                        <li>Morphine Injection 10mg/mL</li>
                        <li>Fentanyl Patch 25 mcg/hr</li>
                        <li>Fentanyl Injection 100 mcg/2mL</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div id="quick-ref-modal" class="modal-overlay">
        <div class="modal-content space-y-4">
            <button class="btn btn-icon modal-close-btn" data-modal-id="quick-ref-modal">&times;</button>
            <h3 id="quick-ref-title" class="text-lg font-bold text-gray-800">Quick Reference</h3>
            <div class="bg-gray-50 p-3 rounded-lg text-center">
                <p class="text-sm font-medium text-gray-500">MME/day</p>
                <p id="quick-ref-mme-total" class="text-2xl font-bold text-sky-700"></p>
            </div>
            <div id="quick-ref-list" class="space-y-2"></div>
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- CONFIGURATION ---
    const DRUG_CONFIG = {
        'fentanyl_patch': { 
            name: 'Fentanyl Patch', 
            factor: 2.4, unit: 'mcg/hr', type: 'patch', isBasal: true, step: 12.5,
            info: `<p><strong>Onset:</strong> 12-24 ชั่วโมง, ออกฤทธิ์เต็มที่ 72 ชั่วโมง</p><p><strong>ข้อควรระวัง:</strong></p><ul class="list-disc list-inside pl-4"><li>ไม่เหมาะสำหรับแก้ปวดเฉียบพลัน (Acute Pain) หรือในผู้ป่วยที่ยังปรับยาไม่คงที่</li><li>ไข้สูง (Fever > 40°C) อาจเพิ่มการดูดซึมยาได้ถึง 1/3</li><li>แนะนำให้ทิ้งแผ่นแปะที่ใช้แล้วอย่างถูกวิธี (พับด้านกาวเข้าหากัน)</li><li>เป็นตัวเลือกที่ดีในผู้ป่วยไตวายรุนแรง (Severe Renal Impairment)</li></ul>`
        },
        'mst_10': { 
            name: 'MST 10mg', 
            factor: 1, unit: 'เม็ด/day', type: 'oral', isBasal: true, strength: 10, step: 1,
            info: `<p><strong>Onset:</strong> ~1 ชั่วโมง, ออกฤทธิ์นาน 8-12 ชั่วโมง</p><p><strong>ข้อควรระวัง:</strong></p><ul class="list-disc list-inside pl-4"><li>ห้ามหัก แบ่ง หรือเคี้ยวยาเม็ด</li><li>ควรระวังการใช้ในผู้ป่วยไตวาย (eGFR < 30 ml/min) เนื่องจาก Metabolites (M3G, M6G) อาจสะสมและเกิดพิษได้</li></ul>`
        },
        'mst_30': { 
            name: 'MST 30mg', 
            factor: 1, unit: 'เม็ด/day', type: 'oral', isBasal: true, strength: 30, step: 1,
            info: `<p><strong>Onset:</strong> ~1 ชั่วโมง, ออกฤทธิ์นาน 8-12 ชั่วโมง</p><p><strong>ข้อควรระวัง:</strong></p><ul class="list-disc list-inside pl-4"><li>ห้ามหัก แบ่ง หรือเคี้ยวยาเม็ด</li><li>ควรระวังการใช้ในผู้ป่วยไตวาย (eGFR < 30 ml/min) เนื่องจาก Metabolites (M3G, M6G) อาจสะสมและเกิดพิษได้</li></ul>`
        },
        'kapanol_20': { 
            name: 'Kapanol 20mg', 
            factor: 1, unit: 'แคปซูล/day', type: 'oral', isBasal: true, strength: 20, step: 1,
            info: `<p><strong>Onset:</strong> ~1 ชั่วโมง, ออกฤทธิ์นาน 12-24 ชั่วโมง</p><p><strong>ข้อควรระวัง:</strong></p><ul class="list-disc list-inside pl-4"><li>ห้ามเคี้ยวเม็ด Granules ข้างใน แต่สามารถเปิดแคปซูลแล้วโรยบนอาหารเหลวได้ (สำหรับผู้ป่วยมีปัญหาการกลืน)</li><li>ควรระวังการใช้ในผู้ป่วยไตวาย (eGFR < 30 ml/min) เช่นเดียวกับ MST</li></ul>`
        },
        'morphine_iv_sc': { 
            name: 'Morphine IV/SC', 
            factor: 3, unit: 'mg/day', type: 'injectable', isBasal: true, isBreakthrough: true,
            info: `<p><strong>Onset:</strong> IV ~5 นาที, SC ~15-30 นาที</p><p><strong>ข้อควรระวัง:</strong></p><ul class="list-disc list-inside pl-4"><li>ใช้สำหรับผู้ป่วยที่มีอาการปวดรุนแรง หรือไม่สามารถรับประทานยาได้</li><li>ต้องปรับลดขนาดยาในผู้ป่วยไตวาย (eGFR < 30 ml/min) และติดตามอาการข้างเคียงอย่างใกล้ชิด</li></ul>`
        },
        'fentanyl_iv_sc': { 
            name: 'Fentanyl IV/SC', 
            factor: 0.3, unit: 'mcg/day', type: 'injectable', isBasal: true, isBreakthrough: true,
            info: `<p><strong>Onset:</strong> IV ~1-2 นาที, ออกฤทธิ์สั้น (30-60 นาที)</p><p><strong>ข้อดี:</strong></p><ul class="list-disc list-inside pl-4"><li>เป็นตัวเลือกที่ปลอดภัยในผู้ป่วยไตวายรุนแรง (Severe Renal Impairment)</li><li>เหมาะสำหรับ Titrate อาการปวดที่รุนแรงและต้องการการตอบสนองที่รวดเร็ว (ให้ยา PRN q 1-2h)</li></ul>`
        },
        'morphine_ir_tab_10': { 
            name: 'Morphine IR 10mg', 
            factor: 1, unit: 'เม็ด/day', type: 'oral', isBreakthrough: true, strength: 10, step: 1,
            info: `<p><strong>Onset:</strong> 30-60 นาที, ออกฤทธิ์นาน 2-4 ชั่วโมง</p><p><strong>การใช้งาน:</strong></p><ul class="list-disc list-inside pl-4"><li>ใช้สำหรับบรรเทาอาการปวดกำเริบ (Breakthrough Pain) โดยให้ยาทุก 2-4 ชั่วโมง</li><li>ขนาดยาที่ใช้ปกติคิดเป็น 10-15% ของขนาดยาหลักต่อวัน (Total Daily Dose)</li></ul>`
        },
        'morphine_syrup': { 
            name: 'Morphine Syrup 2mg/ml', 
            factor: 1, unit: 'mL/day', type: 'oral', isBreakthrough: true, strength: 2,
            info: `<p><strong>Onset:</strong> 30-60 นาที, ออกฤทธิ์นาน 2-4 ชั่วโมง</p><p><strong>การใช้งาน:</strong></p><ul class="list-disc list-inside pl-4"><li>ใช้สำหรับบรรเทาอาการปวดกำเริบ (Breakthrough Pain) โดยให้ยาทุก 2-4 ชั่วโมง โดยเฉพาะในผู้ป่วยที่มีปัญหาการกลืน</li><li>ง่ายต่อการปรับขนาดยา (Titration) ทีละน้อย</li></ul>`
        },
    };

    const ROTATION_DRUGS = {
        'fentanyl_patch': { name: 'Fentanyl Patch', factor: 2.4, unit: 'mcg/hr', allowedDoses: [12.5, 25, 50, 75, 100] },
        'morphine_sr': { 
            name: 'Morphine SR', factor: 1, unit: 'mg/day',
            prescriptionHelper: {
                strengths: [
                    { name: 'MST 30mg', value: 30, unit: 'เม็ด' },
                    { name: 'Kapanol 20mg', value: 20, unit: 'แคปซูล' },
                    { name: 'MST 10mg', value: 10, unit: 'เม็ด' }
                ]
            }
        },
        'morphine_iv_infusion': { name: 'Morphine (IV Infusion)', factor: 3, unit: 'mg/day', helper: 'iv_infusion', hasMgDayInput: true, drugInfo: { name: 'Morphine', concentration: 10, unit: 'mg/ml' } },
        'fentanyl_iv_infusion': { name: 'Fentanyl (IV Infusion)', factor: 0.3, unit: 'mcg/day', helper: 'iv_infusion', hasMgDayInput: true, drugInfo: { name: 'Fentanyl', concentration: 50, unit: 'mcg/ml' } },
        'morphine_csci': { name: 'Morphine (CSCI)', factor: 3, unit: 'mg/day', helper: 'csci', hasMgDayInput: true, drugInfo: { name: 'Morphine', concentration: 10, unit: 'mg/ml' } },
        'fentanyl_csci': { name: 'Fentanyl (CSCI)', factor: 0.3, unit: 'mcg/day', helper: 'csci', hasMgDayInput: true, drugInfo: { name: 'Fentanyl', concentration: 50, unit: 'mcg/ml' } },
    };

    const SYRINGE_DATA = { 'BD': { 20: { length: 88.0 }, 30: { length: 87.5 }, 50: { length: 123.0 } } };
    const LOCAL_STORAGE_KEY = 'opioidCalculatorData_v14_final';
    const THEME_KEY = 'opioidCalculatorTheme_v14';

    // --- STATE ---
    let currentTheme = 'theme-material';
    let pinnedDrugKey = null;
    let rotationSourceMME = null; 
    let rotationTargetMME = null;
    let titrationMode = 'prn';
    let percentAdjustment = 0;
    let prnCount = 0;
    let rotationBasalCount = 0;
    let balancePair = { decreaseKey: null, increaseKey: null };
    let isBalancingFromUser = false;
    let tddHelperTargetKey = null;
    let lockedDrugs = [];
    let isTitrationToolCollapsed = false;

    // --- DOM ELEMENTS ---
    const elements = {
        body: document.body,
        themeToggleBtn: document.getElementById('theme-toggle-btn'),
        medSection: document.getElementById('medication-section'),
        titrationToolContainer: document.getElementById('titration-tool-container'),
        titrationToolHeader: document.getElementById('titration-tool-header'),
        titrationToolContent: document.getElementById('titration-tool-content'),
        titrationToggleBtn: document.getElementById('titration-toggle-btn'),
        titrationToggleIcon: document.getElementById('titration-toggle-icon'),
        titrationModeToggle: document.getElementById('titration-mode-toggle'),
        titrationTargetDisplay: document.getElementById('titration-target-display'),
        prnTitrationSection: document.getElementById('prn-titration-section'),
        percentTitrationSection: document.getElementById('percent-titration-section'),
        balanceTitrationSection: document.getElementById('balance-titration-section'),
        balanceInstruction: document.getElementById('balance-instruction'),
        breakthroughRowsContainer: document.getElementById('breakthrough-rows-container'),
        addBreakthroughBtn: document.getElementById('add-breakthrough-btn'),
        totalMmeBox: document.getElementById('total-mme-box'),
        totalMmeNormalView: document.getElementById('total-mme-normal-view'),
        totalMmeRotationView: document.getElementById('total-mme-rotation-view'),
        totalMmeDisplay: document.getElementById('total-mme-display'),
        rotationGoalDisplay: document.getElementById('rotation-goal-display'),
        emptyStateMessage: document.getElementById('empty-state-message'),
        clearAllBtn: document.getElementById('clear-all-btn'),
        rotateBtn: document.getElementById('rotate-btn'),
        cancelRotateBtn: document.getElementById('cancel-rotate-btn'),
        rotationTools: document.getElementById('rotation-tools'),
        basalRecommendation: document.getElementById('basal-recommendation'),
        rotationBasalRowsContainer: document.getElementById('rotation-basal-rows-container'),
        addRotationBasalBtn: document.getElementById('add-rotation-basal-btn'),
        recalculateMmeBtn: document.getElementById('recalculate-mme-btn'),
        rotationTotalPercent: document.getElementById('rotation-total-percent'),
        breakthroughRecommendation: document.getElementById('breakthrough-recommendation'),
        safetyChecklistBtn: document.getElementById('safety-checklist-btn'),
        customPercentInput: document.getElementById('custom-percent-input'),
        percentAdjustButtons: document.querySelectorAll('.percent-adjust-btn'),
        breakthroughCalcDrug: document.getElementById('breakthrough-calc-drug'),
        breakthroughCalcPercent: document.getElementById('breakthrough-calc-percent'),
        breakthroughRecommendationText: document.getElementById('breakthrough-recommendation-text'),
        // Modals
        guidedReductionModal: document.getElementById('guided-reduction-modal'),
        reductionSourceMme: document.getElementById('reduction-source-mme'),
        reductionChoiceBtns: document.querySelectorAll('.reduction-choice-btn'),
        reductionCustomPercent: document.getElementById('reduction-custom-percent'),
        cancelReductionBtn: document.getElementById('cancel-reduction-btn'),
        confirmReductionBtn: document.getElementById('confirm-reduction-btn'),
        drugInfoModal: document.getElementById('drug-info-modal'),
        tddHelperModal: document.getElementById('tdd-helper-modal'),
        safetyModal: document.getElementById('safety-modal'),
        quickRefModal: document.getElementById('quick-ref-modal'),
        drugInfoTitle: document.getElementById('drug-info-title'), 
        drugInfoContent: document.getElementById('drug-info-content'),
        tddHelperDrugName: document.getElementById('tdd-helper-drug-name'), 
        tddHelperDrugUnit: document.getElementById('tdd-helper-drug-unit'), 
        tddHelperDrugAmount: document.getElementById('tdd-helper-drug-amount'), 
        tddHelperFluidVolume: document.getElementById('tdd-helper-fluid-volume'), 
        tddHelperRate: document.getElementById('tdd-helper-rate'), 
        tddHelperResultDisplay: document.getElementById('tdd-helper-result-display'),
        confirmTddHelperBtn: document.getElementById('confirm-tdd-helper-btn'),
        quickRefTitle: document.getElementById('quick-ref-title'), 
        quickRefMmeTotal: document.getElementById('quick-ref-mme-total'), 
        quickRefList: document.getElementById('quick-ref-list'),
    };

    function initialize() {
        loadTheme();
        createMedicationInputs();
        populateDropdowns();
        setupEventListeners();
        loadFromLocalStorage();
    }
    
    function loadTheme() {
        const savedTheme = localStorage.getItem(THEME_KEY) || 'theme-material';
        setTheme(savedTheme);
    }
    function setTheme(themeName) {
        elements.body.className = '';
        elements.body.classList.add(themeName, 'p-3', 'sm:p-4', 'md:p-6');
        currentTheme = themeName;
        localStorage.setItem(THEME_KEY, themeName);
    }
    function toggleTheme() {
        const newTheme = currentTheme === 'theme-material' ? 'theme-neumorphic' : 'theme-material';
        setTheme(newTheme);
    }

    function createMedicationInputs() {
        elements.medSection.innerHTML = ''; 
        Object.keys(DRUG_CONFIG).forEach(key => {
            const config = DRUG_CONFIG[key];
            if (!config.isBasal) return;
            
            const stepAttribute = config.step ? `step="${config.step}"` : '';
            const tddHelperButton = (key === 'morphine_iv_sc' || key === 'fentanyl_iv_sc') 
                ? `<button class="btn btn-icon tdd-helper-btn text-sky-600" data-key="${key}" title="คำนวณ TDD จาก Rate"><i class="fas fa-calculator"></i></button>` 
                : '<span class="w-10 h-10"></span>';

            const inputHtml = `
                <div class="drug-row py-3" data-row-key="${key}">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2 items-start">
                        <div class="col-span-1">
                            <button class="drug-name-btn text-left w-full group" data-key="${key}">
                                <span class="font-semibold text-gray-800 text-base group-hover:text-sky-700">${config.name}</span>
                            </button>
                            <div class="flex items-center gap-3 text-sm mt-1">
                                <button class="row-mme-ref" data-key="${key}">
                                    <span class="font-bold text-sky-700">MME: <span id="mme-${key}">0</span></span>
                                    <span id="mg-day-${key}" class="text-xs text-gray-500 ml-2"></span>
                                </button>
                                <div id="dose-change-${key}" class="text-xs font-medium h-4"></div>
                            </div>
                        </div>
                        <div class="col-span-1">
                            <div class="flex items-center gap-2">
                                <div class="flex-1 input-stepper">
                                    <button class="btn stepper-btn minus" data-target="dose-${key}" data-amount="-${config.step || 1}">-</button>
                                    <input type="number" inputmode="decimal" id="dose-${key}" data-key="${key}" class="input-field base-drug-input" placeholder="0" ${stepAttribute}>
                                    <button class="btn stepper-btn plus" data-target="dose-${key}" data-amount="${config.step || 1}">+</button>
                                </div>
                                ${tddHelperButton}
                                <button class="btn btn-icon lock-btn" data-key="${key}" title="ล็อก/ปลดล็อกยานี้">
                                    <i id="lock-icon-${key}" class="fas fa-unlock-alt"></i>
                                </button>
                                <button class="btn btn-icon pin-btn" data-key="${key}" title="เลือกยานี้เพื่อปรับ Dose">
                                    <i id="pin-icon-${key}" class="fas fa-thumbtack"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
            elements.medSection.insertAdjacentHTML('beforeend', inputHtml);
        });
    }
    
    function addBreakthroughRow(data = {key: '', dose: ''}) {
        prnCount++;
        const newRow = document.createElement('div');
        newRow.className = 'grid grid-cols-12 gap-2 items-center prn-row';
        const inputId = `prn-dose-${prnCount}`;
        newRow.innerHTML = `
            <div class="col-span-6"><select class="select-field w-full prn-drug-select" data-id="${prnCount}"></select></div>
            <div class="col-span-5 input-stepper">
                <button class="btn stepper-btn minus" data-target="${inputId}" data-amount="-1">-</button>
                <input type="number" inputmode="decimal" class="input-field prn-dose-input" id="${inputId}" data-id="${prnCount}">
                <button class="btn stepper-btn plus" data-target="${inputId}" data-amount="1">+</button>
            </div>
            <div class="col-span-1"><button class="btn btn-icon !w-9 !h-9 text-red-500 remove-prn-btn"><i class="fas fa-times"></i></button></div>
        `;
        const select = newRow.querySelector('.prn-drug-select');
        select.innerHTML = '<option value="">-- เลือกยา --</option>';
        Object.keys(DRUG_CONFIG).forEach(key => {
            if (DRUG_CONFIG[key].isBreakthrough) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = DRUG_CONFIG[key].name;
                select.appendChild(option);
            }
        });
        
        const doseInput = newRow.querySelector('.prn-dose-input');
        
        elements.breakthroughRowsContainer.appendChild(newRow);
        
        if(data.key) {
            select.value = data.key;
            doseInput.value = data.dose;
            const unit = DRUG_CONFIG[data.key]?.unit || '';
            doseInput.placeholder = unit || 'ขนาดยา';
        } else {
            doseInput.placeholder = 'ขนาดยา';
        }
    }

    function addRotationBasalRow(data = {}) {
        rotationBasalCount++;
        const rowId = `rotation-row-${rotationBasalCount}`;
        const newRow = document.createElement('div');
        newRow.className = 'rotation-basal-row bg-white p-3 rounded-lg border transition-all';
        newRow.id = rowId;

        const mainControls = `
            <div class="grid grid-cols-12 gap-2 items-center">
                <div class="col-span-5">
                    <select class="select-field !text-xs !p-1.5 !rounded-md rotation-basal-drug" data-row-id="${rowId}">
                        <option value="">-- เลือกยา Basal --</option>
                        ${Object.keys(ROTATION_DRUGS).map(key => `<option value="${key}">${ROTATION_DRUGS[key].name}</option>`).join('')}
                    </select>
                </div>
                <div class="col-span-5 flex items-center gap-1">
                    <div class="flex-1 input-stepper">
                        <button class="btn stepper-btn minus !w-7 !h-8" data-target="rotation-percent-${rotationBasalCount}" data-amount="-5">-</button>
                        <input type="number" id="rotation-percent-${rotationBasalCount}" class="input-field !text-xs !p-1.5 !rounded-none text-center rotation-basal-percent" placeholder="%" step="5">
                        <button class="btn stepper-btn plus !w-7 !h-8" data-target="rotation-percent-${rotationBasalCount}" data-amount="5">+</button>
                    </div>
                    <span class="text-xs text-gray-500 w-14 text-center font-medium rotation-mme-value"></span>
                </div>
                <button class="btn btn-icon !w-7 !h-7 text-sky-600 col-span-1 rotation-lock-btn" title="ล็อกสัดส่วน">
                    <i class="fas fa-unlock-alt"></i>
                </button>
                <button class="btn btn-icon !w-7 !h-7 text-red-500 col-span-1 remove-rotation-basal-btn"><i class="fas fa-times"></i></button>
            </div>`;
        
        const expandableContent = `
            <div class="expandable-content" data-row-id="${rowId}">
                 <div class="border-t mt-3 pt-3 space-y-3 helper-content-mg-day hidden">
                     <label class="block text-xs font-medium text-gray-700">คำนวณจาก Dose <span class="mg-day-unit"></span></label>
                     <input type="number" class="input-field !text-xs !p-1.5 !rounded-md mt-1 helper-input rotation-mg-day-input" placeholder="ใส่ Dose">
                 </div>
                <div class="border-t mt-3 pt-3 space-y-3 helper-content-csci hidden">
                    <p class="text-xs font-semibold text-gray-600">CSCI Helper</p>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700">Syringe Size</label>
                            <select class="select-field !text-xs !p-1.5 !rounded-md mt-1 helper-input csci-syringe-size">
                                <option value="20">20 ml</option>
                                <option value="30">30 ml</option>
                                <option value="50">50 ml</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700">Total Volume (ml)</label>
                            <input type="number" class="input-field !text-xs !p-1.5 !rounded-md mt-1 helper-input csci-total-volume" placeholder="e.g. 22, 24">
                        </div>
                    </div>
                </div>
                <div class="border-t mt-3 pt-3 space-y-2 helper-content-iv_infusion hidden">
                    <p class="text-xs font-semibold text-gray-600">IV Infusion Helper</p>
                    <div>
                        <label class="block text-xs font-medium text-gray-700">Fluid Volume (ml)</label>
                        <input type="number" class="input-field !text-xs !p-1.5 !rounded-md mt-1 helper-input iv-fluid-volume" value="100">
                    </div>
                </div>
            </div>`;

        const resultDisplay = `<div class="mt-2 text-sm font-semibold text-green-700 text-right rotation-basal-result"></div>`;

        newRow.innerHTML = mainControls + expandableContent + resultDisplay;
        elements.rotationBasalRowsContainer.appendChild(newRow);

        if (data.drugKey) {
            const select = newRow.querySelector('.rotation-basal-drug');
            select.value = data.drugKey;
            newRow.querySelector('.rotation-basal-percent').value = data.percent;
            
            const config = ROTATION_DRUGS[data.drugKey];
            const expandable = newRow.querySelector('.expandable-content');

            if (config && (config.helper || config.hasMgDayInput)) {
                 expandable.classList.add('expanded');
            }
            if (config && config.hasMgDayInput) {
                const mgDayHelper = expandable.querySelector('.helper-content-mg-day');
                mgDayHelper.classList.remove('hidden');
                mgDayHelper.querySelector('.mg-day-unit').textContent = `(${config.unit})`;
                if (data.helperData && data.helperData.mgDay) {
                    mgDayHelper.querySelector('.rotation-mg-day-input').value = data.helperData.mgDay;
                }
            }
            if (config && config.helper) {
                const helperContent = expandable.querySelector(`.helper-content-${config.helper}`);
                if (helperContent) {
                    helperContent.classList.remove('hidden');
                    if (config.helper === 'csci' && data.helperData) {
                        helperContent.querySelector('.csci-syringe-size').value = data.helperData.syringeSize;
                        helperContent.querySelector('.csci-total-volume').value = data.helperData.totalVolume;
                    } else if (config.helper === 'iv_infusion' && data.helperData) {
                        helperContent.querySelector('.iv-fluid-volume').value = data.helperData.fluidVolume;
                    }
                }
            }
            if (data.isLocked) {
                const lockBtn = newRow.querySelector('.rotation-lock-btn');
                lockBtn.classList.add('locked');
                lockBtn.querySelector('i').classList.replace('fa-unlock-alt', 'fa-lock');
                newRow.querySelector('.rotation-basal-percent').disabled = true;
                newRow.classList.add('locked');
            }
        }
    }


    function populateDropdowns() {
        elements.breakthroughCalcDrug.innerHTML = '';
        Object.keys(DRUG_CONFIG).forEach(key => {
            if (DRUG_CONFIG[key].isBreakthrough) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = DRUG_CONFIG[key].name;
                elements.breakthroughCalcDrug.appendChild(option);
            }
        });
    }

    function calculateAndRender() {
        if (isBalancingFromUser) return;
        let totalMME = 0;
        let hasInput = false;

        document.querySelectorAll('.pin-btn.pinned, .pin-btn.balance-decrease, .pin-btn.balance-increase').forEach(el => {
            el.classList.remove('pinned', 'balance-decrease', 'balance-increase');
        });
        document.querySelectorAll('[id^="dose-change-"]').forEach(el => el.innerHTML = '');
        elements.titrationTargetDisplay.textContent = '';

        document.querySelectorAll('.base-drug-input, .pin-btn').forEach(el => el.disabled = false);
        lockedDrugs.forEach(key => {
            const input = document.getElementById(`dose-${key}`);
            if (input) input.disabled = true;
            const lockBtn = document.querySelector(`.lock-btn[data-key="${key}"]`);
            if(lockBtn) lockBtn.classList.add('locked');
            const pinBtn = document.querySelector(`.pin-btn[data-key="${key}"]`);
            if(pinBtn) pinBtn.disabled = true;
            const lockIcon = document.getElementById(`lock-icon-${key}`);
            if(lockIcon) { lockIcon.classList.remove('fa-unlock-alt'); lockIcon.classList.add('fa-lock'); }
        });
        Object.keys(DRUG_CONFIG).forEach(key => {
            if (!lockedDrugs.includes(key)) {
                const lockIcon = document.getElementById(`lock-icon-${key}`);
                if (lockIcon) { lockIcon.classList.remove('fa-lock'); lockIcon.classList.add('fa-unlock-alt'); }
            }
        });

        handleUIMode();

        let baseMME = 0;
        document.querySelectorAll('.drug-row').forEach(row => {
            const key = row.dataset.rowKey;
            const input = document.getElementById(`dose-${key}`);
            const config = DRUG_CONFIG[key];
            let individualMme = 0;
            const userDose = parseFloat(input.value);
            if (!isNaN(userDose) && userDose > 0) {
                hasInput = true;
                const doseForCalc = userDose * (config.strength || 1);
                individualMme = doseForCalc * config.factor;
            }
            document.getElementById(`mme-${key}`).textContent = Math.round(individualMme);
            baseMME += individualMme;
            const mgDaySpan = document.getElementById(`mg-day-${key}`);
            if (mgDaySpan) {
                mgDaySpan.textContent = (config.strength && config.factor !== 1 && !isNaN(userDose) && userDose > 0) 
                    ? `(${(userDose * config.strength).toFixed(0)} mg)` : '';
            }
        });

        let titrationMME = 0;
        if (titrationMode === 'prn' && !isTitrationToolCollapsed) {
            document.querySelectorAll('.prn-row').forEach(row => {
                const key = row.querySelector('.prn-drug-select').value;
                const dose = parseFloat(row.querySelector('.prn-dose-input').value) || 0;
                if (dose > 0 && key && DRUG_CONFIG[key]) {
                    hasInput = true;
                    const config = DRUG_CONFIG[key];
                    const doseForCalc = dose * (config.strength || 1);
                    titrationMME += doseForCalc * config.factor;
                }
            });
        } else if (titrationMode === 'percent' && percentAdjustment !== 0 && rotationTargetMME === null && !isTitrationToolCollapsed) {
            let baseForTitration = 0;
            if (pinnedDrugKey && !lockedDrugs.includes(pinnedDrugKey)) {
                const pinnedInput = document.getElementById(`dose-${pinnedDrugKey}`);
                const pinnedConfig = DRUG_CONFIG[pinnedDrugKey];
                const pinnedDose = parseFloat(pinnedInput.value) || 0;
                baseForTitration = (pinnedDose > 0) ? (pinnedDose * (pinnedConfig.strength || 1)) * pinnedConfig.factor : 0;
            } else if (!pinnedDrugKey) {
                document.querySelectorAll('.base-drug-input:not(:disabled)').forEach(input => {
                    const key = input.dataset.key;
                    const config = DRUG_CONFIG[key];
                    const dose = parseFloat(input.value) || 0;
                    if (dose > 0) {
                        baseForTitration += (dose * (config.strength || 1)) * config.factor;
                    }
                });
            }
            titrationMME = baseForTitration * (percentAdjustment / 100);
            updateDoseChangeIndicators(percentAdjustment);
        }
        
        totalMME = baseMME + titrationMME;
        
        if (rotationTargetMME !== null) {
            elements.totalMmeNormalView.classList.add('hidden');
            elements.totalMmeRotationView.classList.remove('hidden');
            
            elements.recalculateMmeBtn.classList.remove('hidden');

            const isConfirmed = elements.recalculateMmeBtn.dataset.state === 'edit';
            if (!isConfirmed) {
                const reductionPercent = rotationSourceMME > 0 ? ((rotationSourceMME - rotationTargetMME) / rotationSourceMME) * 100 : 0;
                elements.rotationGoalDisplay.innerHTML = `เป้าหมาย: <strong class="text-lg text-sky-900">${Math.round(rotationTargetMME)}</strong> MME <span class="text-sm text-gray-500">(จาก ${Math.round(rotationSourceMME)}, ลด ${reductionPercent.toFixed(0)}%)</span>`;
            }
            
            elements.rotationTools.classList.remove('hidden');
            updateRotationRecommendations(rotationTargetMME);
            updateBreakthroughRecommendation(rotationTargetMME);
            document.querySelectorAll('.base-drug-input').forEach(input => input.disabled = true);
            totalMME = rotationTargetMME;
        } else {
            elements.totalMmeNormalView.classList.remove('hidden');
            elements.totalMmeRotationView.classList.add('hidden');
            elements.rotationTools.classList.add('hidden');
            lockedDrugs.forEach(key => {
                const input = document.getElementById(`dose-${key}`);
                if (input) input.disabled = true;
            });
        }
        
        elements.totalMmeDisplay.textContent = Math.round(totalMME);
        elements.emptyStateMessage.style.display = hasInput || rotationTargetMME !== null ? 'none' : 'block';
        elements.rotateBtn.classList.toggle('hidden', totalMME <= 0 || rotationTargetMME !== null);

        saveToLocalStorage();
    }
    
    function handleUIMode() {
        document.querySelectorAll('.utility-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.mode === titrationMode));
        elements.prnTitrationSection.classList.toggle('hidden', titrationMode !== 'prn');
        elements.percentTitrationSection.classList.toggle('hidden', titrationMode !== 'percent' && titrationMode !== 'balance');
        elements.balanceTitrationSection.classList.toggle('hidden', titrationMode !== 'balance');
        
        if (titrationMode === 'percent') {
            if (pinnedDrugKey) {
                document.querySelector(`.pin-btn[data-key="${pinnedDrugKey}"]`)?.classList.add('pinned');
                elements.titrationTargetDisplay.textContent = `ปรับยา: ${DRUG_CONFIG[pinnedDrugKey].name}`;
            } else {
                elements.titrationTargetDisplay.innerHTML = `<span class="text-xs font-normal">คลิก <i class="fas fa-thumbtack"></i> เพื่อปรับยาตัวเดียว</span>`;
            }
        } else if (titrationMode === 'balance') {
            const { decreaseKey, increaseKey } = balancePair;
            if (decreaseKey) {
                document.querySelector(`.pin-btn[data-key="${decreaseKey}"]`)?.classList.add('balance-decrease');
            }
            if (increaseKey) {
                document.querySelector(`.pin-btn[data-key="${increaseKey}"]`)?.classList.add('balance-increase');
            }
            if (!decreaseKey) {
                elements.balanceInstruction.innerHTML = `<i class="fas fa-arrow-down text-red-600"></i> คลิก <i class="fas fa-thumbtack"></i> ของ <strong class="text-red-600">ยาที่จะลด</strong>`;
            } else if (!increaseKey) {
                elements.balanceInstruction.innerHTML = `<i class="fas fa-arrow-up text-green-700"></i> คลิก <i class="fas fa-thumbtack"></i> ของ <strong class="text-green-700">ยาที่จะเพิ่ม</strong>`;
            } else {
                elements.balanceInstruction.innerHTML = `<div class="space-y-1"><p><i class="fas fa-check-circle text-blue-600"></i> พร้อมปรับสมดุล!</p><p class="text-xs text-gray-500 font-normal">ปรับ Dose ยาตัวใดตัวหนึ่ง หรือใช้แถบ % ด้านล่าง</p></div>`;
            }
        }
    }
    
    function updateDoseChangeIndicators(percent, balancePairKeys = null) {
        const keysToUpdate = balancePairKeys ? [balancePairKeys.decreaseKey, balancePairKeys.increaseKey] : (pinnedDrugKey ? [pinnedDrugKey] : Object.keys(DRUG_CONFIG).filter(k => DRUG_CONFIG[k].isBasal && !lockedDrugs.includes(k)));
        
        keysToUpdate.forEach(key => {
            const row = document.querySelector(`.drug-row[data-row-key="${key}"]`);
            if (!row) return;

            const input = document.getElementById(`dose-${key}`);
            const originalDose = parseFloat(input.dataset.originalDose || input.value) || 0;
            if (originalDose === 0 && !balancePairKeys) return;

            let newDose;
            if (balancePairKeys) {
                newDose = parseFloat(input.value) || 0;
            } else {
                newDose = originalDose * (1 + percent / 100);
            }

            const indicator = document.getElementById(`dose-change-${key}`);
            const color = newDose > originalDose ? 'text-green-600' : 'text-red-600';
            
            if (Math.abs(newDose - originalDose) > 0.01) {
                indicator.innerHTML = `<span class="${color}">${formatDose(originalDose)} &rarr; ${formatDose(newDose)}</span>`;
            }
        });
    }

    function handlePinClick(key) {
        if (rotationTargetMME !== null || lockedDrugs.includes(key)) return; 

        if (titrationMode === 'percent') {
            pinnedDrugKey = (pinnedDrugKey === key) ? null : key;
        } else if (titrationMode === 'balance') {
            const { decreaseKey, increaseKey } = balancePair;
            if (!decreaseKey && key !== increaseKey) {
                balancePair.decreaseKey = key;
            } else if (key === decreaseKey) {
                balancePair.decreaseKey = null;
            } else if (!increaseKey && key !== decreaseKey) {
                balancePair.increaseKey = key;
            } else if (key === increaseKey) {
                balancePair.increaseKey = null;
            }
        }
        calculateAndRender();
    }

    function handleLockClick(key) {
        const index = lockedDrugs.indexOf(key);
        if (index > -1) {
            lockedDrugs.splice(index, 1);
        } else {
            lockedDrugs.push(key);
        }
        if (lockedDrugs.includes(balancePair.decreaseKey) || lockedDrugs.includes(balancePair.increaseKey)) {
            balancePair = { decreaseKey: null, increaseKey: null };
        }
        if (lockedDrugs.includes(pinnedDrugKey)) {
            pinnedDrugKey = null;
        }
        calculateAndRender();
    }

    function handlePercentAdjustment(percent, fromUserInput = true) {
        percentAdjustment = percent;
        if(fromUserInput) {
            elements.customPercentInput.value = percent;
        }
        
        if (fromUserInput && titrationMode === 'balance' && balancePair.decreaseKey && balancePair.increaseKey) {
            performBalance(percent);
        } else {
            calculateAndRender();
        }
    }
    function performBalance(percent) {
        const { decreaseKey, increaseKey } = balancePair;
        if(!decreaseKey || !increaseKey) return;
        const decConfig = DRUG_CONFIG[decreaseKey];
        const incConfig = DRUG_CONFIG[increaseKey];
        const decInput = document.getElementById(`dose-${decreaseKey}`);
        const incInput = document.getElementById(`dose-${increaseKey}`);
        const decOriginalDose = parseFloat(decInput.dataset.originalDose);
        const incOriginalDose = parseFloat(incInput.dataset.originalDose);
        const decOriginalMME = (decOriginalDose * (decConfig.strength || 1)) * decConfig.factor;
        let mmeToTransfer = decOriginalMME * (percent / 100);
        let newDecMME = decOriginalMME - mmeToTransfer;
        const incOriginalMME = (incOriginalDose * (incConfig.strength || 1)) * incConfig.factor;
        let newIncMME = incOriginalMME + mmeToTransfer;
        if (newDecMME < 0) { newIncMME += newDecMME; newDecMME = 0; }
        if (newIncMME < 0) { newDecMME += newIncMME; newIncMME = 0; }
        const newDecDoseRaw = (newDecMME / decConfig.factor) / (decConfig.strength || 1);
        const newIncDoseRaw = (newIncMME / incConfig.factor) / (incConfig.strength || 1);
        const newDecDose = roundToStep(newDecDoseRaw, decConfig.step || 0.1);
        const newIncDose = roundToStep(newIncDoseRaw, incConfig.step || 0.1);
        isBalancingFromUser = true;
        decInput.value = newDecDose > 0 ? formatDose(newDecDose) : '';
        incInput.value = newIncDose > 0 ? formatDose(newIncDose) : '';
        isBalancingFromUser = false;
        calculateAndRender();
        updateDoseChangeIndicators(percent, balancePair);
    }
    function performBalanceFromDoseChange(changedKey, newDose) {
        const { decreaseKey, increaseKey } = balancePair;
        if (!decreaseKey || !increaseKey) return;
        isBalancingFromUser = true;
        const decConfig = DRUG_CONFIG[decreaseKey];
        const incConfig = DRUG_CONFIG[increaseKey];
        const decInput = document.getElementById(`dose-${decreaseKey}`);
        const incInput = document.getElementById(`dose-${increaseKey}`);
        const decOriginalDose = parseFloat(decInput.dataset.originalDose);
        const incOriginalDose = parseFloat(incInput.dataset.originalDose);
        const decOriginalMME = (decOriginalDose * (decConfig.strength || 1)) * decConfig.factor;
        const incOriginalMME = (incOriginalDose * (incConfig.strength || 1)) * incConfig.factor;
        const pairTotalMME = decOriginalMME + incOriginalMME;
        let newDecMME, newIncMME;
        if (changedKey === decreaseKey) {
            newDecMME = (newDose * (decConfig.strength || 1)) * decConfig.factor;
            newIncMME = pairTotalMME - newDecMME;
            if (newIncMME < 0) { newDecMME += newIncMME; newIncMME = 0; }
            const newIncDoseRaw = (newIncMME / incConfig.factor) / (incConfig.strength || 1);
            incInput.value = formatDose(roundToStep(newIncDoseRaw, incConfig.step || 0.1));
        } else { 
            newIncMME = (newDose * (incConfig.strength || 1)) * incConfig.factor;
            newDecMME = pairTotalMME - newIncMME;
            if (newDecMME < 0) { newIncMME += newDecMME; newDecMME = 0; }
            const newDecDoseRaw = (newDecMME / decConfig.factor) / (decConfig.strength || 1);
            decInput.value = formatDose(roundToStep(newDecDoseRaw, decConfig.step || 0.1));
        }
        let newPercent = 0;
        if (decOriginalMME > 0) {
            const mmeMoved = decOriginalMME - newDecMME;
            newPercent = (mmeMoved / decOriginalMME) * 100;
        }
        elements.customPercentInput.value = newPercent.toFixed(1);
        handlePercentAdjustment(newPercent, false);
        isBalancingFromUser = false;
        calculateAndRender();
        updateDoseChangeIndicators(newPercent, balancePair);
    }
    function roundToStep(value, step) {
        if (!step || step <= 0 || value <=0) return value;
        return Math.round(value / step) * step;
    }
    function formatDose(dose) {
        if (dose <= 0) return '';
        return parseFloat(dose.toFixed(4));
    }
    function setTitrationMode(mode) {
        titrationMode = mode;
        pinnedDrugKey = null;
        if (mode !== 'balance') {
            balancePair = { decreaseKey: null, increaseKey: null };
            document.querySelectorAll('.base-drug-input').forEach(input => {
                if (input.dataset.originalDose) {
                    input.value = input.dataset.originalDose > 0 ? input.dataset.originalDose : '';
                    delete input.dataset.originalDose;
                }
            });
        } else {
            document.querySelectorAll('.base-drug-input:not(:disabled)').forEach(input => {
                input.dataset.originalDose = parseFloat(input.value) || 0;
            });
        }
        handlePercentAdjustment(0);
        calculateAndRender();
    }
    
    function startRotationFlow() {
        const sourceMME = parseFloat(elements.totalMmeDisplay.textContent);
        if (isNaN(sourceMME) || sourceMME <= 0) return;
        
        rotationSourceMME = sourceMME;
        elements.reductionSourceMme.textContent = `${Math.round(sourceMME)} MME/day`;
        elements.reductionCustomPercent.value = '0';
        openModal('guided-reduction-modal');
    }

    function confirmRotationTarget() {
        const reductionPercent = parseFloat(elements.reductionCustomPercent.value);
        if (isNaN(reductionPercent) || reductionPercent < 0 || reductionPercent >= 100) {
            alert('กรุณาใส่ค่าเปอร์เซ็นต์ที่ถูกต้อง (0-99)');
            return;
        }
        
        rotationTargetMME = rotationSourceMME * (1 - (reductionPercent / 100));
        closeModal('guided-reduction-modal');
        
        toggleRecalculateButton(false);

        if (elements.rotationBasalRowsContainer.children.length === 0) {
            addRotationBasalRow({ percent: 100 });
        }
        distributePercentages();
        calculateAndRender();
    }

    function cancelRotationFlow() {
        rotationSourceMME = null;
        rotationTargetMME = null;
        elements.rotationBasalRowsContainer.innerHTML = '';
        calculateAndRender();
    }

    function getActualDoseFromRow(row, equivalentDose) {
        const drugKey = row.querySelector('.rotation-basal-drug').value;
        const config = ROTATION_DRUGS[drugKey];
        if (!config) return equivalentDose;

        if (drugKey === 'fentanyl_patch') {
            return roundToStep(equivalentDose, 12.5);
        } else if (config.prescriptionHelper) {
            const smallestStrength = Math.min(...config.prescriptionHelper.strengths.map(s => s.value));
            return smallestStrength > 0 ? Math.round(equivalentDose / smallestStrength) * smallestStrength : equivalentDose;
        } else {
            return Math.round(equivalentDose);
        }
    }

    function toggleFinalMMEConfirmation() {
        const btn = elements.recalculateMmeBtn;
        const isConfirming = btn.dataset.state === 'confirm';

        if (isConfirming) {
            let actualMME = 0;
            document.querySelectorAll('.rotation-basal-row').forEach(row => {
                const drugKey = row.querySelector('.rotation-basal-drug').value;
                const percent = parseFloat(row.querySelector('.rotation-basal-percent').value) || 0;
                
                if (drugKey && percent > 0 && rotationTargetMME > 0) {
                    const config = ROTATION_DRUGS[drugKey];
                    const mmeForDrug = rotationTargetMME * (percent / 100);
                    let equivalentDose = mmeForDrug / config.factor;
                    const actualDose = getActualDoseFromRow(row, equivalentDose);
                    
                    if (drugKey === 'morphine_sr') {
                        actualMME += actualDose;
                    } else {
                        actualMME += actualDose * config.factor;
                    }
                }
            });

            if (actualMME > 0) {
                const oldTargetMMEValue = rotationTargetMME;
                rotationTargetMME = actualMME;

                let percentChange = 0;
                let changeText = '';
                if (oldTargetMMEValue > 0) {
                    percentChange = ((rotationTargetMME - oldTargetMMEValue) / oldTargetMMEValue) * 100;
                }
                if (Math.abs(percentChange) > 0.1) {
                    const changeWord = percentChange > 0 ? 'เพิ่ม' : 'ลด';
                    const changeColor = percentChange > 0 ? 'text-green-600' : 'text-red-600';
                    changeText = `, <span class="${changeColor}">${changeWord} ${Math.abs(percentChange).toFixed(1)}%</span>`;
                }

                elements.rotationGoalDisplay.innerHTML = `MME สุดท้าย: <strong class="text-lg text-red-700">${Math.round(rotationTargetMME)}</strong> <span class="text-sm text-gray-500">(จากเป้าหมาย ${Math.round(oldTargetMMEValue)}${changeText})</span>`;
                updateBreakthroughRecommendation(rotationTargetMME);
                toggleRecalculateButton(true);
            }
        } else {
            toggleRecalculateButton(false);
            const reductionPercent = rotationSourceMME > 0 ? ((rotationSourceMME - rotationTargetMME) / rotationSourceMME) * 100 : 0;
            elements.rotationGoalDisplay.innerHTML = `เป้าหมาย: <strong class="text-lg text-sky-900">${Math.round(rotationTargetMME)}</strong> MME <span class="text-sm text-gray-500">(จาก ${Math.round(rotationSourceMME)}, ลด ${reductionPercent.toFixed(0)}%)</span>`;
            calculateAndRender();
        }
    }

    function toggleRecalculateButton(isConfirmed) {
        const btn = elements.recalculateMmeBtn;
        const icon = btn.querySelector('i');
        const text = btn.querySelector('span');

        document.querySelectorAll('.rotation-basal-row input, .rotation-basal-row select, .rotation-lock-btn, .remove-rotation-basal-btn, #add-rotation-basal-btn').forEach(el => {
            el.disabled = isConfirmed;
        });
        
        if (isConfirmed) {
            btn.dataset.state = 'edit';
            btn.classList.replace('btn-primary', 'btn-secondary');
            icon.classList.replace('fa-calculator', 'fa-pencil-alt');
            text.textContent = 'กลับไปแก้ไขยา Basal';
        } else {
            btn.dataset.state = 'confirm';
            btn.classList.replace('btn-secondary', 'btn-primary');
            icon.classList.replace('fa-pencil-alt', 'fa-calculator');
            text.textContent = 'ยืนยันและคำนวณ MME สุดท้าย';
        }
    }


    function generatePrescriptionHtml(totalDose, strengthsConfig) {
        const smallestStrength = Math.min(...strengthsConfig.map(s => s.value));
        if (smallestStrength <= 0) return `<p>${totalDose.toFixed(0)} mg/day</p>`;

        const roundedDose = Math.round(totalDose / smallestStrength) * smallestStrength;
        if (roundedDose <= 0) return '';
        
        let remainingDose = roundedDose;
        const prescriptionItems = [];
        const isKapanolRegimen = strengthsConfig.some(s => s.name.includes('Kapanol'));

        const sortedStrengths = strengthsConfig.sort((a, b) => b.value - a.value);

        sortedStrengths.forEach(strengthInfo => {
            const numUnits = Math.floor(remainingDose / strengthInfo.value);
            if (numUnits > 0) {
                prescriptionItems.push({ name: strengthInfo.name, count: numUnits, unit: strengthInfo.unit });
                remainingDose -= numUnits * strengthInfo.value;
            }
        });
        
        let regimenSuggestion = '';
        if (isKapanolRegimen) {
            regimenSuggestion = 'แนะนำให้บริหารยาวันละครั้ง (OD)';
        } else {
            regimenSuggestion = 'แนะนำให้แบ่งบริหารยาทุก 8-12 ชั่วโมง (q 8-12 hr)';
        }

        const listHtml = prescriptionItems.map(item => `<li>${item.name}: ${item.count} ${item.unit}</li>`).join('');
        const suggestionHtml = regimenSuggestion ? `<p class="text-xs text-green-800 mt-2"><strong>การบริหารยา:</strong> ${regimenSuggestion}</p>` : '';

        return `<div class="text-left w-full"><p class="text-lg font-bold text-green-900">${roundedDose.toFixed(0)} mg/day</p><ul class="list-disc list-inside mt-1 text-xs text-gray-700 space-y-1 pl-2">${listHtml}</ul>${suggestionHtml}</div>`;
    }

    function updateRotationRecommendations(targetMME) {
        let totalPercent = 0;
        document.querySelectorAll('.rotation-basal-row').forEach(row => {
            const drugKey = row.querySelector('.rotation-basal-drug').value;
            const percentInput = row.querySelector('.rotation-basal-percent');
            const percent = parseFloat(percentInput.value) || 0;
            totalPercent += percent;
            
            const resultEl = row.querySelector('.rotation-basal-result');
            const mmeValueEl = row.querySelector('.rotation-mme-value');
            const mgDayInput = row.querySelector('.rotation-mg-day-input');

            resultEl.innerHTML = '';
            mmeValueEl.textContent = '';

            if (drugKey && percent > 0 && targetMME > 0) {
                const config = ROTATION_DRUGS[drugKey];
                const mmeForDrug = targetMME * (percent / 100);
                const equivalentDose = mmeForDrug / config.factor;
                
                if (mmeValueEl) {
                    mmeValueEl.textContent = `(${Math.round(mmeForDrug)} MME)`;
                }
                if (mgDayInput) {
                    mgDayInput.value = formatDose(equivalentDose);
                }
                
                if (config.prescriptionHelper) {
                    resultEl.innerHTML = generatePrescriptionHtml(equivalentDose, config.prescriptionHelper.strengths);
                } else if (config.helper === 'csci') {
                    const syringeSize = parseFloat(row.querySelector('.csci-syringe-size').value);
                    const totalVolume = parseFloat(row.querySelector('.csci-total-volume').value);
                    const syringeLength = SYRINGE_DATA.BD[syringeSize]?.length;
                    
                    if (!totalVolume || totalVolume <= 0 || !syringeLength) {
                        resultEl.innerHTML = `<p class="text-sm text-gray-500">กรอกข้อมูล CSCI Helper</p>`;
                        return;
                    }

                    const drugVolume = equivalentDose / config.drugInfo.concentration;
                    if (drugVolume > totalVolume || totalVolume > syringeSize) {
                        resultEl.innerHTML = `<p class="text-red-600 text-xs">ปริมาตรไม่ถูกต้อง</p>`;
                        return;
                    }

                    const diluentVolume = totalVolume - drugVolume;
                    const rateMmPerHour = (totalVolume / syringeSize) * (syringeLength / 24);
                    resultEl.innerHTML = `<p class="text-xs text-gray-700 bg-gray-100 p-2 rounded"><strong>Dose:</strong> ${equivalentDose.toFixed(0)} ${config.unit.split('/')[0]}<br><strong>Order:</strong> Drug ${drugVolume.toFixed(1)}ml + NSS ${diluentVolume.toFixed(1)}ml, CSCI @ ${rateMmPerHour.toFixed(2)} mm/hr</p>`;

                } else if (config.helper === 'iv_infusion') {
                    const fluidVolume = parseFloat(row.querySelector('.iv-fluid-volume').value);
                    if (!fluidVolume || fluidVolume <= 0) {
                        resultEl.innerHTML = `<p class="text-sm text-gray-500">กรอกข้อมูล IV Helper</p>`;
                        return;
                    }
                    const drugVolumeMl = equivalentDose / config.drugInfo.concentration;
                     if (drugVolumeMl > fluidVolume) {
                        resultEl.innerHTML = `<p class="text-red-600 text-xs">Drug vol > fluid vol</p>`;
                        return;
                    }
                    const rateMlPerHour = fluidVolume / 24;
                    resultEl.innerHTML = `<p class="text-xs text-gray-700 bg-gray-100 p-2 rounded"><strong>Dose:</strong> ${equivalentDose.toFixed(0)} ${config.unit.split('/')[0]}<br><strong>Order:</strong> Drug ${equivalentDose.toFixed(0)} ${config.drugInfo.unit.split('/')[0]} + NSS to ${fluidVolume}ml @ ${rateMlPerHour.toFixed(1)} ml/hr</p>`;

                } else {
                    let doseText = '';
                    let regimenText = '';
                    let wrapperClass = '';
                    if (drugKey === 'fentanyl_patch') {
                        doseText = `${roundToStep(equivalentDose, 12.5)} mcg/hr`;
                        regimenText = `<p class="text-xs text-gray-600 mt-1">(เปลี่ยนแผ่นแปะทุก 72 ชั่วโมง)</p>`;
                        wrapperClass = 'text-left';
                    } else {
                        doseText = `${Math.round(equivalentDose)} ${config.unit.split('/')[0]}`;
                    }
                    resultEl.innerHTML = `<div class="${wrapperClass}"><p class="text-lg font-bold text-green-900">${doseText}</p>${regimenText}</div>`;
                }
            }
        });

        elements.rotationTotalPercent.textContent = `Total: ${totalPercent.toFixed(0)}%`;
        elements.rotationTotalPercent.classList.toggle('text-red-500', Math.abs(totalPercent - 100) > 0.1);
        elements.rotationTotalPercent.classList.toggle('text-green-600', Math.abs(totalPercent - 100) <= 0.1);
    }

    function updateBreakthroughRecommendation(currentMME) {
        const key = elements.breakthroughCalcDrug.value;
        const percent = parseFloat(elements.breakthroughCalcPercent.value);
        if(!key || !percent || !currentMME || currentMME <= 0) {
            elements.breakthroughRecommendationText.innerHTML = ''; return;
        };
        const breakthroughMME = currentMME * percent;
        const config = DRUG_CONFIG[key];
        const doseInMg_raw = breakthroughMME / config.factor;
        let recommendationText = '';

        let prnFrequency = 'q 4-6h PRN'; // Default
        if (key.includes('morphine')) {
            prnFrequency = 'q 2-4h PRN';
        } else if (key.includes('fentanyl')) {
            prnFrequency = 'q 1-2h PRN';
        }

        if (config.strength) {
            const doseInUnit_raw = doseInMg_raw / config.strength;
            const finalDose = roundToStep(doseInUnit_raw, config.step || 1);
            if (finalDose > 0) {
                recommendationText = `<strong>${finalDose} ${config.unit.split('/')[0]}</strong> <span class="text-xs text-gray-500 font-normal">(~${(finalDose * config.strength).toFixed(1)} mg)</span> ${prnFrequency}`;
            } else {
                recommendationText = `<span class="text-xs text-gray-500 font-normal">ขนาดยาน้อยเกินไป</span>`;
            }
        } else { 
            const finalDose = Math.round(doseInMg_raw);
            if (finalDose > 0) {
                recommendationText = `<strong>${finalDose} ${config.unit.split('/')[0]}</strong> ${prnFrequency}`;
            } else {
                recommendationText = `<span class="text-xs text-gray-500 font-normal">ขนาดยาน้อยเกินไป</span>`;
            }
        }
        elements.breakthroughRecommendationText.innerHTML = recommendationText;
    }
    
    function openModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) modal.classList.add('visible');
    }

    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) modal.classList.remove('visible');
    }

    function openDrugInfoModal(key) {
        const config = DRUG_CONFIG[key];
        if (!config || !config.info) return;
        elements.drugInfoTitle.textContent = config.name;
        elements.drugInfoContent.innerHTML = config.info;
        openModal('drug-info-modal');
    }
    function openTddHelperModal(key) {
        tddHelperTargetKey = key;
        const config = DRUG_CONFIG[key];
        elements.tddHelperDrugName.textContent = config.name;
        elements.tddHelperDrugUnit.textContent = config.unit.split('/')[0];
        elements.tddHelperDrugAmount.value = '';
        elements.tddHelperFluidVolume.value = '';
        elements.tddHelperRate.value = '';
        elements.tddHelperResultDisplay.textContent = '0';
        openModal('tdd-helper-modal');
    }
    function calculateTddFromRate() {
        const drugAmount = parseFloat(elements.tddHelperDrugAmount.value);
        const fluidVolume = parseFloat(elements.tddHelperFluidVolume.value);
        const rate = parseFloat(elements.tddHelperRate.value);
        if (isNaN(drugAmount) || isNaN(fluidVolume) || isNaN(rate) || fluidVolume === 0) {
            elements.tddHelperResultDisplay.textContent = '...';
            return;
        }
        const concentration = drugAmount / fluidVolume;
        const tdd = concentration * rate * 24;
        elements.tddHelperResultDisplay.textContent = tdd.toFixed(2);
    }
    function applyTddFromHelper() {
        const resultTDD = parseFloat(elements.tddHelperResultDisplay.textContent);
        if (!isNaN(resultTDD) && tddHelperTargetKey) {
            const targetInput = document.getElementById(`dose-${tddHelperTargetKey}`);
            targetInput.value = resultTDD.toFixed(2);
            closeModal('tdd-helper-modal');
            calculateAndRender();
        }
    }
    
    function openQuickRefModal(mme, drugKey = null) {
        const quickRefList = elements.quickRefList;
        quickRefList.innerHTML = '';
        if (drugKey) {
            elements.quickRefTitle.textContent = `Ref: ${DRUG_CONFIG[drugKey].name}`;
        } else {
            elements.quickRefTitle.textContent = 'Total MME Quick Reference';
        }
        elements.quickRefMmeTotal.textContent = Math.round(mme);
        const refDrugs = ['fentanyl_patch', 'morphine_sr', 'morphine_iv_infusion', 'fentanyl_iv_infusion'];
        refDrugs.forEach(key => {
            const config = ROTATION_DRUGS[key];
            if (config) {
                const equivalentDose = mme / config.factor;
                const doseText = (key === 'fentanyl_patch') 
                    ? roundToStep(equivalentDose, 12.5).toFixed(1) 
                    : Math.round(equivalentDose);
                const rowHtml = `<div class="flex justify-between items-center bg-white p-2 rounded-md border"><span class="font-medium text-gray-700 text-sm">${config.name}</span><span class="font-bold text-green-700">${doseText} ${config.unit}</span></div>`;
                quickRefList.insertAdjacentHTML('beforeend', rowHtml);
            }
        });
        openModal('quick-ref-modal');
    }
    function toggleTitrationTool() {
        isTitrationToolCollapsed = !isTitrationToolCollapsed;
        elements.titrationToolContent.classList.toggle('hidden');
        elements.titrationToggleIcon.classList.toggle('rotate-180');
        calculateAndRender();
    }
    function saveToLocalStorage() {
        const baseDoses = {};
        document.querySelectorAll('.base-drug-input').forEach(input => { baseDoses[input.dataset.key] = input.value; });
        const prnDoses = Array.from(document.querySelectorAll('.prn-row')).map(row => ({ key: row.querySelector('.prn-drug-select').value, dose: row.querySelector('.prn-dose-input').value })).filter(d => d.key && d.dose);
        
        const rotationBasalData = Array.from(document.querySelectorAll('.rotation-basal-row')).map(row => {
            const drugKey = row.querySelector('.rotation-basal-drug').value;
            const config = ROTATION_DRUGS[drugKey];
            let helperData = {};
            if (config) {
                if (config.hasMgDayInput) {
                    helperData.mgDay = row.querySelector('.rotation-mg-day-input').value;
                }
                if (config.helper === 'csci') {
                    helperData.syringeSize = row.querySelector('.csci-syringe-size').value;
                    helperData.totalVolume = row.querySelector('.csci-total-volume').value;
                } else if (config.helper === 'iv_infusion') {
                    helperData.fluidVolume = row.querySelector('.iv-fluid-volume').value;
                }
            }
            const lockBtn = row.querySelector('.rotation-lock-btn');
            return {
                drugKey: drugKey,
                percent: row.querySelector('.rotation-basal-percent').value,
                isLocked: lockBtn ? lockBtn.classList.contains('locked') : false,
                helperData: helperData
            };
        });

        const state = { 
            baseDoses, prnDoses, titrationMode, percentAdjustment, 
            pinnedDrugKey, rotationSourceMME, rotationTargetMME, rotationBasalDrugs: rotationBasalData, 
            balancePair, lockedDrugs, isTitrationToolCollapsed, 
            rotationTools: { 
                breakthroughDrug: elements.breakthroughCalcDrug.value, 
                breakthroughPercent: elements.breakthroughCalcPercent.value 
            } 
        };
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(state));
    }
    function loadFromLocalStorage() {
        const savedState = localStorage.getItem(LOCAL_STORAGE_KEY);
        if (!savedState) { addBreakthroughRow(); calculateAndRender(); return; }
        try {
            const state = JSON.parse(savedState);
            Object.keys(state.baseDoses).forEach(key => { if (document.getElementById(`dose-${key}`)) document.getElementById(`dose-${key}`).value = state.baseDoses[key]; });
            elements.breakthroughRowsContainer.innerHTML = '';
            if (state.prnDoses && state.prnDoses.length > 0) { state.prnDoses.forEach(data => addBreakthroughRow(data)); } else { addBreakthroughRow(); }
            
            elements.rotationBasalRowsContainer.innerHTML = '';
            if (state.rotationBasalDrugs && state.rotationBasalDrugs.length > 0) {
                state.rotationBasalDrugs.forEach(data => addRotationBasalRow(data));
            }

            rotationSourceMME = state.rotationSourceMME || null;
            rotationTargetMME = state.rotationTargetMME || null;
            lockedDrugs = state.lockedDrugs || [];
            if (state.isTitrationToolCollapsed) {
                toggleTitrationTool();
            }
            setTitrationMode(state.titrationMode || 'prn');
            pinnedDrugKey = state.pinnedDrugKey || null;
            balancePair = state.balancePair || { decreaseKey: null, increaseKey: null };
            
            if (state.rotationTools) {
                elements.breakthroughCalcDrug.value = state.rotationTools.breakthroughDrug;
                elements.breakthroughCalcPercent.value = state.rotationTools.breakthroughPercent;
            }
            handlePercentAdjustment(state.percentAdjustment || 0, false);
            calculateAndRender();
        } catch (error) { console.error("Failed to load state:", error); clearAllInputs(); }
    }
    function clearAllInputs() {
        localStorage.removeItem(LOCAL_STORAGE_KEY);
        document.querySelectorAll('input[type="number"]').forEach(i => { i.value = ''; delete i.dataset.originalDose; });
        document.querySelectorAll('select').forEach(s => { if(!s.closest('#rotation-tools')) s.selectedIndex = 0; });
        elements.breakthroughRowsContainer.innerHTML = '';
        addBreakthroughRow();
        rotationSourceMME = null;
        rotationTargetMME = null;
        lockedDrugs = [];
        elements.rotationBasalRowsContainer.innerHTML = '';
        if (isTitrationToolCollapsed) {
            toggleTitrationTool();
        }
        setTitrationMode('prn');
    }

    function handleRotationLockClick(lockButton) {
        const row = lockButton.closest('.rotation-basal-row');
        const percentInput = row.querySelector('.rotation-basal-percent');
        const isNowLocked = lockButton.classList.toggle('locked');
        const icon = lockButton.querySelector('i');

        if (isNowLocked) {
            icon.classList.replace('fa-unlock-alt', 'fa-lock');
            percentInput.disabled = true;
            row.classList.add('locked');
        } else {
            icon.classList.replace('fa-lock', 'fa-unlock-alt');
            percentInput.disabled = false;
            row.classList.remove('locked');
        }
        distributePercentages();
        calculateAndRender();
    }

    function distributePercentages() {
        const rows = document.querySelectorAll('.rotation-basal-row');
        if (rows.length === 0) return;

        let lockedPercentTotal = 0;
        const unlockedRows = [];

        rows.forEach(row => {
            const lockBtn = row.querySelector('.rotation-lock-btn');
            const percentInput = row.querySelector('.rotation-basal-percent');
            if (lockBtn && lockBtn.classList.contains('locked')) {
                lockedPercentTotal += parseFloat(percentInput.value) || 0;
            } else {
                unlockedRows.push(row);
            }
        });

        if (unlockedRows.length > 0) {
            const remainingPercent = 100 - lockedPercentTotal;
            const percentPerUnlockedRow = remainingPercent > 0 ? remainingPercent / unlockedRows.length : 0;

            unlockedRows.forEach(row => {
                const percentInput = row.querySelector('.rotation-basal-percent');
                percentInput.value = parseFloat(percentPerUnlockedRow.toFixed(2));
            });
        }
    }

    function setupEventListeners() {
        elements.themeToggleBtn.addEventListener('click', toggleTheme);
        
        document.body.addEventListener('click', e => {
            const stepperBtn = e.target.closest('.stepper-btn');
            if (stepperBtn) {
                const targetInput = document.getElementById(stepperBtn.dataset.target);
                if (targetInput && !targetInput.disabled) {
                    const amount = parseFloat(stepperBtn.dataset.amount);
                    const currentValue = parseFloat(targetInput.value) || 0;
                    let newValue = currentValue + amount;
                    newValue = parseFloat(newValue.toFixed(4));
                    targetInput.value = newValue >= 0 ? newValue : 0;
                    targetInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
            }
        });

        elements.medSection.addEventListener('input', e => {
            if (e.target.classList.contains('base-drug-input')) {
                const key = e.target.dataset.key;
                if (titrationMode === 'balance' && (key === balancePair.decreaseKey || key === balancePair.increaseKey)) {
                    if (!isBalancingFromUser) {
                        const newDose = parseFloat(e.target.value) || 0;
                        performBalanceFromDoseChange(key, newDose);
                    }
                } else {
                    calculateAndRender();
                }
            }
        });
        elements.medSection.addEventListener('click', e => { 
            const pinButton = e.target.closest('.pin-btn');
            if(pinButton) handlePinClick(pinButton.dataset.key);
            const lockButton = e.target.closest('.lock-btn');
            if(lockButton) handleLockClick(lockButton.dataset.key);
            const tddHelperButton = e.target.closest('.tdd-helper-btn');
            if(tddHelperButton) openTddHelperModal(tddHelperButton.dataset.key);
            const drugNameButton = e.target.closest('.drug-name-btn');
            if(drugNameButton) openDrugInfoModal(drugNameButton.dataset.key);
            const rowMmeRef = e.target.closest('.row-mme-ref');
            if(rowMmeRef) {
                const key = rowMmeRef.dataset.key;
                const mme = parseFloat(document.getElementById(`mme-${key}`).textContent) || 0;
                if (mme > 0) openQuickRefModal(mme, key);
            }
        });
        
        elements.titrationToolHeader.addEventListener('click', (e) => {
            if (!e.target.closest('a, button, input, select')) {
                 toggleTitrationTool();
            }
        });
        elements.titrationModeToggle.addEventListener('click', e => { 
            const button = e.target.closest('.utility-btn'); 
            if (button && button.dataset.mode !== titrationMode) {
                setTitrationMode(button.dataset.mode);
            }
        });
        elements.percentAdjustButtons.forEach(button => button.addEventListener('click', () => handlePercentAdjustment(parseInt(button.dataset.percent, 10))));
        if(elements.customPercentInput) elements.customPercentInput.addEventListener('input', e => handlePercentAdjustment(parseFloat(e.target.value) || 0));
        elements.addBreakthroughBtn.addEventListener('click', () => { addBreakthroughRow(); calculateAndRender(); });
        elements.breakthroughRowsContainer.addEventListener('change', e => { 
            if (e.target.classList.contains('prn-drug-select')) {
                const doseInput = e.target.closest('.prn-row').querySelector('.prn-dose-input');
                const unit = (e.target.value && DRUG_CONFIG[e.target.value]) ? DRUG_CONFIG[e.target.value].unit : '';
                doseInput.placeholder = unit || 'ขนาดยา';
                calculateAndRender(); 
            } 
        });
        elements.breakthroughRowsContainer.addEventListener('input', e => { if (e.target.classList.contains('prn-dose-input')) calculateAndRender(); });
        elements.breakthroughRowsContainer.addEventListener('click', e => { if (e.target.closest('.remove-prn-btn')) { if (elements.breakthroughRowsContainer.children.length > 1) { e.target.closest('.prn-row').remove(); } else { const row = elements.breakthroughRowsContainer.firstElementChild; row.querySelector('select').value = ''; row.querySelector('input').value = ''; row.querySelector('input').placeholder = 'ขนาดยา'; } calculateAndRender(); } });
        elements.clearAllBtn.addEventListener('click', clearAllInputs);
        
        elements.rotateBtn.addEventListener('click', startRotationFlow);
        elements.cancelRotateBtn.addEventListener('click', cancelRotationFlow);
        elements.confirmReductionBtn.addEventListener('click', confirmRotationTarget);
        elements.cancelReductionBtn.addEventListener('click', () => closeModal('guided-reduction-modal'));
        elements.reductionChoiceBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                elements.reductionCustomPercent.value = btn.dataset.percent;
            });
        });
        elements.recalculateMmeBtn.addEventListener('click', toggleFinalMMEConfirmation);

        elements.addRotationBasalBtn.addEventListener('click', () => {
            addRotationBasalRow();
            distributePercentages();
            calculateAndRender();
        });
        elements.rotationBasalRowsContainer.addEventListener('click', e => {
            const removeButton = e.target.closest('.remove-rotation-basal-btn');
            if (removeButton) {
                removeButton.closest('.rotation-basal-row').remove();
                distributePercentages();
                calculateAndRender();
            }
            const lockButton = e.target.closest('.rotation-lock-btn');
            if (lockButton) {
                handleRotationLockClick(lockButton);
            }
        });
        elements.rotationBasalRowsContainer.addEventListener('change', e => {
            if (e.target.classList.contains('rotation-basal-drug')) {
                const row = e.target.closest('.rotation-basal-row');
                const drugKey = e.target.value;
                const config = ROTATION_DRUGS[drugKey];
                const expandable = row.querySelector('.expandable-content');
                
                expandable.querySelectorAll('[class*="helper-content-"]').forEach(el => el.classList.add('hidden'));

                if (config) {
                    let shouldExpand = false;
                    if (config.hasMgDayInput) {
                        const mgDayHelper = expandable.querySelector('.helper-content-mg-day');
                        mgDayHelper.classList.remove('hidden');
                        mgDayHelper.querySelector('.mg-day-unit').textContent = `(${config.unit})`;
                        shouldExpand = true;
                    }
                    if (config.helper) {
                        const helperContent = expandable.querySelector(`.helper-content-${config.helper}`);
                        if (helperContent) {
                            helperContent.classList.remove('hidden');
                            shouldExpand = true;
                        }
                    }
                    expandable.classList.toggle('expanded', shouldExpand);
                } else {
                     expandable.classList.remove('expanded');
                }
            }
            calculateAndRender();
        });
        elements.rotationBasalRowsContainer.addEventListener('input', e => {
             if (e.target.classList.contains('rotation-basal-percent')) {
                const row = e.target.closest('.rotation-basal-row');
                const mgDayInput = row.querySelector('.rotation-mg-day-input');
                if (mgDayInput) mgDayInput.value = ''; // Clear mg/day if percent is changed
                calculateAndRender();
            } else if (e.target.classList.contains('rotation-mg-day-input')) {
                const row = e.target.closest('.rotation-basal-row');
                const drugKey = row.querySelector('.rotation-basal-drug').value;
                const dose = parseFloat(e.target.value) || 0;
                if (drugKey && rotationTargetMME > 0) {
                    const config = ROTATION_DRUGS[drugKey];
                    const mmeForDose = dose * config.factor;
                    const newPercent = (mmeForDose / rotationTargetMME) * 100;
                    row.querySelector('.rotation-basal-percent').value = formatDose(newPercent);
                    calculateAndRender();
                }
            } else if (e.target.classList.contains('helper-input')) {
                calculateAndRender();
            }
        });
        elements.breakthroughCalcDrug.addEventListener('change', () => calculateAndRender());
        elements.breakthroughCalcPercent.addEventListener('change', () => calculateAndRender());

        elements.totalMmeDisplay.addEventListener('click', () => { if (rotationTargetMME === null) { const totalMME = parseFloat(elements.totalMmeDisplay.textContent) || 0; if (totalMME > 0) openQuickRefModal(totalMME); } });
        elements.safetyChecklistBtn.addEventListener('click', () => openModal('safety-modal'));
        
        document.body.addEventListener('click', e => {
            if (e.target.classList.contains('modal-overlay')) {
                e.target.classList.remove('visible');
            }
            if (e.target.closest('.modal-close-btn')) {
                const modalId = e.target.closest('.modal-close-btn').dataset.modalId;
                closeModal(modalId);
            }
        });

        [elements.tddHelperDrugAmount, elements.tddHelperFluidVolume, elements.tddHelperRate].forEach(el => {
            if(el) el.addEventListener('input', calculateTddFromRate)
        });
        
        if(elements.confirmTddHelperBtn) elements.confirmTddHelperBtn.addEventListener('click', applyTddFromHelper);
    }

    initialize();
});
</script>

</body>
</html>
