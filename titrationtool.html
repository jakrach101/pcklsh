<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opioid Equianalgesic Calculator</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f4f8; }
        .input-field, .select-field { width: 100%; border: 1px solid #cbd5e1; border-radius: 0.5rem; padding: 0.75rem; background-color: white; transition: all 0.2s ease-in-out; font-size: 0.95rem; }
        .select-field { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; }
        .input-field.text-right, .select-field.text-right { text-align: right; }
        .input-field::placeholder { color: #94a3b8; opacity: 1; text-align: left; }
        .input-field:focus, .select-field:focus { border-color: #0891b2; box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2); outline: none; }
        .input-field.border-green-500:focus { box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2); }
        .input-field.border-red-500:focus { box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2); }
        .input-field:disabled { background-color: #f8fafc; color: #475569; cursor: not-allowed; }
        .input-field:disabled::placeholder { color: #64748b; font-weight: 600; text-align: right; }
        .action-btn { cursor: pointer; transition: all 0.2s; width: 2.5rem; height: 2.5rem; display: inline-flex; align-items: center; justify-content: center; border-radius: 9999px; }
        .pin-btn { color: #94a3b8; font-size: 1.1rem; }
        .pin-btn:hover { color: #334155; background-color: #e2e8f0; }
        .pin-btn.pinned { color: #0e7490; background-color: #cffafe; }
        .rotate-btn { font-size: 1rem; background-color: #0891b2; color: white; }
        .rotate-btn:hover { background-color: #0e7490; transform: scale(1.05); }
        .utility-btn { background-color: #e2e8f0; color: #475569; font-weight: 600; padding: 0.25rem 0.75rem; border-radius: 0.5rem; border: 1px solid #cbd5e1; transition: all 0.2s; }
        .utility-btn:hover { background-color: #cbd5e1; }
        .utility-btn.active { background-color: #16a34a; color: white; border-color: #16a34a; }
        .utility-btn.decrease.active { background-color: #dc2626; color: white; border-color: #dc2626; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 50; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { position: relative; background-color: white; padding: 1.5rem; border-radius: 0.75rem; width: 90%; max-width: 500px; transform: scale(0.95); transition: transform 0.3s; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-close-btn { position: absolute; top: 0.5rem; right: 0.5rem; width: 2rem; height: 2rem; font-size: 1.5rem; line-height: 1; }
        .history-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg space-y-4">
            
            <!-- Header -->
            <div class="flex flex-wrap justify-between items-center gap-4">
                <h1 class="text-xl sm:text-2xl font-bold text-gray-800">Opioid Equianalgesic Calculator</h1>
                <div class="flex items-center gap-2">
                    <button id="safety-checklist-btn" class="bg-yellow-100 text-yellow-800 hover:bg-yellow-200 font-semibold py-2 px-3 sm:px-4 rounded-lg transition-colors text-sm flex items-center gap-2">
                        <i class="fas fa-check-circle"></i>
                        <span>Clinical Pearls / Safety</span>
                    </button>
                    <button id="clear-all-btn" class="bg-red-100 text-red-700 hover:bg-red-200 font-semibold py-2 px-3 sm:px-4 rounded-lg transition-colors text-sm flex items-center gap-2">
                        <i class="fas fa-trash"></i>
                        <span>ล้างข้อมูล</span>
                    </button>
                </div>
            </div>
            
            <!-- Medication Inputs -->
            <div id="medication-section" class="space-y-2">
                <!-- Medication rows will be injected here -->
            </div>

            <!-- Dose Titration Tool -->
            <div id="titration-tool-container" class="bg-slate-50 p-3 rounded-lg border border-slate-200 space-y-3">
                 <div class="flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <label class="block text-sm font-medium text-gray-600">Dose Titration Tool</label>
                        <div id="history-controls" class="hidden">
                            <button id="undo-btn" class="action-btn history-btn text-gray-500 hover:bg-gray-200 w-6 h-6" title="Undo">
                                <i class="fas fa-undo text-xs"></i>
                            </button>
                            <button id="redo-btn" class="action-btn history-btn text-gray-500 hover:bg-gray-200 w-6 h-6" title="Redo">
                                <i class="fas fa-redo text-xs"></i>
                            </button>
                        </div>
                        <span id="titration-target-display" class="text-xs font-semibold text-cyan-700 ml-2"></span>
                    </div>
                    <div id="titration-mode-toggle" class="flex border border-slate-300 rounded-lg p-0.5 text-sm">
                        <button class="utility-btn titration-mode-btn" data-mode="prn">จากยาบรรเทาอาการ (Breakthrough)</button>
                        <button class="utility-btn titration-mode-btn" data-mode="percent">จาก %</button>
                    </div>
                 </div>
                 <div id="prn-titration-section" class="space-y-2">
                    <div id="breakthrough-rows-container"></div>
                    <button id="add-breakthrough-btn" class="text-cyan-700 hover:text-cyan-900 font-semibold text-sm flex items-center gap-2">
                        <i class="fas fa-plus-circle"></i>
                        <span>+ Add Breakthrough Opioid</span>
                    </button>
                 </div>
                 <div id="percent-titration-section" class="hidden">
                    <div class="flex items-center justify-center gap-2 flex-wrap">
                        <button class="utility-btn percent-adjust-btn decrease" data-percent="-50">-50%</button>
                        <button class="utility-btn percent-adjust-btn decrease" data-percent="-25">-25%</button>
                        <button class="utility-btn percent-adjust-btn" data-percent="0">0%</button>
                        <button class="utility-btn percent-adjust-btn increase" data-percent="30">+30%</button>
                        <button class="utility-btn percent-adjust-btn increase" data-percent="50">+50%</button>
                        <input type="number" id="custom-percent-input" class="input-field w-24 text-center" placeholder="... %">
                    </div>
                 </div>
            </div>
            
            <!-- Total MME Display -->
            <div id="total-mme-box" class="bg-cyan-50 border border-cyan-200 p-4 rounded-lg mt-4 transition-all duration-300">
                <div id="total-mme-normal-view">
                    <div class="flex justify-between items-center">
                        <h2 class="text-lg font-semibold text-cyan-800">Current Total MME/day</h2>
                        <div class="flex items-center gap-3">
                            <p id="total-mme-display" class="text-4xl font-bold text-cyan-900 tracking-tight cursor-pointer" title="คลิกเพื่อดู Quick Reference เทียบเท่ายาตัวอื่น">0</p>
                            <button id="rotate-btn" class="action-btn rotate-btn hidden" title="Rotate from this Total MME/day">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    <p id="empty-state-message" class="text-center text-gray-500 mt-2">กรอกขนาดยาเพื่อเริ่มคำนวณ</p>
                </div>
                <div id="total-mme-rotation-view" class="hidden text-center">
                    <div class="flex justify-center items-center mb-2">
                         <h2 class="text-lg font-semibold text-red-800">Opioid Rotation Mode</h2>
                         <button id="cancel-rotate-btn" class="action-btn ml-4 bg-red-100 hover:bg-red-200" title="ยกเลิกการหมุนเวียนยา">
                            <i class="fas fa-times text-red-700"></i>
                        </button>
                    </div>
                    <div id="rotation-adjustment-display" class="text-gray-600">
                        <!-- Content generated by JS -->
                    </div>
                </div>
            </div>

            <!-- Rotation Tools -->
            <div id="rotation-tools" class="hidden space-y-4 bg-green-50 p-4 rounded-lg border border-green-200">
                <div class="flex justify-between items-center">
                    <h3 class="font-semibold text-green-800 text-lg">Opioid Rotation Tool</h3>
                    <div id="rotation-mme-ref" class="text-right"></div>
                </div>
                <div id="basal-recommendation" class="bg-white p-3 rounded-lg shadow-sm border">
                    <div class="flex justify-between items-center flex-wrap gap-2">
                         <label class="font-semibold text-gray-700">ยาควบคุมอาการหลัก (Basal Dose)</label>
                         <div class="flex items-center gap-2">
                            <select id="basal-calc-drug" class="select-field text-sm p-1 w-48"></select>
                            <button id="basal-helper-btn" class="action-btn text-cyan-700 hover:bg-cyan-100 hidden" title="เครื่องมือช่วยคำนวณ">
                                <i class="fas fa-calculator"></i>
                            </button>
                         </div>
                    </div>
                    <div id="basal-recommendation-text" class="text-base text-green-800 font-bold mt-2 p-3 bg-green-50 rounded-md text-center"></div>
                </div>
                <div id="breakthrough-recommendation" class="bg-white p-3 rounded-lg shadow-sm border">
                    <div class="flex justify-between items-center flex-wrap gap-2">
                         <label class="font-semibold text-gray-700">ยาบรรเทาอาการ (Breakthrough Dose)</label>
                         <div class="flex items-center gap-2">
                            <select id="breakthrough-calc-drug" class="select-field text-sm p-1 w-48"></select>
                            <select id="breakthrough-calc-percent" class="select-field text-sm p-1 w-24">
                                <option value="0.1667">1/6 (16.7%)</option>
                                <option value="0.15">15%</option>
                                <option value="0.1">10%</option>
                            </select>
                         </div>
                    </div>
                    <p id="breakthrough-recommendation-text" class="text-lg text-green-800 font-bold mt-2 p-3 bg-green-50 rounded-md text-center"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="csci-modal" class="modal-overlay">
        <div class="modal-content space-y-4">
            <button id="cancel-csci-modal-btn" class="action-btn modal-close-btn text-gray-500 hover:bg-gray-200">&times;</button>
            <h3 class="text-lg font-bold text-gray-800">CSCI (Syringe Driver) Helper</h3>
            <div class="bg-gray-50 p-3 rounded-lg">
                <p class="text-sm font-medium text-gray-500">ยาที่คำนวณ</p>
                <p id="csci-drug-name" class="text-lg font-bold text-cyan-700 mb-2"></p>
                <div class="flex justify-between items-center">
                    <label for="csci-total-dose-input" class="block text-sm font-medium text-gray-500">ขนาดยา / 24 ชม. (<span id="csci-dose-unit"></span>)</label>
                    <button id="csci-reset-dose-btn" class="action-btn text-gray-500 hover:bg-gray-200 w-6 h-6" title="รีเซ็ต Dose กลับค่าเดิม">
                        <i class="fas fa-undo text-xs"></i>
                    </button>
                </div>
                <input type="number" id="csci-total-dose-input" class="input-field mt-1 text-lg font-bold text-cyan-700">
                <p id="csci-new-mme" class="text-xs text-center text-gray-500 mt-1 h-4"></p>
            </div>
            <div class="space-y-3">
                <div>
                    <label for="csci-syringe-size" class="block text-sm font-medium text-gray-700">เลือกขนาด Syringe (BD Luer-Lok)</label>
                    <select id="csci-syringe-size" class="select-field mt-1">
                        <option value="30">30 ml</option>
                        <option value="20">20 ml</option>
                        <option value="50">50 ml</option>
                    </select>
                </div>
                <div>
                    <label for="csci-total-volume" class="block text-sm font-medium text-gray-700">ปริมาตรรวมที่ต้องการใน Syringe (ml)</label>
                    <input type="number" id="csci-total-volume" class="input-field mt-1" placeholder="เช่น 22, 24, 48">
                </div>
            </div>
            <div id="csci-result-wrapper">
                <div id="csci-error" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-3 rounded-md hidden"><p id="csci-error-text"></p></div>
                <div id="csci-result" class="bg-blue-50 p-3 rounded-lg border border-blue-200 space-y-2 hidden">
                    <p class="font-semibold">ผลการคำนวณ:</p>
                    <div class="grid grid-cols-3 gap-2 text-sm text-center">
                        <div><span class="font-medium block">ปริมาณยา</span><strong id="csci-drug-volume" class="text-blue-800"></strong></div>
                        <div><span class="font-medium block">เติม NSS</span><strong id="csci-diluent-volume" class="text-blue-800"></strong></div>
                        <div><span class="font-medium block">Rate (ml/hr)</span><strong id="csci-rate-ml" class="text-blue-800"></strong></div>
                    </div>
                    <div class="text-center mt-2"><span class="font-medium">Rate (mm/hr)</span><strong id="csci-rate-mm" class="text-blue-800 text-lg ml-2"></strong></div>
                    <div class="mt-2 pt-2 border-t border-blue-200">
                        <p class="font-semibold">ตัวอย่างการสั่งยา:</p>
                        <p id="csci-order-text" class="text-sm text-gray-700 bg-gray-100 p-2 rounded"></p>
                    </div>
                </div>
            </div>
            <button id="close-csci-modal-btn" class="w-full bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">ยืนยันและใช้ค่านี้</button>
        </div>
    </div>

    <div id="iv-infusion-modal" class="modal-overlay">
        <div class="modal-content space-y-4">
            <button id="cancel-iv-modal-btn" class="action-btn modal-close-btn text-gray-500 hover:bg-gray-200">&times;</button>
            <h3 class="text-lg font-bold text-gray-800">IV Infusion Helper</h3>
            <div class="bg-gray-50 p-3 rounded-lg">
                <p class="text-sm font-medium text-gray-500">ยาที่คำนวณ</p>
                <p id="iv-drug-name" class="text-lg font-bold text-cyan-700 mb-2"></p>
                <div class="flex justify-between items-center">
                    <label for="iv-total-dose-input" class="block text-sm font-medium text-gray-500">ขนาดยา / 24 ชม. (<span id="iv-dose-unit"></span>)</label>
                     <button id="iv-reset-dose-btn" class="action-btn text-gray-500 hover:bg-gray-200 w-6 h-6" title="รีเซ็ต Dose กลับค่าเดิม">
                        <i class="fas fa-undo text-xs"></i>
                    </button>
                </div>
                <input type="number" id="iv-total-dose-input" class="input-field mt-1 text-lg font-bold text-cyan-700">
                <p id="iv-new-mme" class="text-xs text-center text-gray-500 mt-1 h-4"></p>
            </div>
             <div>
                <label for="iv-fluid-volume" class="block text-sm font-medium text-gray-700">ปริมาตรสารน้ำในถุง (ml)</label>
                <input type="number" id="iv-fluid-volume" class="input-field mt-1" value="100">
            </div>
            <div id="iv-result-wrapper">
                <div id="iv-error" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-3 rounded-md hidden"><p id="iv-error-text"></p></div>
                <div id="iv-result" class="bg-blue-50 p-3 rounded-lg border border-blue-200 space-y-2 hidden">
                    <p class="font-semibold">ผลการคำนวณ:</p>
                    <div class="grid grid-cols-2 gap-2 text-sm text-center">
                        <div><span class="font-medium block">ความเข้มข้น</span><strong id="iv-concentration" class="text-blue-800"></strong></div>
                        <div><span class="font-medium block">Dose/hr</span><strong id="iv-dose-hr" class="text-blue-800"></strong></div>
                    </div>
                    <div class="mt-2 pt-2 border-t border-blue-200">
                        <p class="font-semibold">ตัวอย่างการสั่งยา:</p>
                        <p id="iv-order-text" class="text-sm text-gray-700 bg-gray-100 p-2 rounded"></p>
                    </div>
                </div>
            </div>
            <button id="close-iv-infusion-modal-btn" class="w-full bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">ยืนยันและใช้ค่านี้</button>
        </div>
    </div>

    <div id="safety-modal" class="modal-overlay">
        <div class="modal-content space-y-4">
            <button id="close-safety-modal-btn" class="action-btn modal-close-btn text-gray-500 hover:bg-gray-200">&times;</button>
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-bold text-yellow-800 flex items-center gap-2"><i class="fas fa-check-circle"></i> Clinical Pearls / Safety</h3>
            </div>
            <ul class="list-disc list-inside space-y-2 text-gray-700">
                <li><strong>การประเมินผู้ป่วย:</strong> อายุ, การทำงานของไตและตับ, ภาวะสับสน (Delirium), ประวัติการใช้ Opioids (Opioid-naïve vs. Opioid-tolerant)</li>
                <li><strong>ยาที่ใช้ร่วมกัน:</strong> โดยเฉพาะกลุ่มยานอนหลับ (Benzodiazepines) หรือยากันชัก (Gabapentinoids) ที่เพิ่มความเสี่ยงต่อการกดการหายใจ</li>
                <li><strong>Incomplete Cross-Tolerance:</strong> พิจารณาลดยา 25-50% เมื่อทำการหมุนเวียนยา (Opioid Rotation) โดยเฉพาะในผู้ป่วยสูงอายุ, ไต/ตับบกพร่อง, หรืออาการคงที่แล้ว</li>
                 <li><strong>เป้าหมายการรักษา:</strong> ตั้งเป้าหมาย (Goal of Care) ร่วมกับผู้ป่วยและครอบครัวเสมอ</li>
            </ul>
            <div class="mt-4 pt-4 border-t border-yellow-200">
                <h4 class="font-semibold text-yellow-900 mb-2">รายการยา Opioid ในโรงพยาบาล (Formulary)</h4>
                <ul class="list-disc list-inside space-y-1 text-sm text-gray-600">
                    <li>MST (10mg, 30mg)</li>
                    <li>Kapanol (20mg)</li>
                    <li>Morphine injection 10mg/ampule</li>
                    <li>Fentanyl patch (25mcg/hr)</li>
                    <li>Fentanyl injection 100mcg/ampule</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Quick Reference Modal -->
    <div id="quick-ref-modal" class="modal-overlay">
        <div class="modal-content space-y-4">
            <button id="close-quick-ref-modal-btn" class="action-btn modal-close-btn text-gray-500 hover:bg-gray-200">&times;</button>
            <h3 class="text-lg font-bold text-gray-800">Total MME Quick Reference</h3>
            <div class="bg-gray-50 p-3 rounded-lg text-center">
                <p class="text-sm font-medium text-gray-500">Total MME/day</p>
                <p id="quick-ref-mme-total" class="text-2xl font-bold text-cyan-700"></p>
            </div>
            <div id="quick-ref-list" class="space-y-2">
                <!-- Equivalent doses will be injected here by JS -->
            </div>
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- CONFIGURATION ---
    const DRUG_CONFIG = {
        'fentanyl_patch': { name: 'Fentanyl Patch (mcg/hr)', factor: 2.4, unit: 'mcg/hr', type: 'patch', isBasal: true },
        'mst_10': { name: 'MST (10mg/tab)', factor: 1, unit: 'เม็ด/day', type: 'oral', isBasal: true, strength: 10 },
        'mst_30': { name: 'MST (30mg/tab)', factor: 1, unit: 'เม็ด/day', type: 'oral', isBasal: true, strength: 30 },
        'kapanol_20': { name: 'Kapanol (20mg/cap)', factor: 1, unit: 'แคปซูล/day', type: 'oral', isBasal: true, strength: 20 },
        'morphine_iv_sc': { name: 'Morphine IV/SC (mg/day)', factor: 3, unit: 'mg/day', type: 'injectable', isBasal: true, isBreakthrough: true },
        'fentanyl_iv_sc': { name: 'Fentanyl IV/SC (mcg/day)', factor: 0.3, unit: 'mcg/day', type: 'injectable', isBasal: true, isBreakthrough: true },
        'morphine_ir_tab_10': { name: 'Morphine IR (10mg/tab)', factor: 1, unit: 'เม็ด/day', type: 'oral', isBreakthrough: true, strength: 10 },
        'morphine_syrup': { name: 'Morphine Syrup (2mg/ml)', factor: 1, unit: 'mL/day', type: 'oral', isBreakthrough: true, strength: 2 },
    };

    const ROTATION_DRUGS = {
        'fentanyl_patch': { name: 'Fentanyl Patch', factor: 2.4, unit: 'mcg/hr', allowedDoses: [12.5, 25, 50, 75, 100] },
        'morphine_sr': { name: 'Morphine SR', factor: 1, unit: 'mg/day' },
        'morphine_iv_infusion': { name: 'Morphine (IV Infusion)', factor: 3, unit: 'mg/day', helper: 'iv_infusion', drugInfo: { name: 'Morphine', concentration: 10, unit: 'mg/ml' } },
        'fentanyl_iv_infusion': { name: 'Fentanyl (IV Infusion)', factor: 0.3, unit: 'mcg/day', helper: 'iv_infusion', drugInfo: { name: 'Fentanyl', concentration: 50, unit: 'mcg/ml' } },
        'morphine_csci': { name: 'Morphine (CSCI)', factor: 3, unit: 'mg/day', helper: 'csci', drugInfo: { name: 'Morphine', concentration: 10, unit: 'mg/ml' } },
        'fentanyl_csci': { name: 'Fentanyl (CSCI)', factor: 0.3, unit: 'mcg/day', helper: 'csci', drugInfo: { name: 'Fentanyl', concentration: 50, unit: 'mcg/ml' } },
    };

    const SYRINGE_DATA = { 'BD': { 20: { length: 88.0 }, 30: { length: 87.5 }, 50: { length: 123.0 } } };
    const LOCAL_STORAGE_KEY = 'opioidCalculatorDataV32'; // Updated version key

    // --- STATE ---
    let pinnedDrugKey = null;
    let rotationMME = null; 
    let titrationMode = 'prn';
    let percentAdjustment = 0;
    let prnCount = 0;
    let rotationDoseInfo = { drugKey: '', dose: 0, helperResult: null, originalDose: 0 };
    let history = {
        states: [0],
        currentIndex: 0
    };

    // --- DOM ELEMENTS ---
    const elements = {
        medSection: document.getElementById('medication-section'),
        titrationToolContainer: document.getElementById('titration-tool-container'),
        titrationModeToggle: document.getElementById('titration-mode-toggle'),
        titrationTargetDisplay: document.getElementById('titration-target-display'),
        historyControls: document.getElementById('history-controls'),
        undoBtn: document.getElementById('undo-btn'),
        redoBtn: document.getElementById('redo-btn'),
        prnTitrationSection: document.getElementById('prn-titration-section'),
        percentTitrationSection: document.getElementById('percent-titration-section'),
        breakthroughRowsContainer: document.getElementById('breakthrough-rows-container'),
        addBreakthroughBtn: document.getElementById('add-breakthrough-btn'),
        totalMmeBox: document.getElementById('total-mme-box'),
        totalMmeNormalView: document.getElementById('total-mme-normal-view'),
        totalMmeRotationView: document.getElementById('total-mme-rotation-view'),
        totalMmeDisplay: document.getElementById('total-mme-display'),
        rotationMmeRef: document.getElementById('rotation-mme-ref'),
        rotationAdjustmentDisplay: document.getElementById('rotation-adjustment-display'),
        emptyStateMessage: document.getElementById('empty-state-message'),
        clearAllBtn: document.getElementById('clear-all-btn'),
        rotateBtn: document.getElementById('rotate-btn'),
        cancelRotateBtn: document.getElementById('cancel-rotate-btn'),
        rotationTools: document.getElementById('rotation-tools'),
        basalRecommendation: document.getElementById('basal-recommendation'),
        basalCalcDrug: document.getElementById('basal-calc-drug'),
        basalRecommendationText: document.getElementById('basal-recommendation-text'),
        basalHelperBtn: document.getElementById('basal-helper-btn'),
        breakthroughRecommendation: document.getElementById('breakthrough-recommendation'),
        safetyChecklistBtn: document.getElementById('safety-checklist-btn'),
        safetyModal: document.getElementById('safety-modal'),
        closeSafetyModalBtn: document.getElementById('close-safety-modal-btn'),
        customPercentInput: document.getElementById('custom-percent-input'),
        breakthroughCalcDrug: document.getElementById('breakthrough-calc-drug'),
        breakthroughCalcPercent: document.getElementById('breakthrough-calc-percent'),
        breakthroughRecommendationText: document.getElementById('breakthrough-recommendation-text'),
        // CSCI Modal
        csciModal: document.getElementById('csci-modal'), closeCsciModalBtn: document.getElementById('close-csci-modal-btn'), cancelCsciModalBtn: document.getElementById('cancel-csci-modal-btn'), csciDrugName: document.getElementById('csci-drug-name'), csciTotalDoseInput: document.getElementById('csci-total-dose-input'), csciDoseUnit: document.getElementById('csci-dose-unit'), csciNewMme: document.getElementById('csci-new-mme'), csciSyringeSize: document.getElementById('csci-syringe-size'), csciTotalVolume: document.getElementById('csci-total-volume'), csciResultWrapper: document.getElementById('csci-result-wrapper'), csciError: document.getElementById('csci-error'), csciErrorText: document.getElementById('csci-error-text'), csciResult: document.getElementById('csci-result'), csciDrugVolume: document.getElementById('csci-drug-volume'), csciDiluentVolume: document.getElementById('csci-diluent-volume'), csciRateMl: document.getElementById('csci-rate-ml'), csciRateMm: document.getElementById('csci-rate-mm'), csciOrderText: document.getElementById('csci-order-text'), csciResetDoseBtn: document.getElementById('csci-reset-dose-btn'),
        // IV Infusion Modal
        ivInfusionModal: document.getElementById('iv-infusion-modal'), closeIvInfusionModalBtn: document.getElementById('close-iv-infusion-modal-btn'), cancelIvModalBtn: document.getElementById('cancel-iv-modal-btn'), ivDrugName: document.getElementById('iv-drug-name'), ivTotalDoseInput: document.getElementById('iv-total-dose-input'), ivDoseUnit: document.getElementById('iv-dose-unit'), ivNewMme: document.getElementById('iv-new-mme'), ivFluidVolume: document.getElementById('iv-fluid-volume'), ivError: document.getElementById('iv-error'), ivErrorText: document.getElementById('iv-error-text'), ivResult: document.getElementById('iv-result'), ivConcentration: document.getElementById('iv-concentration'), ivDoseHr: document.getElementById('iv-dose-hr'), ivOrderText: document.getElementById('iv-order-text'), ivResetDoseBtn: document.getElementById('iv-reset-dose-btn'),
        // Quick Reference Modal
        quickRefModal: document.getElementById('quick-ref-modal'),
        closeQuickRefModalBtn: document.getElementById('close-quick-ref-modal-btn'),
        quickRefMmeTotal: document.getElementById('quick-ref-mme-total'),
        quickRefList: document.getElementById('quick-ref-list'),
    };

    function initialize() {
        createMedicationInputs();
        populateDropdowns();
        setupEventListeners();
        loadFromLocalStorage();
    }

    function createMedicationInputs() {
        elements.medSection.innerHTML = ''; 
        Object.keys(DRUG_CONFIG).forEach(key => {
            const config = DRUG_CONFIG[key];
            if (!config.isBasal) return;
            const mgDayDisplay = config.strength ? `<span id="mg-day-${key}" class="text-xs text-gray-500 w-24 text-right pr-1"></span>` : `<span class="w-24"></span>`;
            let inputControl = `<input type="number" inputmode="decimal" id="dose-${key}" data-key="${key}" class="input-field base-drug-input text-right" placeholder="0" ${key === 'fentanyl_patch' ? 'step="12.5"' : ''}>`;
            const inputHtml = `
                <div class="drug-row flex flex-wrap items-center justify-between gap-y-2 gap-x-3 p-2 border-b border-gray-100 last:border-b-0" data-row-key="${key}">
                    <label for="dose-${key}" class="w-full sm:w-auto sm:flex-1 font-medium text-gray-700">${config.name}</label>
                    <div class="flex items-center gap-x-2 flex-grow sm:flex-grow-0">
                        <div class="relative flex-grow sm:w-32">${inputControl}</div>
                        <span class="text-gray-500 text-sm w-20 text-left">${config.unit}</span>
                        <span id="dose-change-${key}" class="text-sm ml-2 w-28 text-left"></span>
                    </div>
                    <div class="flex items-center justify-end gap-x-2 w-full sm:w-auto mt-2 sm:mt-0">
                        ${mgDayDisplay}
                        <span class="font-semibold text-cyan-700 w-24 text-right">MME: <span id="mme-${key}">0</span></span>
                        <button class="action-btn pin-btn" data-key="${key}" title="ปักหมุดเพื่อเป็นเป้าหมายในการปรับยา"><i class="fas fa-thumbtack"></i></button>
                    </div>
                </div>`;
            elements.medSection.insertAdjacentHTML('beforeend', inputHtml);
        });
    }
    
    function addBreakthroughRow(data = {key: '', dose: ''}) {
        prnCount++;
        const newRow = document.createElement('div');
        newRow.className = 'grid grid-cols-12 gap-3 items-center prn-row';
        newRow.innerHTML = `<div class="col-span-7 sm:col-span-6"><select class="select-field w-full prn-drug-select" data-id="${prnCount}"></select></div><div class="col-span-5 sm:col-span-3"><input type="number" class="input-field w-full prn-dose-input text-right" placeholder="0" data-id="${prnCount}"></div><div class="col-span-10 sm:col-span-2"><span class="text-gray-500 text-sm prn-dose-unit" data-id="${prnCount}">-- หน่วย --</span></div><div class="col-span-2 sm:col-span-1"><button class="action-btn text-red-500 hover:bg-red-100 remove-prn-btn"><i class="fas fa-trash-alt"></i></button></div>`;
        const select = newRow.querySelector('.prn-drug-select');
        select.innerHTML = '<option value="">-- เลือกยา --</option>';
        Object.keys(DRUG_CONFIG).forEach(key => {
            if (DRUG_CONFIG[key].isBreakthrough) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = DRUG_CONFIG[key].name;
                select.appendChild(option);
            }
        });
        elements.breakthroughRowsContainer.appendChild(newRow);
        if(data.key) {
            newRow.querySelector('.prn-drug-select').value = data.key;
            newRow.querySelector('.prn-dose-input').value = data.dose;
            const unitEl = newRow.querySelector('.prn-dose-unit');
            unitEl.textContent = DRUG_CONFIG[data.key]?.unit || '-- หน่วย --';
        }
    }

    function populateDropdowns() {
        elements.breakthroughCalcDrug.innerHTML = '';
        Object.keys(DRUG_CONFIG).forEach(key => {
            if (DRUG_CONFIG[key].isBreakthrough) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = DRUG_CONFIG[key].name;
                elements.breakthroughCalcDrug.appendChild(option);
            }
        });
        elements.basalCalcDrug.innerHTML = '';
        Object.keys(ROTATION_DRUGS).forEach(key => {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = ROTATION_DRUGS[key].name;
            elements.basalCalcDrug.appendChild(option);
        });
    }

    function calculateAndRender() {
        let totalMME = 0;
        let hasInput = false;

        // --- Clear dynamic displays ---
        document.querySelectorAll('.drug-row.pinned-row, .pin-btn.pinned').forEach(el => el.classList.remove('pinned-row', 'pinned'));
        document.querySelectorAll('[id^="dose-change-"]').forEach(el => el.innerHTML = '');
        elements.titrationTargetDisplay.textContent = '';


        // --- Pinning Visuals ---
        if (pinnedDrugKey) {
            document.querySelector(`.drug-row[data-row-key="${pinnedDrugKey}"]`)?.classList.add('pinned-row');
            document.querySelector(`.pin-btn[data-key="${pinnedDrugKey}"]`)?.classList.add('pinned');
            if (titrationMode === 'percent') {
                 elements.titrationTargetDisplay.textContent = `Titrating: ${DRUG_CONFIG[pinnedDrugKey].name}`;
            }
        }

        // --- Base MME Calculation (from user input only) ---
        let baseMME = 0;
        document.querySelectorAll('.drug-row').forEach(row => {
            const key = row.dataset.rowKey;
            const input = document.getElementById(`dose-${key}`);
            const config = DRUG_CONFIG[key];
            let individualMme = 0;

            const userDose = parseFloat(input.value);
            if (!isNaN(userDose) && userDose > 0) {
                hasInput = true;
                const doseForCalc = userDose * (config.strength || 1);
                individualMme = doseForCalc * config.factor;
            }
            
            document.getElementById(`mme-${key}`).textContent = Math.round(individualMme);
            baseMME += individualMme;

            // Update mg/day display
            const mgDaySpan = document.getElementById(`mg-day-${key}`);
            if (mgDaySpan) {
                if (config.strength && !isNaN(userDose) && userDose > 0) {
                    const mgPerDay = userDose * config.strength;
                    mgDaySpan.textContent = `(${mgPerDay.toFixed(0)} mg)`;
                } else {
                    mgDaySpan.textContent = '';
                }
            }
        });


        // --- Titration Calculation ---
        let titrationMME = 0;
        if (titrationMode === 'prn') {
            document.querySelectorAll('.prn-row').forEach(row => {
                const key = row.querySelector('.prn-drug-select').value;
                const dose = parseFloat(row.querySelector('.prn-dose-input').value) || 0;
                if (dose > 0 && key && DRUG_CONFIG[key]) {
                    hasInput = true;
                    const config = DRUG_CONFIG[key];
                    const doseForCalc = dose * (config.strength || 1);
                    titrationMME += doseForCalc * config.factor;
                }
            });
        } else if (titrationMode === 'percent' && percentAdjustment !== 0 && rotationMME === null) {
            let baseForTitration = baseMME;
            
            if (pinnedDrugKey) {
                const pinnedInput = document.getElementById(`dose-${pinnedDrugKey}`);
                const pinnedConfig = DRUG_CONFIG[pinnedDrugKey];
                const pinnedDose = parseFloat(pinnedInput.value) || 0;
                baseForTitration = 0;
                if (pinnedDose > 0) {
                    baseForTitration = (pinnedDose * (pinnedConfig.strength || 1)) * pinnedConfig.factor;
                    const newDose = pinnedDose * (1 + percentAdjustment / 100);
                    const indicator = document.getElementById(`dose-change-${pinnedDrugKey}`);
                    const color = percentAdjustment > 0 ? 'text-green-600' : 'text-red-600';
                    indicator.innerHTML = `<span class="${color}">${pinnedDose.toFixed(1)} &rarr; ${newDose.toFixed(1)}</span>`;
                }
            } else { // Apply to all if no pin
                document.querySelectorAll('.drug-row').forEach(row => {
                    const key = row.dataset.rowKey;
                    const input = document.getElementById(`dose-${key}`);
                    const originalDose = parseFloat(input.value) || 0;
                    if (originalDose > 0) {
                        const newDose = originalDose * (1 + percentAdjustment / 100);
                        const indicator = document.getElementById(`dose-change-${key}`);
                        const color = percentAdjustment > 0 ? 'text-green-600' : 'text-red-600';
                        indicator.innerHTML = `<span class="${color}">${originalDose.toFixed(1)} &rarr; ${newDose.toFixed(1)}</span>`;
                    }
                });
            }
            titrationMME = baseForTitration * (percentAdjustment / 100);
        }
        
        totalMME = baseMME + titrationMME;

        // --- Rotation Logic ---
        if (rotationMME !== null) {
            const adjustedMME = rotationMME * (1 + (percentAdjustment / 100));
            elements.totalMmeNormalView.classList.add('hidden');
            elements.totalMmeRotationView.classList.remove('hidden');
            elements.historyControls.classList.remove('hidden');
            elements.titrationToolContainer.classList.remove('hidden');
            
            elements.rotationMmeRef.innerHTML = `อ้างอิงจาก <strong class="text-gray-800">${rotationMME.toFixed(0)} MME/day</strong>`;
            
            if (percentAdjustment !== 0) {
                const arrow = percentAdjustment > 0 ? '▲' : '▼';
                const color = percentAdjustment > 0 ? 'text-green-600' : 'text-red-600';
                elements.rotationAdjustmentDisplay.innerHTML = `เป้าหมายใหม่: <strong class="text-xl text-cyan-900">${Math.round(adjustedMME)}</strong> MME/day <span class="text-sm ${color}">(${arrow} ${percentAdjustment > 0 ? '+' : ''}${percentAdjustment.toFixed(1)}%)</span>`;
            } else {
                elements.rotationAdjustmentDisplay.innerHTML = `เป้าหมาย: <strong class="text-xl text-cyan-900">${rotationMME.toFixed(0)}</strong> MME/day`;
            }

            elements.rotationTools.classList.remove('hidden');
            updateBasalRecommendation(adjustedMME);
            updateBreakthroughRecommendation(adjustedMME);
            document.querySelectorAll('.base-drug-input').forEach(input => input.disabled = true);
            totalMME = adjustedMME;
        } else {
            elements.totalMmeNormalView.classList.remove('hidden');
            elements.totalMmeRotationView.classList.add('hidden');
            elements.rotationTools.classList.add('hidden');
        }
        
        // --- Final Render ---
        elements.totalMmeDisplay.textContent = Math.round(totalMME);
        elements.emptyStateMessage.style.display = hasInput || rotationMME !== null ? 'none' : 'block';
        elements.rotateBtn.classList.toggle('hidden', totalMME <= 0 || rotationMME !== null);

        saveToLocalStorage();
    }

    function updateBasalRecommendation(currentMME) {
        const key = elements.basalCalcDrug.value;
        const config = ROTATION_DRUGS[key];
        elements.basalHelperBtn.classList.toggle('hidden', !config.helper);

        if (!key || !currentMME) {
            elements.basalRecommendationText.innerHTML = '';
            return;
        }
        
        const equivalentDose = currentMME / config.factor;
        
        if (rotationDoseInfo.drugKey !== key || Math.abs(rotationDoseInfo.originalDose - equivalentDose) > 0.01) {
             rotationDoseInfo = { drugKey: key, dose: equivalentDose, originalDose: equivalentDose, helperResult: null };
        }
        
        let recommendationText = '';

        if (rotationDoseInfo.helperResult) {
            recommendationText = rotationDoseInfo.helperResult;
        } else if (key === 'morphine_sr') {
            const dosePerDay = Math.round(equivalentDose);
            const strengths = [30, 20, 10]; // Formulary: MST 10, 30; Kapanol 20
            let remainingDose = dosePerDay;
            
            const prescriptionItems = strengths.map(s => {
                const numUnits = Math.floor(remainingDose / s);
                if (numUnits > 0) {
                    remainingDose %= s;
                    const drugName = (s === 20) ? `Kapanol ${s}mg` : `MST ${s}mg`;
                    const unitName = (s === 20) ? 'แคปซูล' : 'เม็ด';
                    return `<li><span class="font-medium">${drugName}:</span> ${numUnits} ${unitName}</li>`;
                }
                return null;
            }).filter(Boolean);

            if (prescriptionItems.length > 0) {
                 recommendationText = `
                    <div class="text-left w-full">
                        <p class="text-xl font-bold text-green-900">${dosePerDay} mg/day</p>
                        <ul class="list-disc list-inside mt-2 text-sm text-gray-700 space-y-1 pl-2">
                            ${prescriptionItems.join('')}
                        </ul>
                        <p class="text-xs text-gray-500 mt-2">รับประทานวันละครั้ง (once daily) หรือแบ่งให้ตามความเหมาะสม</p>
                    </div>`;
            } else {
                 recommendationText = `<p class="text-xl">${dosePerDay} mg/day</p><p class="text-sm text-gray-600 mt-1 font-normal">ไม่มียาเม็ด/แคปซูลที่เหมาะสม</p>`;
            }
        } else if (key === 'fentanyl_patch') {
             const doseMcgHr = Math.round(equivalentDose / 12.5) * 12.5;
             recommendationText = `<div class="w-full"><p class="text-xl">${doseMcgHr} mcg/hr</p><p class="text-sm text-gray-600 mt-1 font-normal">Fentanyl ${doseMcgHr} mcg/hr patch, apply and change every 72 hours.</p></div>`;
        } else {
             recommendationText = `<p class="text-xl">${Math.round(equivalentDose)} ${config.unit.split('/')[0]}</p>`;
        }
        elements.basalRecommendationText.innerHTML = recommendationText;
    }
    
    function updateBreakthroughRecommendation(currentMME) {
        const key = elements.breakthroughCalcDrug.value;
        const percent = parseFloat(elements.breakthroughCalcPercent.value);
        if(!key || !percent || !currentMME) {
            elements.breakthroughRecommendationText.innerHTML = ''; return;
        };

        const breakthroughMME = currentMME * percent;
        const config = DRUG_CONFIG[key];
        const doseInMg_raw = breakthroughMME / config.factor;
        let recommendationText = '';

        if (config.strength) {
            const doseInUnit_raw = doseInMg_raw / config.strength;
            const finalDose = Math.floor(doseInUnit_raw);
            if (finalDose > 0) {
                recommendationText = `<strong>${finalDose} ${config.unit.split('/')[0]}</strong> <span class="text-sm text-gray-500 font-normal">(~${doseInMg_raw.toFixed(1)} mg)</span> q 4-6h PRN`;
            } else {
                recommendationText = `<span class="text-sm text-gray-500 font-normal">ขนาดยาน้อยเกินไป</span>`;
            }
        } else { 
            const finalDose = Math.floor(doseInMg_raw);
            if (finalDose > 0) {
                recommendationText = `<strong>${finalDose} ${config.unit.split('/')[0]}</strong> q 4-6h PRN`;
            } else {
                recommendationText = `<span class="text-sm text-gray-500 font-normal">ขนาดยาน้อยเกินไป</span>`;
            }
        }
        elements.breakthroughRecommendationText.innerHTML = recommendationText;
    }
    
    function handleRotateClick() {
        const isEnteringRotation = rotationMME === null;
        rotationMME = isEnteringRotation ? parseFloat(elements.totalMmeDisplay.textContent) : null;
        
        if (isEnteringRotation) {
            pinnedDrugKey = null;
            updatePercentAdjustment(0);
            document.querySelectorAll('.percent-adjust-btn.active').forEach(b => b.classList.remove('active'));
            document.querySelector('.percent-adjust-btn[data-percent="0"]')?.classList.add('active');
            elements.customPercentInput.value = '';
        }
        calculateAndRender();
    }
    
    function calculateCsci() {
        const adjustedDose = parseFloat(elements.csciTotalDoseInput.value) || 0;
        const drugKey = rotationDoseInfo.drugKey;
        const config = ROTATION_DRUGS[drugKey];
        if (!config || config.helper !== 'csci') return;
        const drugInfo = config.drugInfo;
        
        const syringeSize = parseFloat(elements.csciSyringeSize.value);
        const totalVolume = parseFloat(elements.csciTotalVolume.value) || 0;
        const syringeLength = SYRINGE_DATA.BD[syringeSize]?.length;

        const newMME = adjustedDose * config.factor;
        elements.csciNewMme.textContent = adjustedDose > 0 ? `~ ${Math.round(newMME)} MME/day` : '';

        elements.csciResult.classList.add('hidden');
        elements.csciError.classList.add('hidden');

        if (totalVolume <= 0 || !syringeLength || adjustedDose <= 0) {
            rotationDoseInfo.helperResult = null;
            if (rotationMME !== null) updateBasalRecommendation(newMME);
            return;
        }

        const drugVolume = adjustedDose / drugInfo.concentration;

        if (drugVolume > syringeSize) {
            elements.csciErrorText.textContent = `ปริมาณยา (${drugVolume.toFixed(2)} ml) เกินขนาด Syringe (${syringeSize} ml)`;
            elements.csciError.classList.remove('hidden'); return;
        }
        if (totalVolume > syringeSize) {
            elements.csciErrorText.textContent = `ปริมาตรรวม (${totalVolume} ml) เกินขนาด Syringe (${syringeSize} ml)`;
            elements.csciError.classList.remove('hidden'); return;
        }
        if (drugVolume.toFixed(2) > totalVolume) {
            elements.csciErrorText.textContent = `ปริมาณยา (${drugVolume.toFixed(2)} ml) เกินปริมาตรรวม (${totalVolume} ml)`;
            elements.csciError.classList.remove('hidden'); return;
        }

        const diluentVolume = totalVolume - drugVolume;
        const rateMlPerHour = totalVolume / 24;
        const rateMmPerHour = (totalVolume / syringeSize) * (syringeLength / 24);
        
        elements.csciDrugVolume.innerHTML = `${drugVolume.toFixed(2)} ml`;
        elements.csciDiluentVolume.textContent = `${diluentVolume.toFixed(2)} ml`;
        elements.csciRateMl.textContent = `${rateMlPerHour.toFixed(2)}`;
        elements.csciRateMm.textContent = `${rateMmPerHour.toFixed(2)}`;
        const orderText = `${drugInfo.name} ${adjustedDose.toFixed(0)} ${drugInfo.unit.split('/')[0]} with NSS up to ${totalVolume} ml, via CSCI over 24 hours (Rate: ${rateMmPerHour.toFixed(2)} mm/hr).`;
        elements.csciOrderText.textContent = orderText;
        rotationDoseInfo.helperResult = `<div class="w-full"><p class="text-xl">${Math.round(adjustedDose)} ${config.unit.split('/')[0]}</p><p class="text-sm text-gray-600 mt-1 font-normal">${orderText}</p></div>`;
        elements.csciResult.classList.remove('hidden');
    }

    function calculateIvInfusion() {
        const adjustedDose = parseFloat(elements.ivTotalDoseInput.value) || 0;
        const drugKey = rotationDoseInfo.drugKey;
        const config = ROTATION_DRUGS[drugKey];
        if (!config || config.helper !== 'iv_infusion') return;
        const drugInfo = config.drugInfo;
        
        const newMME = adjustedDose * config.factor;
        elements.ivNewMme.textContent = adjustedDose > 0 ? `~ ${Math.round(newMME)} MME/day` : '';

        elements.ivResult.classList.add('hidden');
        elements.ivError.classList.add('hidden');

        const fluidVolume = parseFloat(elements.ivFluidVolume.value) || 0;
        if (fluidVolume <= 0 || adjustedDose <= 0) {
             rotationDoseInfo.helperResult = null;
             if (rotationMME !== null) updateBasalRecommendation(newMME);
             return;
        }

        const drugAmountInMgOrMcg = adjustedDose;
        const drugVolumeMl = drugAmountInMgOrMcg / drugInfo.concentration;
        if (drugVolumeMl > fluidVolume) {
            elements.ivErrorText.textContent = `ปริมาณยา (${drugVolumeMl.toFixed(1)} ml) เกินปริมาตรสารน้ำรวม (${fluidVolume} ml)`;
            elements.ivError.classList.remove('hidden'); return;
        }

        const rateMlPerHour = fluidVolume / 24;
        const finalConcentration = drugAmountInMgOrMcg / fluidVolume;
        const dosePerHour = finalConcentration * rateMlPerHour;

        elements.ivConcentration.textContent = `${finalConcentration.toFixed(2)} ${drugInfo.unit}/ml`;
        elements.ivDoseHr.textContent = `${dosePerHour.toFixed(2)} ${drugInfo.unit.split('/')[0]}/hr`;
        const orderText = `${drugInfo.name} ${Math.round(drugAmountInMgOrMcg)} ${drugInfo.unit.split('/')[0]} + NSS up to ${fluidVolume} mL IV drip ${rateMlPerHour.toFixed(1)} mL/hr`;
        elements.ivOrderText.textContent = orderText;

        elements.ivResult.classList.remove('hidden');
        rotationDoseInfo.helperResult = `<div class="w-full"><p class="text-xl">${Math.round(adjustedDose)} ${config.unit.split('/')[0]}</p><p class="text-sm text-gray-600 mt-1 font-normal">${orderText}</p></div>`;
    }

    function openHelperModal() {
        const key = elements.basalCalcDrug.value;
        const config = ROTATION_DRUGS[key];
        if (!config.helper) return;

        const dose = rotationDoseInfo.dose;
        const drugInfo = config.drugInfo;

        if (config.helper === 'csci') {
            elements.csciDrugName.textContent = drugInfo.name;
            elements.csciDoseUnit.textContent = config.unit.split('/')[0];
            elements.csciTotalDoseInput.value = Math.round(dose);
            elements.csciTotalVolume.value = '';
            elements.csciResult.classList.add('hidden');
            elements.csciError.classList.add('hidden');
            elements.csciNewMme.textContent = '';
            elements.csciModal.classList.add('visible');
            calculateCsci();
        } else if (config.helper === 'iv_infusion') {
            elements.ivDrugName.textContent = drugInfo.name;
            elements.ivDoseUnit.textContent = config.unit.split('/')[0];
            elements.ivTotalDoseInput.value = Math.round(dose);
            elements.ivFluidVolume.value = '100';
            elements.ivResult.classList.add('hidden');
            elements.ivError.classList.add('hidden');
            elements.ivNewMme.textContent = '';
            elements.ivInfusionModal.classList.add('visible');
            calculateIvInfusion();
        }
    }

    function openQuickRefModal(totalMME) {
        const quickRefList = elements.quickRefList;
        quickRefList.innerHTML = ''; // Clear previous results
        elements.quickRefMmeTotal.textContent = Math.round(totalMME);

        const refDrugs = ['fentanyl_patch', 'morphine_sr', 'morphine_iv_infusion', 'fentanyl_iv_infusion'];

        refDrugs.forEach(key => {
            const config = ROTATION_DRUGS[key];
            if (config) {
                const equivalentDose = totalMME / config.factor;
                const doseText = (key === 'fentanyl_patch') 
                    ? (Math.round(equivalentDose / 12.5) * 12.5).toFixed(1) 
                    : Math.round(equivalentDose);

                const rowHtml = `
                    <div class="flex justify-between items-center bg-white p-2 rounded-md border">
                        <span class="font-medium text-gray-700">${config.name}</span>
                        <span class="font-bold text-green-700">${doseText} ${config.unit}</span>
                    </div>
                `;
                quickRefList.insertAdjacentHTML('beforeend', rowHtml);
            }
        });

        elements.quickRefModal.classList.add('visible');
    }
    
    function closeHelperModal(type) {
        const inputEl = (type === 'csci') ? elements.csciTotalDoseInput : elements.ivTotalDoseInput;
        const finalUserDose = parseFloat(inputEl.value) || 0;
        const drugKey = rotationDoseInfo.drugKey;
        const config = ROTATION_DRUGS[drugKey];
        
        if (config && rotationMME > 0) {
            const finalMME = finalUserDose * config.factor;
            const pctChange = ((finalMME / rotationMME) - 1) * 100;
            updatePercentAdjustment(pctChange);
        }

        if (type === 'csci') {
            calculateCsci(); 
            elements.csciModal.classList.remove('visible');
        } else {
            calculateIvInfusion();
            elements.ivInfusionModal.classList.remove('visible');
        }
        
        calculateAndRender();
    }
    
    function updatePercentAdjustment(newPercent) {
        percentAdjustment = newPercent;
        elements.customPercentInput.value = newPercent.toFixed(1);
        document.querySelectorAll('.percent-adjust-btn.active').forEach(b => b.classList.remove('active'));
        
        const matchingButton = document.querySelector(`.percent-adjust-btn[data-percent="${Math.round(newPercent)}"]`);
        if (matchingButton) {
            matchingButton.classList.add('active');
        }

        if (rotationMME !== null && titrationMode !== 'percent') {
            titrationMode = 'percent';
            document.querySelectorAll('.titration-mode-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.mode === 'percent'));
            elements.prnTitrationSection.classList.add('hidden');
            elements.percentTitrationSection.classList.remove('hidden');
        }
        
        if (history.states[history.currentIndex] !== newPercent) {
            history.states = history.states.slice(0, history.currentIndex + 1);
            history.states.push(newPercent);
            history.currentIndex = history.states.length - 1;
        }
    }

    function updateHistoryButtons() {
        elements.undoBtn.disabled = history.currentIndex <= 0;
        elements.redoBtn.disabled = history.currentIndex >= history.states.length - 1;
    }

    function saveToLocalStorage() {
        const baseDoses = {};
        document.querySelectorAll('.base-drug-input').forEach(input => {
            baseDoses[input.dataset.key] = input.value;
        });

        const prnDoses = [];
        document.querySelectorAll('.prn-row').forEach(row => {
            const key = row.querySelector('.prn-drug-select').value;
            const dose = row.querySelector('.prn-dose-input').value;
            if (key && dose) {
                prnDoses.push({ key, dose });
            }
        });

        const state = {
            baseDoses,
            prnDoses,
            titrationMode,
            percentAdjustment,
            pinnedDrugKey,
            rotationMME,
            rotationDoseInfo,
            history,
            rotationTools: {
                basalDrug: elements.basalCalcDrug.value,
                breakthroughDrug: elements.breakthroughCalcDrug.value,
                breakthroughPercent: elements.breakthroughCalcPercent.value
            }
        };
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(state));
    }

    function loadFromLocalStorage() {
        const savedState = localStorage.getItem(LOCAL_STORAGE_KEY);
        if (!savedState) {
            addBreakthroughRow();
            calculateAndRender();
            return;
        }

        try {
            const state = JSON.parse(savedState);
            Object.keys(state.baseDoses).forEach(key => {
                const input = document.getElementById(`dose-${key}`);
                if (input) input.value = state.baseDoses[key];
            });

            elements.breakthroughRowsContainer.innerHTML = '';
            if (state.prnDoses && state.prnDoses.length > 0) {
                state.prnDoses.forEach(data => addBreakthroughRow(data));
            } else {
                addBreakthroughRow();
            }
            
            titrationMode = state.titrationMode || 'prn';
            percentAdjustment = state.percentAdjustment || 0;
            pinnedDrugKey = state.pinnedDrugKey || null;
            rotationMME = state.rotationMME || null;
            rotationDoseInfo = state.rotationDoseInfo || { drugKey: '', dose: 0, helperResult: null, originalDose: 0 };
            history = state.history || { states: [0], currentIndex: 0 };

            document.querySelectorAll('.titration-mode-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.mode === titrationMode));
            elements.prnTitrationSection.classList.toggle('hidden', titrationMode !== 'prn');
            elements.percentTitrationSection.classList.toggle('hidden', titrationMode !== 'percent');
            
            updatePercentAdjustment(percentAdjustment);

            if (state.rotationTools) {
                elements.basalCalcDrug.value = state.rotationTools.basalDrug;
                elements.breakthroughCalcDrug.value = state.rotationTools.breakthroughDrug;
                elements.breakthroughCalcPercent.value = state.rotationTools.breakthroughPercent;
            }

            calculateAndRender();

        } catch (error) {
            console.error("Failed to load state from Local Storage:", error);
            clearAllInputs();
        }
    }

    function clearAllInputs() {
        localStorage.removeItem(LOCAL_STORAGE_KEY);
        
        document.querySelectorAll('input[type="number"]').forEach(i => i.value = '');
        document.querySelectorAll('select').forEach(s => { if(!s.closest('#rotation-tools')) s.selectedIndex = 0; });
        elements.breakthroughRowsContainer.innerHTML = '';
        addBreakthroughRow();
        pinnedDrugKey = null;
        rotationMME = null;
        rotationDoseInfo = { drugKey: '', dose: 0, helperResult: null, originalDose: 0 };
        history = { states: [0], currentIndex: 0 };
        updatePercentAdjustment(0);
        document.querySelectorAll('.percent-adjust-btn.active').forEach(b => b.classList.remove('active'));
        document.querySelector('.percent-adjust-btn[data-percent="0"]')?.classList.add('active');
        calculateAndRender();
    }

    function setupEventListeners() {
        const recalculate = () => calculateAndRender();

        elements.medSection.addEventListener('input', e => { if (e.target.classList.contains('base-drug-input')) recalculate(); });
        elements.medSection.addEventListener('click', e => {
            const pinButton = e.target.closest('.pin-btn');
            if(pinButton) { 
                rotationMME = null; 
                pinnedDrugKey = (pinnedDrugKey === pinButton.dataset.key) ? null : pinButton.dataset.key; 
                recalculate(); 
            }
        });
        elements.titrationModeToggle.addEventListener('click', e => {
            const button = e.target.closest('.titration-mode-btn');
            if (button) { titrationMode = button.dataset.mode; document.querySelectorAll('.titration-mode-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.mode === titrationMode)); elements.prnTitrationSection.classList.toggle('hidden', titrationMode !== 'prn'); elements.percentTitrationSection.classList.toggle('hidden', titrationMode !== 'percent'); recalculate(); }
        });
        elements.percentTitrationSection.addEventListener('click', e => {
            const button = e.target.closest('.percent-adjust-btn');
            if (button) { updatePercentAdjustment(parseInt(button.dataset.percent, 10)); recalculate(); }
        });
        elements.customPercentInput.addEventListener('input', e => {
            const value = parseFloat(e.target.value) || 0;
            e.target.classList.remove('border-green-500', 'border-red-500');
            if (value > 0) e.target.classList.add('border-green-500');
            else if (value < 0) e.target.classList.add('border-red-500');
            updatePercentAdjustment(value); 
            recalculate(); 
        });
        elements.addBreakthroughBtn.addEventListener('click', () => { addBreakthroughRow(); recalculate(); });
        elements.breakthroughRowsContainer.addEventListener('change', e => {
            if (e.target.classList.contains('prn-drug-select')) {
                const unitEl = e.target.closest('.prn-row').querySelector(`.prn-dose-unit`);
                unitEl.textContent = (e.target.value && DRUG_CONFIG[e.target.value]) ? DRUG_CONFIG[e.target.value].unit : '-- หน่วย --';
                recalculate();
            }
        });
        elements.breakthroughRowsContainer.addEventListener('input', e => { if (e.target.classList.contains('prn-dose-input')) recalculate(); });
        elements.breakthroughRowsContainer.addEventListener('click', e => {
            if (e.target.closest('.remove-prn-btn')) {
                if (elements.breakthroughRowsContainer.children.length > 1) { e.target.closest('.prn-row').remove(); } 
                else { const row = elements.breakthroughRowsContainer.firstElementChild; row.querySelector('select').value = ''; row.querySelector('input').value = ''; row.querySelector('.prn-dose-unit').textContent = '-- หน่วย --'; }
                recalculate();
            }
        });
        elements.clearAllBtn.addEventListener('click', clearAllInputs);
        elements.rotateBtn.addEventListener('click', handleRotateClick);
        elements.cancelRotateBtn.addEventListener('click', handleRotateClick);
        
        const updateRotationTools = () => { if(rotationMME !== null) { updateBasalRecommendation(rotationMME * (1 + (percentAdjustment/100))); updateBreakthroughRecommendation(rotationMME * (1 + (percentAdjustment/100))); saveToLocalStorage(); }};
        elements.basalCalcDrug.addEventListener('change', updateRotationTools);
        elements.breakthroughCalcDrug.addEventListener('change', updateRotationTools);
        elements.breakthroughCalcPercent.addEventListener('change', updateRotationTools);
        
        elements.undoBtn.addEventListener('click', () => {
            if (history.currentIndex > 0) {
                history.currentIndex--;
                const newPercent = history.states[history.currentIndex];
                percentAdjustment = newPercent;
                elements.customPercentInput.value = newPercent.toFixed(1);
                recalculate();
            }
        });
        elements.redoBtn.addEventListener('click', () => {
            if (history.currentIndex < history.states.length - 1) {
                history.currentIndex++;
                const newPercent = history.states[history.currentIndex];
                percentAdjustment = newPercent;
                elements.customPercentInput.value = newPercent.toFixed(1);
                recalculate();
            }
        });

        elements.totalMmeDisplay.addEventListener('click', () => {
            if (rotationMME !== null) return;
            const totalMME = parseFloat(elements.totalMmeDisplay.textContent) || 0;
            if (totalMME > 0) {
                openQuickRefModal(totalMME);
            }
        });
        
        // Modal Listeners
        elements.safetyChecklistBtn.addEventListener('click', () => elements.safetyModal.classList.add('visible'));
        [elements.closeSafetyModalBtn, elements.safetyModal].forEach(el => el.addEventListener('click', (e) => { if(e.target === el) elements.safetyModal.classList.remove('visible')}));
        
        elements.quickRefModal.addEventListener('click', (e) => {
            if (e.target === elements.quickRefModal || e.target.closest('#close-quick-ref-modal-btn')) {
                elements.quickRefModal.classList.remove('visible');
            }
        });

        elements.basalHelperBtn.addEventListener('click', openHelperModal);
        
        // CSCI Modal
        elements.csciTotalDoseInput.addEventListener('input', calculateCsci);
        elements.csciTotalVolume.addEventListener('input', calculateCsci);
        elements.csciSyringeSize.addEventListener('change', calculateCsci);
        elements.closeCsciModalBtn.addEventListener('click', () => closeHelperModal('csci'));
        elements.cancelCsciModalBtn.addEventListener('click', () => elements.csciModal.classList.remove('visible'));
        elements.csciResetDoseBtn.addEventListener('click', () => {
            elements.csciTotalDoseInput.value = Math.round(rotationDoseInfo.originalDose);
            calculateCsci();
        });
        
        // IV Infusion Modal
        elements.ivTotalDoseInput.addEventListener('input', calculateIvInfusion);
        elements.ivFluidVolume.addEventListener('input', calculateIvInfusion);
        elements.closeIvInfusionModalBtn.addEventListener('click', () => closeHelperModal('iv_infusion'));
        elements.cancelIvModalBtn.addEventListener('click', () => elements.ivInfusionModal.classList.remove('visible'));
        elements.ivResetDoseBtn.addEventListener('click', () => {
            elements.ivTotalDoseInput.value = Math.round(rotationDoseInfo.originalDose);
            calculateIvInfusion();
        });
    }

    initialize();
});
</script>

</body>
</ht
