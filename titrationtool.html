<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palliative Opioid Titration & Conversion Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans Thai', sans-serif; }
        .main-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
        @media (min-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr 1fr;
            }
        }
        .input-field {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem;
            text-align: center;
            width: 100%;
            background-color: #f9fafb;
        }
        .input-field:focus {
            background-color: white;
            border-color: #0891b2;
            box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.2);
            outline: none;
        }
        .output-card {
            background-color: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 0.5rem;
            padding: 1.5rem;
            height: fit-content;
        }
        .readonly-field {
            background-color: #e5e7eb;
            color: #4b5563;
            font-weight: 500;
        }
        .copy-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            background-color: #0891b2;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .copy-button:hover {
            background-color: #0e7490;
        }
        .copy-button.copied {
            background-color: #059669;
        }
        .radio-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            background-color: white;
        }
        input[type="radio"]:checked + .radio-label {
            border-color: #0891b2;
            background-color: #cffafe;
            box-shadow: 0 0 0 2px #0891b2;
        }
        input[type="radio"] {
            display: none;
        }
        #order-preview-area {
            width: 100%;
            min-height: 150px;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-family: monospace;
            font-size: 0.875rem;
            line-height: 1.5;
            background-color: #f9fafb;
        }
        .drip-options {
            display: none;
            padding-top: 0.75rem;
            padding-left: 1rem;
            border-left: 2px solid #e5e7eb;
            margin-left: 0.5rem;
        }
        input[type="radio"]:checked + .radio-label + .drip-options {
            display: block;
        }
        .percent-button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            border: 1px solid #0891b2;
            color: #0891b2;
            background-color: white;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .percent-button.active, .percent-button:hover {
            background-color: #cffafe;
            border-color: #0891b2;
        }
        .toggle-switch {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            cursor: pointer;
            background-color: #f9fafb;
        }
        .toggle-switch.active {
            border-color: #0891b2;
            background-color: #cffafe;
        }
        .hidden {
            display: none;
        }
        .action-button {
             padding: 0.5rem 0.75rem;
             border-radius: 0.375rem;
             border: 1px solid #d1d5db;
             background-color: #f9fafb;
             font-weight: 500;
             cursor: pointer;
             transition: all 0.2s;
             display: inline-flex;
             align-items: center;
             gap: 0.25rem;
             font-size: 0.875rem;
        }
        .action-button:hover {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-7xl bg-white rounded-xl shadow-lg p-4 sm:p-6 space-y-6">
        <header class="text-center">
            <h1 class="text-2xl sm:text-3xl font-bold text-cyan-700">Opioid Titration & Conversion Tool</h1>
            <p class="text-gray-500">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Palliative Care</p>
        </header>

        <div class="main-container">
            <!-- Left Column: Inputs -->
            <div class="bg-white p-4 sm:p-6 rounded-lg border space-y-6">
                 <div>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">1. ‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÉ‡∏ô 24 ‡∏ä‡∏°.</h2>
                        <div class="flex gap-2">
                             <button id="test-button" class="action-button">üß™ ‡∏™‡∏∏‡πà‡∏° Input</button>
                             <button id="reset-button" class="action-button">üîÑ ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡∏°‡πà</button>
                        </div>
                    </div>
                    <div class="space-y-4" id="from-section"></div>
                </div>
                <hr>
                <div class="space-y-4">
                    <div id="prn-toggle-button" class="toggle-switch">
                        <span class="font-medium text-gray-900">‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤ PRN</span>
                        <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                            <div class="toggle-switch-handle block w-6 h-6 rounded-full bg-white shadow-md transform duration-200 ease-in-out"></div>
                        </div>
                    </div>
                    <div id="prn-given-section" class="hidden">
                        <div>
                            <h3 class="font-semibold text-gray-600">‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ß‡∏±‡∏ô (PRN Given)</h3>
                            <p class="text-sm text-gray-500">(‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡πÑ‡∏õ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏¢‡∏≤ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ)</p>
                        </div>
                        <div class="p-3 border rounded-lg space-y-4"></div>
                        <div id="dose-escalation-section" class="p-4 mt-4 border rounded-lg bg-cyan-50/50 hidden">
                            <h3 class="font-semibold text-gray-700 mb-3">‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≤ (Dose Escalation)</h3>
                             <div class="space-y-3">
                                <div class="flex items-center gap-2">
                                    <button class="percent-button" data-percent="25">25%</button>
                                    <button class="percent-button" data-percent="30">30%</button>
                                    <button class="percent-button" data-percent="50">50%</button>
                                </div>
                                <div class="flex items-center gap-2">
                                    <label for="dose-escalation-percent" class="text-sm">‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á:</label>
                                    <input type="number" id="dose-escalation-percent" value="0" class="input-field !w-24">
                                    <span class="text-sm">%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Calculations & Tools -->
            <div class="output-card space-y-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-2">2. ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì & ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</h2>
                
                <div class="p-4 border rounded-lg bg-white">
                    <h3 class="font-semibold text-gray-700 mb-3">‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≤</h3>
                    <div>
                        <p class="text-sm text-gray-600">Current Total MEDD</p>
                        <p><span id="current-medd" class="text-2xl font-bold text-cyan-700">0.0</span> mg/day</p>
                    </div>
                     <div class="mt-2">
                        <p class="text-sm text-gray-600">New Total MEDD (‡∏¢‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</p>
                        <p><span id="new-medd" class="text-2xl font-bold text-cyan-700">0.0</span> mg/day</p>
                    </div>
                </div>

                <div class="p-4 border rounded-lg bg-white">
                    <h3 class="font-semibold text-gray-700 mb-3">3. ‡∏à‡∏±‡∏î‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å Order</h3>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-medium text-gray-600 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (Basal Dose)</h4>
                            <div id="basal-options" class="space-y-2"></div>
                        </div>
                        <hr>
                        <div>
                            <h4 class="font-medium text-gray-600 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏≤ PRN (PRN Dose)</h4>
                            <div id="prn-options" class="space-y-2"></div>
                        </div>
                        <hr>
                        <div>
                            <h4 class="font-medium text-gray-600 mb-2">‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Order</h4>
                             <textarea id="order-preview-area" rows="8"></textarea>
                        </div>
                        <button id="copy-order-button" class="copy-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                            <span id="copy-button-text">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å Order</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const CONVERSION_FACTORS = {
            'oral_morphine_lr': { factor: 1, unit: 'mg/day' },
            'sc_morphine': { factor: 3, unit: 'mg/day' },
            'iv_morphine': { factor: 3, unit: 'mg/day' },
            'patch_fentanyl': { factor: 2.4, unit: 'mcg/hr' },
            'iv_fentanyl': { factor: 0.3, unit: 'mcg/day' },
            'oral_tramadol': { factor: 0.1, unit: 'mg/day' },
            'iv_tramadol': { factor: 0.2, unit: 'mg/day' }
        };

        const DRUG_LABELS = {
            'oral_morphine_lr': 'MST / Kapanol',
            'sc_morphine': 'Morphine SC',
            'iv_morphine': 'Morphine IV',
            'patch_fentanyl': 'Fentanyl Patch',
            'iv_fentanyl': 'Fentanyl IV',
            'oral_tramadol': 'Tramadol Oral',
            'iv_tramadol': 'Tramadol IV'
        };

        const PRN_DRUG_LABELS = {
            'prn_sc': 'Morphine SC PRN',
            'prn_ir': 'Morphine IR PRN',
            'prn_syrup': 'Morphine Syrup PRN'
        };
        
        const PRN_REGIMENS = {
            'prn-sc': { label: 'Morphine SC', template: (dose) => `Morphine ${dose} mg PRN SC for pain q 4 hr` },
            'prn-iv': { label: 'Morphine IV', template: (dose) => `Morphine ${dose} mg PRN IV for pain q 4 hr` },
            'prn-ir': { label: 'Morphine IR', template: (dose) => `Morphine IR ${dose} mg PRN PO for pain q 2 hr` },
            'prn-syrup': { label: 'Morphine Syrup', template: (dose) => `Morphine Syrup ${dose} ml PRN PO for pain q 2 hr` },
            'prn-fentanyl-iv': { label: 'Fentanyl IV PRN', template: (dose) => `Fentanyl ${dose} mcg PRN IV for pain q 2 hr` }
        };

        const ORAL_TO_SC_RATIO = 3;
        const MORPHINE_SYRUP_CONCENTRATION = 2; // 2 mg/ml

        // --- STATE ---
        let isCalculating = false;

        // --- MAIN CALCULATION LOGIC ---
        function calculateAll() {
            if (isCalculating) return;
            isCalculating = true;

            let basalMedd = 0;
            Object.keys(DRUG_LABELS).forEach(key => {
                const dose = parseFloat(document.getElementById(`dose-${key}`).value) || 0;
                if (dose > 0) basalMedd += dose * CONVERSION_FACTORS[key].factor;
            });
            updateLiveBasalConversion(basalMedd);

            let prnMedd = 0;
            let totalPrnTimes = 0;
            const prnToggle = document.getElementById('prn-toggle-button');
            if (prnToggle.classList.contains('active')) {
                const prnScTimes = parseFloat(document.getElementById('prn_sc-times').value) || 0;
                const prnIrTimes = parseFloat(document.getElementById('prn_ir-times').value) || 0;
                const prnSyrupTimes = parseFloat(document.getElementById('prn_syrup-times').value) || 0;
                totalPrnTimes = prnScTimes + prnIrTimes + prnSyrupTimes;

                if (totalPrnTimes >= 3) {
                    const prnScSize = parseFloat(document.getElementById('prn_sc-size').value) || 0;
                    if (prnScSize > 0) prnMedd += (prnScSize * CONVERSION_FACTORS['sc_morphine'].factor) * prnScTimes;

                    const prnIrSize = parseFloat(document.getElementById('prn_ir-size').value) || 0;
                    if (prnIrSize > 0) prnMedd += prnIrSize * prnIrTimes;
                    
                    const prnSyrupSizeMl = parseFloat(document.getElementById('prn_syrup-size').value) || 0;
                    if (prnSyrupSizeMl > 0) {
                        prnMedd += (prnSyrupSizeMl * MORPHINE_SYRUP_CONCENTRATION) * prnSyrupTimes;
                    }
                }
            }
            
            const escalationSection = document.getElementById('dose-escalation-section');
            if (totalPrnTimes >= 3) {
                escalationSection.classList.remove('hidden');
            } else {
                escalationSection.classList.add('hidden');
                document.getElementById('dose-escalation-percent').value = 0;
                 document.querySelectorAll('.percent-button.active').forEach(b => b.classList.remove('active'));
            }

            const currentTotalMedd = basalMedd + prnMedd;
            document.getElementById('current-medd').textContent = currentTotalMedd.toFixed(1);

            const escalationPercent = parseFloat(document.getElementById('dose-escalation-percent').value) || 0;
            const newTotalMedd = currentTotalMedd * (1 + (escalationPercent / 100));
            document.getElementById('new-medd').textContent = newTotalMedd.toFixed(1);

            updateTitrationResults(newTotalMedd);
            
            isCalculating = false;
        }

        function updateLiveBasalConversion(basalMedd) {
             Object.keys(DRUG_LABELS).forEach(key => {
                const displayField = document.getElementById(`live-conv-${key}`);
                const equivalentDose = basalMedd > 0 ? basalMedd / CONVERSION_FACTORS[key].factor : 0;
                displayField.value = equivalentDose.toFixed(1);
            });
        }

        function updateTitrationResults(totalMedd) {
            // --- New Basal Doses ---
            const newBasalMorphineSC = totalMedd / CONVERSION_FACTORS['sc_morphine'].factor;
            const newBasalMorphineIV = totalMedd / CONVERSION_FACTORS['iv_morphine'].factor;
            const newBasalFentanylIV = totalMedd / CONVERSION_FACTORS['iv_fentanyl'].factor;
            const newBasalFentanylPatch = totalMedd / CONVERSION_FACTORS['patch_fentanyl'].factor;
            
            document.getElementById('basal-morphine-sc-val').textContent = `${newBasalMorphineSC.toFixed(1)} mg/day`;
            document.getElementById('basal-morphine-iv-val').textContent = `${newBasalMorphineIV.toFixed(1)} mg/day`;
            document.getElementById('basal-fentanyl-iv-val').textContent = `${newBasalFentanylIV.toFixed(1)} mcg/day`;
            document.getElementById('basal-fentanyl-patch-val').textContent = `${newBasalFentanylPatch.toFixed(1)} mcg/hr`;
            
            const roundedFentanylPatch = Math.round(newBasalFentanylPatch / 12.5) * 12.5;
            document.getElementById('basal-morphine-sc').dataset.orderText = `Morphine ${Math.round(newBasalMorphineSC)} mg + NSS up to 22 mL CSCI drip in 24 hr`;
            document.getElementById('basal-fentanyl-patch').dataset.orderText = `Fentanyl Patch ${roundedFentanylPatch.toFixed(1)} mcg/hr q 72 hr`;
            updateIvDripOrder('morphine');
            updateIvDripOrder('fentanyl');

            // --- New PRN Doses ---
            const prnOralMg = totalMedd / 6;
            const prnScMg = prnOralMg / ORAL_TO_SC_RATIO;
            const prnIvMg = prnOralMg / ORAL_TO_SC_RATIO;
            const prnSyrupMl = prnOralMg / MORPHINE_SYRUP_CONCENTRATION;
            const rawPrnFentanylIV = (totalMedd / CONVERSION_FACTORS['iv_fentanyl'].factor) / 6;

            document.getElementById('prn-ir-val').textContent = `${prnOralMg.toFixed(1)} mg`;
            document.getElementById('prn-sc-val').textContent = `${prnScMg.toFixed(1)} mg`;
            document.getElementById('prn-iv-val').textContent = `${prnIvMg.toFixed(1)} mg`;
            document.getElementById('prn-syrup-val').textContent = `${prnSyrupMl.toFixed(1)} ml`;
            document.getElementById('prn-fentanyl-iv-val').textContent = `${rawPrnFentanylIV.toFixed(1)} mcg`;
            
            const roundedPrnIr = Math.round(prnOralMg / 5) * 5;
            const roundedPrnSc = Math.round(prnScMg);
            const roundedPrnIv = Math.round(prnIvMg);
            const roundedPrnSyrup = Math.round(prnSyrupMl);
            let roundedPrnFentanylIV = Math.round(rawPrnFentanylIV / 25) * 25;
            if (roundedPrnFentanylIV === 0 && rawPrnFentanylIV > 0) {
                roundedPrnFentanylIV = 25;
            }
            
            document.getElementById('prn-ir').dataset.orderText = PRN_REGIMENS['prn-ir'].template(roundedPrnIr.toFixed(0));
            document.getElementById('prn-sc').dataset.orderText = PRN_REGIMENS['prn-sc'].template(roundedPrnSc.toFixed(0));
            document.getElementById('prn-iv').dataset.orderText = PRN_REGIMENS['prn-iv'].template(roundedPrnIv.toFixed(0));
            document.getElementById('prn-syrup').dataset.orderText = PRN_REGIMENS['prn-syrup'].template(roundedPrnSyrup.toFixed(0));
            document.getElementById('prn-fentanyl-iv').dataset.orderText = PRN_REGIMENS['prn-fentanyl-iv'].template(roundedPrnFentanylIV.toFixed(0));

            updateOrderPreview();
        }

        function formatRatio(ratio) {
            return Number.isInteger(ratio) ? ratio.toString() : ratio.toFixed(2);
        }

        function updateIvDripOrder(drug) {
            const newTotalMedd = parseFloat(document.getElementById('new-medd').textContent) || 0;
            let dose, volume, duration, rate, concentration, orderText, concentrationRatio;

            const concentrationSelect = document.getElementById(`${drug}-iv-drip-concentration`);
            const customConcentrationInput = document.getElementById(`${drug}-iv-drip-concentration-custom`);
            let concentrationValue = concentrationSelect.value;
            if (concentrationValue === 'other') {
                concentrationValue = customConcentrationInput.value;
            }
            
            const ratioParts = concentrationValue.split(':');
            concentrationRatio = ratioParts.length === 2 ? parseFloat(ratioParts[1]) : 1;
            
            if (drug === 'morphine') {
                const newBasalMorphineIV = newTotalMedd / CONVERSION_FACTORS['iv_morphine'].factor;
                dose = Math.round(newBasalMorphineIV);
                volume = dose * concentrationRatio;
                duration = parseFloat(document.getElementById('morphine-iv-drip-duration').value) || 24;
                rate = duration > 0 ? volume / duration : 0;
                document.getElementById('morphine-iv-drip-volume').textContent = `${volume.toFixed(1)} mL`;
                document.getElementById('morphine-iv-drip-rate').textContent = `${rate.toFixed(1)} mL/hr`;
                orderText = `Morphine ${dose} mg (1:${formatRatio(concentrationRatio)}) + NSS up to ${volume.toFixed(1)} mL IV drip at ${Math.round(rate)} mL/hr`;
                document.getElementById('basal-morphine-iv').dataset.orderText = orderText;
            } else if (drug === 'fentanyl') {
                const newBasalFentanylIV = newTotalMedd / CONVERSION_FACTORS['iv_fentanyl'].factor;
                dose = Math.round(newBasalFentanylIV);
                volume = dose * concentrationRatio;
                duration = parseFloat(document.getElementById('fentanyl-iv-drip-duration').value) || 24;
                rate = duration > 0 ? volume / duration : 0;
                document.getElementById('fentanyl-iv-drip-volume').textContent = `${volume.toFixed(1)} mL`;
                document.getElementById('fentanyl-iv-drip-rate').textContent = `${rate.toFixed(1)} mL/hr`;
                orderText = `Fentanyl ${dose} mcg (1:${formatRatio(concentrationRatio)}) + NSS up to ${volume.toFixed(1)} mL IV drip at ${Math.round(rate)} mL/hr`;
                document.getElementById('basal-fentanyl-iv').dataset.orderText = orderText;
            }
            updateOrderPreview();
        }
        
        function updateOrderPreview() {
            const selectedBasal = document.querySelector('input[name="basal-regimen"]:checked');
            const selectedPrn = document.querySelector('input[name="prn-regimen"]:checked');

            const basalText = selectedBasal ? `- ${selectedBasal.dataset.orderText}` : '';
            const prnText = selectedPrn ? `- ${selectedPrn.dataset.orderText}` : '';
            
            const now = new Date();
            const timestamp = now.toLocaleString('th-TH', { dateStyle: 'short', timeStyle: 'short' });

            const orderTextToCopy = `
üìã ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏¢‡∏≤‡πÉ‡∏´‡∏°‡πà
‚è∞ (${timestamp})
-------------------------
${basalText}
${prnText}
            `.trim().replace(/^\s+/gm, '');

            document.getElementById('order-preview-area').value = orderTextToCopy;
        }

        function copyOrderToClipboard() {
            const textToCopy = document.getElementById('order-preview-area').value;
            navigator.clipboard.writeText(textToCopy).then(() => {
                const button = document.getElementById('copy-order-button');
                const buttonText = document.getElementById('copy-button-text');
                const originalText = buttonText.textContent;

                button.classList.add('copied');
                buttonText.textContent = '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!';

                setTimeout(() => {
                    button.classList.remove('copied');
                    buttonText.textContent = originalText;
                }, 2000);
            }).catch(err => console.error('Failed to copy text: ', err));
        }

        function resetAll() {
            document.querySelectorAll('input[type="number"]').forEach(input => input.value = '');
            const prnToggleButton = document.getElementById('prn-toggle-button');
            if (prnToggleButton.classList.contains('active')) {
                prnToggleButton.click();
            }
            calculateAll();
        }

        function randomizeInputs() {
            // Clear all first
            resetAll();
            
            // Randomly select one basal drug to input
            const basalKeys = Object.keys(DRUG_LABELS);
            const randomBasalKey = basalKeys[Math.floor(Math.random() * basalKeys.length)];
            let randomDose = 0;
            if (randomBasalKey.includes('morphine')) {
                randomDose = Math.floor(Math.random() * 10) * 10; // 0-90
            } else if (randomBasalKey.includes('fentanyl')) {
                randomDose = (Math.floor(Math.random() * 5) * 12.5); // 0, 12.5, 25, 37.5, 50
            } else { // tramadol
                randomDose = Math.floor(Math.random() * 5) * 50; // 0-200
            }
            document.getElementById(`dose-${randomBasalKey}`).value = randomDose;

            // Randomly decide to use PRN
            if (Math.random() > 0.3) { // 70% chance to use PRN
                const prnToggleButton = document.getElementById('prn-toggle-button');
                if (!prnToggleButton.classList.contains('active')) {
                    prnToggleButton.click();
                }

                // Randomly select one PRN drug and set times to >= 3 to trigger escalation
                const prnKeys = Object.keys(PRN_DRUG_LABELS);
                const randomPrnKey = prnKeys[Math.floor(Math.random() * prnKeys.length)];
                
                document.getElementById(`${randomPrnKey}-times`).value = Math.floor(Math.random() * 3) + 3; // 3-5 times
                document.getElementById(`${randomPrnKey}-size`).value = Math.floor(Math.random() * 5) + 1; // 1-5 mg/ml
                
                // Randomly escalate
                if (Math.random() > 0.5) {
                    const percentButtons = document.querySelectorAll('.percent-button');
                    const randomPercentButton = percentButtons[Math.floor(Math.random() * percentButtons.length)];
                    randomPercentButton.click();
                }
            }
            
            calculateAll();
        }

        // --- UI INITIALIZATION ---
        function createUiElements() {
            const fromContainer = document.getElementById('from-section');
            const prnGivenContainer = document.querySelector('#prn-given-section > div');
            const basalOptionsContainer = document.getElementById('basal-options');
            const prnOptionsContainer = document.getElementById('prn-options');

            fromContainer.innerHTML = '<h3 class="font-semibold text-gray-600">‡∏¢‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (Basal Dose) & Live Conversion</h3>';
            prnGivenContainer.innerHTML = '';
            basalOptionsContainer.innerHTML = '';
            prnOptionsContainer.innerHTML = '';

            // Create Basal Dose Inputs and Live Conversion Displays
            Object.keys(DRUG_LABELS).forEach(key => {
                const { unit, label } = { unit: CONVERSION_FACTORS[key].unit, label: DRUG_LABELS[key] };
                const inputDiv = document.createElement('div');
                let stepAttr = 'step="any"';
                if (key === 'oral_morphine_lr') {
                    stepAttr = 'step="1"';
                } else if (key === 'patch_fentanyl') {
                    stepAttr = 'step="12.5"';
                }
                inputDiv.className = 'space-y-1';
                inputDiv.innerHTML = `
                    <label for="dose-${key}" class="font-semibold text-sm text-gray-700">${label}</label>
                    <div class="grid grid-cols-1 sm:grid-cols-[1fr,auto,1fr,auto] gap-2 items-center">
                        <input type="number" inputmode="decimal" id="dose-${key}" class="input-field" placeholder="0.0" ${stepAttr}>
                        <span class="font-bold text-gray-400 sm:inline hidden">‚Üí</span>
                        <input type="text" id="live-conv-${key}" class="input-field readonly-field" value="0.0" readonly>
                        <span class="font-medium text-gray-600">${unit}</span>
                    </div>`;
                fromContainer.appendChild(inputDiv);
                const inputEl = document.getElementById(`dose-${key}`);
                inputEl.addEventListener('input', calculateAll);
                if (key === 'oral_morphine_lr') {
                    inputEl.addEventListener('blur', (e) => {
                        e.target.value = Math.round(parseFloat(e.target.value) || 0);
                        calculateAll();
                    });
                } else if (key === 'patch_fentanyl') {
                     inputEl.addEventListener('blur', (e) => {
                        const val = parseFloat(e.target.value) || 0;
                        e.target.value = (Math.round(val / 12.5) * 12.5).toFixed(1);
                        calculateAll();
                    });
                }
            });

            // Create PRN Given Inputs
            Object.keys(PRN_DRUG_LABELS).forEach(key => {
                const label = PRN_DRUG_LABELS[key];
                const unit = key.includes('syrup') ? 'ml' : 'mg';
                const div = document.createElement('div');
                div.className = 'space-y-1';
                div.innerHTML = `<label class="font-semibold text-sm text-gray-700">${label}</label><div class="grid grid-cols-[1fr,auto,1fr] gap-2 items-center"><input type="number" inputmode="decimal" id="${key}-size" class="input-field" placeholder="Dose (${unit})"><span class="font-bold text-gray-500">x</span><input type="number" inputmode="decimal" id="${key}-times" class="input-field" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á"></div>`;
                prnGivenContainer.appendChild(div);
                document.getElementById(`${key}-size`).addEventListener('input', calculateAll);
                document.getElementById(`${key}-times`).addEventListener('input', calculateAll);
            });

            // Create Regimen Selection UI
            const basalRegimens = {
                'basal-morphine-sc': { label: 'Morphine SC Drip' },
                'basal-morphine-iv': { label: 'Morphine IV Drip', hasOptions: true, drug: 'morphine', presets: ['1:1', '1:5', '1:10'] },
                'basal-fentanyl-iv': { label: 'Fentanyl IV Drip', hasOptions: true, drug: 'fentanyl', presets: ['1:0.1', '1:0.5', '1:1', '1:5'] },
                'basal-fentanyl-patch': { label: 'Fentanyl Patch' }
            };
            Object.keys(basalRegimens).forEach((key, index) => {
                const regimen = basalRegimens[key];
                const div = document.createElement('div');
                let optionsHtml = '';
                if (regimen.hasOptions) {
                    const presetOptions = regimen.presets.map(p => `<option value="${p}">${p}</option>`).join('');
                    optionsHtml = `
                        <div class="drip-options space-y-2 mt-2">
                            <div class="grid grid-cols-[auto,1fr] gap-x-2 gap-y-2 items-center">
                                <label for="${regimen.drug}-iv-drip-concentration" class="text-sm">Concentration:</label>
                                <div class="flex items-center gap-2">
                                    <select id="${regimen.drug}-iv-drip-concentration" class="input-field !w-28">${presetOptions}<option value="other">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option></select>
                                    <input type="text" id="${regimen.drug}-iv-drip-concentration-custom" class="input-field !w-24 hidden" placeholder="1:x">
                                </div>
                                <label for="${regimen.drug}-iv-drip-duration" class="text-sm">Duration:</label>
                                <div class="flex items-center gap-2">
                                    <input type="number" id="${regimen.drug}-iv-drip-duration" value="24" class="input-field !w-24">
                                    <span class="text-sm">hr</span>
                                </div>
                            </div>
                            <p class="text-sm text-gray-600">Calculated Volume: <span id="${regimen.drug}-iv-drip-volume" class="font-bold">0.0 mL</span></p>
                            <p class="text-sm text-gray-600">Calculated Rate: <span id="${regimen.drug}-iv-drip-rate" class="font-bold">0.0 mL/hr</span></p>
                        </div>
                    `;
                }
                div.innerHTML = `
                    <input type="radio" id="${key}" name="basal-regimen" ${index === 0 ? 'checked' : ''} data-order-text="">
                    <label for="${key}" class="radio-label font-semibold"><span>${regimen.label}</span><span id="${key}-val" class="font-bold text-cyan-700">0.0</span></label>
                    ${optionsHtml}
                `;
                basalOptionsContainer.appendChild(div);
                document.getElementById(key).addEventListener('change', updateOrderPreview);
            });
            
            ['morphine', 'fentanyl'].forEach(drug => {
                const concentrationSelect = document.getElementById(`${drug}-iv-drip-concentration`);
                const customInput = document.getElementById(`${drug}-iv-drip-concentration-custom`);
                concentrationSelect.addEventListener('change', (e) => {
                    customInput.classList.toggle('hidden', e.target.value !== 'other');
                    updateIvDripOrder(drug);
                });
                customInput.addEventListener('input', () => updateIvDripOrder(drug));
                document.getElementById(`${drug}-iv-drip-duration`).addEventListener('input', () => updateIvDripOrder(drug));
            });


            Object.keys(PRN_REGIMENS).forEach((key, index) => {
                const { label } = PRN_REGIMENS[key];
                const div = document.createElement('div');
                div.innerHTML = `
                    <input type="radio" id="${key}" name="prn-regimen" ${index === 0 ? 'checked' : ''} data-order-text="">
                    <label for="${key}" class="radio-label font-semibold"><span>${label}</span><span id="${key}-val" class="float-right font-bold text-cyan-700">0.0</span></label>
                `;
                prnOptionsContainer.appendChild(div);
                document.getElementById(key).addEventListener('change', updateOrderPreview);
            });

            document.getElementById('prn-toggle-button').addEventListener('click', (e) => {
                const button = e.currentTarget;
                button.classList.toggle('active');
                button.querySelector('.toggle-switch-handle').classList.toggle('translate-x-full');
                document.getElementById('prn-given-section').classList.toggle('hidden');
                if (!button.classList.contains('active')) {
                    document.querySelectorAll('#prn-given-section input[type="number"]').forEach(input => input.value = '');
                }
                calculateAll();
            });

            document.querySelectorAll('.percent-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const escalationInput = document.getElementById('dose-escalation-percent');
                    const currentButton = e.target;
                    
                    if (currentButton.classList.contains('active')) {
                        currentButton.classList.remove('active');
                        escalationInput.value = 0;
                    } else {
                        document.querySelectorAll('.percent-button.active').forEach(b => b.classList.remove('active'));
                        currentButton.classList.add('active');
                        escalationInput.value = currentButton.dataset.percent;
                    }
                    calculateAll();
                });
            });
            document.getElementById('dose-escalation-percent').addEventListener('input', () => {
                 document.querySelectorAll('.percent-button.active').forEach(b => b.classList.remove('active'));
                 calculateAll();
            });

            document.getElementById('reset-button').addEventListener('click', resetAll);
            document.getElementById('test-button').addEventListener('click', randomizeInputs);
        }

        document.addEventListener('DOMContentLoaded', () => {
            createUiElements();
            calculateAll();
            document.getElementById('copy-order-button').addEventListener('click', copyOrderToClipboard);
        });
    </script>
</body>
</html>
