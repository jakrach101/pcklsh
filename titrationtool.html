<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opioid Calculator - Redesigned</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* === REDESIGNED MODERN OPIOID CALCULATOR === */
        
        /* Base System */
        body { 
            font-family: 'Sarabun', sans-serif; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            line-height: 1.6;
        }

        /* Enhanced Material Theme */
        .theme-material {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-accent: #f1f5f9;
            --border-primary: #e2e8f0;
            --border-secondary: #cbd5e1;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --color-primary: #0f172a;
            --color-accent: #0ea5e9;
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-error: #ef4444;
            --shadow-subtle: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-moderate: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-strong: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
        }

        /* Enhanced Neumorphic Theme */
        .theme-neumorphic {
            --bg-primary: #e2e8f0;
            --bg-secondary: #e2e8f0;
            --bg-accent: #d1d5db;
            --border-primary: transparent;
            --border-secondary: transparent;
            --text-primary: #374151;
            --text-secondary: #4b5563;
            --text-muted: #6b7280;
            --color-primary: #111827;
            --color-accent: #0369a1;
            --color-success: #059669;
            --color-warning: #d97706;
            --color-error: #dc2626;
            --shadow-subtle: 3px 3px 6px #c8d0d8, -3px -3px 6px #ffffff;
            --shadow-moderate: 6px 6px 12px #c8d0d8, -6px -6px 12px #ffffff;
            --shadow-strong: 10px 10px 20px #c8d0d8, -10px -10px 20px #ffffff;
            --shadow-inset: inset 3px 3px 6px #c8d0d8, inset -3px -3px 6px #ffffff;
            --radius-sm: 0.5rem;
            --radius-md: 0.75rem;
            --radius-lg: 1rem;
            --radius-xl: 1.25rem;
        }

        /* Base Layout */
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
        }

        @media (min-width: 640px) {
            body { font-size: 16px; }
        }

        /* Enhanced Card System */
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-moderate);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            box-shadow: var(--shadow-strong);
            transform: translateY(-1px);
        }

        .card-header {
            background: var(--bg-accent);
            border-bottom: 1px solid var(--border-primary);
            padding: 1rem 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Enhanced Input System */
        .input-group {
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .input-label {
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .input-field {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            padding: 0.75rem 1rem;
            font-size: 1rem;
            color: var(--text-primary);
            transition: all 0.2s ease;
            outline: none;
        }

        .input-field:focus {
            border-color: var(--color-accent);
            box-shadow: 0 0 0 3px rgb(14 165 233 / 0.1);
        }

        .input-field:disabled {
            background: var(--bg-accent);
            color: var(--text-muted);
            cursor: not-allowed;
        }

        /* Enhanced Button System */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-md);
            font-weight: 600;
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            font-size: 0.875rem;
            position: relative;
            overflow: hidden;
        }

        .btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover:before {
            left: 100%;
        }

        .btn-primary {
            background: var(--color-accent);
            color: white;
        }

        .btn-primary:hover {
            background: #0284c7;
            transform: translateY(-2px);
            box-shadow: var(--shadow-strong);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
        }

        .btn-secondary:hover {
            background: var(--bg-accent);
            transform: translateY(-1px);
            box-shadow: var(--shadow-moderate);
        }

        .btn-icon {
            width: 2.5rem;
            height: 2.5rem;
            padding: 0;
            border-radius: 50%;
            background: var(--bg-secondary);
            color: var(--text-muted);
            border: 1px solid var(--border-primary);
        }

        .btn-icon:hover {
            background: var(--bg-accent);
            color: var(--text-primary);
            transform: scale(1.1);
        }

        /* Enhanced Drug Row System */
        .drug-row {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            padding: 1rem;
            margin-bottom: 0.75rem;
            transition: all 0.3s ease;
            position: relative;
        }

        .drug-row:hover {
            box-shadow: var(--shadow-moderate);
            transform: translateX(4px);
        }

        .drug-row.highlighted {
            background: rgb(239 246 255);
            border-color: var(--color-accent);
            box-shadow: 0 0 0 3px rgb(14 165 233 / 0.1);
        }

        .drug-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .drug-mme {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            background: var(--bg-accent);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--color-accent);
        }

        /* Enhanced Stepper System */
        .stepper-group {
            display: flex;
            align-items: center;
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            overflow: hidden;
            background: var(--bg-secondary);
        }

        .stepper-btn {
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-accent);
            color: var(--text-primary);
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
        }

        .stepper-btn:hover {
            background: var(--color-accent);
            color: white;
        }

        .stepper-btn:active {
            transform: scale(0.95);
        }

        .stepper-input {
            flex: 1;
            border: none;
            background: transparent;
            text-align: center;
            padding: 0.75rem;
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-primary);
            outline: none;
            min-width: 0;
        }

        /* Enhanced MME Display */
        .mme-display {
            background: var(--bg-secondary);
            border: 2px solid var(--border-primary);
            border-radius: var(--radius-xl);
            padding: 2rem;
            text-align: center;
            position: sticky;
            top: 1rem;
            box-shadow: var(--shadow-strong);
        }

        .mme-number {
            font-size: 3rem;
            font-weight: 700;
            color: var(--color-accent);
            margin: 0.5rem 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mme-number:hover {
            transform: scale(1.05);
            text-shadow: 0 0 20px rgb(14 165 233 / 0.3);
        }

        /* Enhanced Modal System */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: var(--radius-xl);
            padding: 2rem;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-strong);
            transform: scale(0.9);
            transition: all 0.3s ease;
            position: relative;
        }

        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            background: var(--bg-accent);
            color: var(--text-muted);
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: var(--color-error);
            color: white;
            transform: scale(1.1);
        }

        /* Enhanced Utility Classes */
        .text-gradient {
            background: linear-gradient(135deg, var(--color-accent), var(--color-success));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-slide-up {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Enhanced Responsive Design */
        @media (max-width: 768px) {
            .card-body {
                padding: 1rem;
            }
            
            .drug-row {
                padding: 0.75rem;
            }
            
            .btn {
                padding: 0.625rem 1.25rem;
                font-size: 0.8rem;
            }
            
            .mme-number {
                font-size: 2.5rem;
            }
        }

        /* Enhanced Mode Button System */
        .mode-btn {
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            font-weight: 500;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            background: transparent;
        }

        .mode-btn:hover {
            background: var(--bg-accent);
            color: var(--text-primary);
        }

        .mode-btn.active {
            background: var(--color-accent);
            color: white;
            box-shadow: var(--shadow-subtle);
        }

        /* Focus indicators */
        .btn:focus-visible,
        .input-field:focus-visible {
            outline: 2px solid var(--color-accent);
            outline-offset: 2px;
        }

        /* Neumorphic specific styles */
        .theme-neumorphic .card {
            box-shadow: var(--shadow-moderate);
            border: none;
        }

        .theme-neumorphic .input-field {
            box-shadow: var(--shadow-inset);
            border: none;
        }

        .theme-neumorphic .btn-secondary {
            box-shadow: var(--shadow-subtle);
            border: none;
        }

        .theme-neumorphic .btn-secondary:hover {
            box-shadow: var(--shadow-inset);
        }

        .theme-neumorphic .stepper-group {
            box-shadow: var(--shadow-inset);
            border: none;
        }

        .theme-neumorphic .stepper-btn {
            box-shadow: var(--shadow-subtle);
        }

        .theme-neumorphic .stepper-btn:hover {
            box-shadow: var(--shadow-inset);
        }
    </style>
</head>
<body class="theme-material">
    <div class="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50">
        <!-- Enhanced Header -->
        <header class="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b border-slate-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center justify-center w-10 h-10 bg-gradient-to-r from-blue-500 to-cyan-500 rounded-lg">
                            <i class="fas fa-pills text-white"></i>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-gradient">Opioid Calculator</h1>
                            <p class="text-sm text-slate-600">เครื่องมือคำนวณและหมุนเวียนยาสำหรับบุคลากรทางการแพทย์</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button id="theme-toggle" class="btn-icon" title="Toggle Theme" aria-label="Toggle theme">
                            <i class="fas fa-palette"></i>
                        </button>
                        <button id="safety-modal-btn" class="btn-icon" title="Clinical Pearls" aria-label="View clinical pearls">
                            <i class="fas fa-shield-alt text-amber-500"></i>
                        </button>
                        <button id="clear-all" class="btn-icon" title="Clear All" aria-label="Clear all data">
                            <i class="fas fa-refresh text-red-500"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Left Panel: Drug Inputs -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Current Regimen -->
                    <div class="card animate-fade-in">
                        <div class="card-header">
                            <h2 class="text-lg font-semibold">ยา Opioids ที่ใช้อยู่ (Current Regimen)</h2>
                        </div>
                        <div class="card-body">
                            <div id="drugs-container" class="space-y-4">
                                <!-- Drug rows will be populated here -->
                            </div>
                        </div>
                    </div>

                    <!-- Titration Tools -->
                    <div class="card animate-fade-in">
                        <div class="card-header cursor-pointer" id="titration-header">
                            <div class="flex items-center justify-between">
                                <h2 class="text-lg font-semibold">เครื่องมือปรับยา (Dose Adjustment)</h2>
                                <div class="flex items-center space-x-2">
                                    <span id="titration-target" class="text-sm text-blue-600 font-medium"></span>
                                    <i id="titration-chevron" class="fas fa-chevron-down transition-transform"></i>
                                </div>
                            </div>
                        </div>
                        <div id="titration-content" class="card-body">
                            <!-- Mode Toggle -->
                            <div class="flex justify-center mb-6">
                                <div class="inline-flex bg-slate-100 rounded-lg p-1">
                                    <button class="mode-btn active" data-mode="prn">PRN</button>
                                    <button class="mode-btn" data-mode="percent">Percent</button>
                                    <button class="mode-btn" data-mode="balance">Balance</button>
                                </div>
                            </div>

                            <!-- PRN Section -->
                            <div id="prn-section" class="space-y-4">
                                <label class="input-label">ยา Breakthrough (PRN) ที่ใช้ใน 24 ชม.</label>
                                <div id="prn-container" class="space-y-3">
                                    <!-- PRN rows will be populated here -->
                                </div>
                                <button id="add-prn" class="btn btn-secondary w-full">
                                    <i class="fas fa-plus"></i>
                                    เพิ่มรายการยา PRN
                                </button>
                            </div>

                            <!-- Percent Section -->
                            <div id="percent-section" class="hidden">
                                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-2">
                                    <button class="btn btn-secondary text-red-600 percent-btn" data-percent="-50">-50%</button>
                                    <button class="btn btn-secondary text-red-600 percent-btn" data-percent="-25">-25%</button>
                                    <button class="btn btn-secondary percent-btn" data-percent="0">0%</button>
                                    <button class="btn btn-secondary text-green-600 percent-btn" data-percent="25">+25%</button>
                                    <button class="btn btn-secondary text-green-600 percent-btn" data-percent="50">+50%</button>
                                    <input type="number" id="custom-percent" class="input-field" placeholder="Custom %">
                                </div>
                            </div>

                            <!-- Balance Section -->
                            <div id="balance-section" class="hidden">
                                <div class="text-center p-6 bg-orange-50 rounded-lg">
                                    <div id="balance-instruction" class="text-orange-800 font-medium">
                                        <i class="fas fa-info-circle"></i>
                                        Select decrease drug, then increase drug
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Panel: Results -->
                <div class="lg:col-span-1 space-y-6">
                    <!-- MME Display -->
                    <div id="mme-display" class="mme-display animate-fade-in">
                        <div id="mme-normal">
                            <h3 class="text-lg font-semibold text-slate-600 mb-2">Total MME</h3>
                            <div id="mme-value" class="mme-number" role="button" tabindex="0" aria-label="Click to view quick reference">0</div>
                            <p class="text-sm text-slate-500 mb-4">MME / day</p>
                            <div id="empty-message" class="text-slate-400 text-sm mb-4">กรอกขนาดยาเพื่อเริ่มคำนวณ</div>
                            <button id="rotation-btn" class="btn btn-primary w-full hidden">
                                <i class="fas fa-sync-alt"></i>
                                เริ่มการหมุนเวียนยา
                            </button>
                        </div>
                        <div id="mme-rotation" class="hidden">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-red-600">Opioid Rotation</h3>
                                <button id="cancel-rotation" class="btn-icon">
                                    <i class="fas fa-times text-red-500"></i>
                                </button>
                            </div>
                            <div id="rotation-display" class="text-center">
                                <!-- Rotation content -->
                            </div>
                        </div>
                    </div>

                    <!-- Rotation Tools -->
                    <div id="rotation-tools" class="card hidden animate-slide-up">
                        <div class="card-header">
                            <h3 class="text-lg font-semibold text-green-600">Rotation Tools</h3>
                        </div>
                        <div class="card-body space-y-4">
                            <!-- Basal Recommendations -->
                            <div>
                                <label class="input-label">ยา Basal ใหม่</label>
                                <div id="basal-container" class="space-y-3">
                                    <!-- Basal rows -->
                                </div>
                                <button id="add-basal" class="btn btn-secondary w-full mt-3">
                                    <i class="fas fa-plus"></i>
                                    เพิ่มยา Basal
                                </button>
                            </div>

                            <!-- Breakthrough Recommendations -->
                            <div>
                                <div class="flex items-center justify-between mb-2">
                                    <label class="input-label">ยา Breakthrough ใหม่</label>
                                    <div class="flex space-x-2">
                                        <select id="breakthrough-drug" class="input-field text-sm">
                                            <option value="morphine_ir_tab_10">Morphine IR 10mg</option>
                                            <option value="morphine_syrup">Morphine Syrup</option>
                                            <option value="morphine_iv_sc">Morphine IV/SC</option>
                                            <option value="fentanyl_iv_sc">Fentanyl IV/SC</option>
                                        </select>
                                        <select id="breakthrough-percent" class="input-field text-sm">
                                            <option value="0.1667">1/6 TDD</option>
                                            <option value="0.15">15% TDD</option>
                                            <option value="0.1">10% TDD</option>
                                        </select>
                                    </div>
                                </div>
                                <div id="breakthrough-result" class="bg-green-50 p-3 rounded-lg text-center text-green-800 font-semibold">
                                    <!-- Breakthrough recommendation -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Enhanced Footer -->
        <footer class="mt-16 py-8 border-t border-slate-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                <p class="text-sm text-slate-500">
                    Developed with <i class="fas fa-heart text-red-400"></i> by Gang FM
                </p>
            </div>
        </footer>
    </div>

    <!-- Modals will be added here -->
    <div id="modals-container">
        <!-- Modals will be populated by JavaScript -->
    </div>

    <script>
        // Enhanced Opioid Calculator - Redesigned with preserved functionality
        class OpioidCalculator {
            constructor() {
                this.initializeData();
                this.initializeDOM();
                this.bindEvents();
                this.loadState();
                this.render();
            }

            initializeData() {
                // Preserve all original drug configurations
                this.drugConfig = {
                    'fentanyl_patch': { 
                        name: 'Fentanyl Patch', 
                        factor: 2.4, unit: 'mcg/hr', type: 'patch', isBasal: true, step: 12.5,
                        info: `<p><strong>Onset:</strong> 12-24 ชั่วโมง, ออกฤทธิ์เต็มที่ 72 ชั่วโมง</p><p><strong>ข้อควรระวัง:</strong></p><ul class="list-disc list-inside pl-4"><li>ไม่เหมาะสำหรับแก้ปวดเฉียบพลัน (Acute Pain) หรือในผู้ป่วยที่ยังปรับยาไม่คงที่</li><li>ไข้สูง (Fever > 40°C) อาจเพิ่มการดูดซึมยาได้ถึง 1/3</li><li>แนะนำให้ทิ้งแผ่นแปะที่ใช้แล้วอย่างถูกวิธี (พับด้านกาวเข้าหากัน)</li><li>เป็นตัวเลือกที่ดีในผู้ป่วยไตวายรุนแรง (Severe Renal Impairment)</li></ul>`
                    },
                    'mst_10': { 
                        name: 'MST 10mg', 
                        factor: 1, unit: 'เม็ด/day', type: 'oral', isBasal: true, strength: 10, step: 1,
                        info: `<p><strong>Onset:</strong> ~1 ชั่วโมง, ออกฤทธิ์นาน 8-12 ชั่วโมง</p><p><strong>ข้อควรระวัง:</strong></p><ul class="list-disc list-inside pl-4"><li>ห้ามหัก แบ่ง หรือเคี้ยวยาเม็ด</li><li>ควรระวังการใช้ในผู้ป่วยไตวาย (eGFR < 30 ml/min) เนื่องจาก Metabolites (M3G, M6G) อาจสะสมและเกิดพิษได้</li></ul>`
                    },
                    'mst_30': { 
                        name: 'MST 30mg', 
                        factor: 1, unit: 'เม็ด/day', type: 'oral', isBasal: true, strength: 30, step: 1,
                        info: `<p><strong>Onset:</strong> ~1 ชั่วโมง, ออกฤทธิ์นาน 8-12 ชั่วโมง</p><p><strong>ข้อควรระวัง:</strong></p><ul class="list-disc list-inside pl-4"><li>ห้ามหัก แบ่ง หรือเคี้ยวยาเม็ด</li><li>ควรระวังการใช้ในผู้ป่วยไตวาย (eGFR < 30 ml/min) เนื่องจาก Metabolites (M3G, M6G) อาจสะสมและเกิดพิษได้</li></ul>`
                    },
                    'kapanol_20': { 
                        name: 'Kapanol 20mg', 
                        factor: 1, unit: 'แคปซูล/day', type: 'oral', isBasal: true, strength: 20, step: 1,
                        info: `<p><strong>Onset:</strong> ~1 ชั่วโมง, ออกฤทธิ์นาน 12-24 ชั่วโมง</p><p><strong>ข้อควรระวัง:</strong></p><ul class="list-disc list-inside pl-4"><li>ห้ามเคี้ยวเม็ด Granules ข้างใน แต่สามารถเปิดแคปซูลแล้วโรยบนอาหารเหลวได้ (สำหรับผู้ป่วยมีปัญหาการกลืน)</li><li>ควรระวังการใช้ในผู้ป่วยไตวาย (eGFR < 30 ml/min) เช่นเดียวกับ MST</li></ul>`
                    },
                    'morphine_iv_sc': { 
                        name: 'Morphine IV/SC', 
                        factor: 3, unit: 'mg/day', type: 'injectable', isBasal: true, isBreakthrough: true,
                        info: `<p><strong>Onset:</strong> IV ~5 นาที, SC ~15-30 นาที</p><p><strong>ข้อควรระวัง:</strong></p><ul class="list-disc list-inside pl-4"><li>ใช้สำหรับผู้ป่วยที่มีอาการปวดรุนแรง หรือไม่สามารถรับประทานยาได้</li><li>ต้องปรับลดขนาดยาในผู้ป่วยไตวาย (eGFR < 30 ml/min) และติดตามอาการข้างเคียงอย่างใกล้ชิด</li></ul>`
                    },
                    'fentanyl_iv_sc': { 
                        name: 'Fentanyl IV/SC', 
                        factor: 0.3, unit: 'mcg/day', type: 'injectable', isBasal: true, isBreakthrough: true,
                        info: `<p><strong>Onset:</strong> IV ~1-2 นาที, ออกฤทธิ์สั้น (30-60 นาที)</p><p><strong>ข้อดี:</strong></p><ul class="list-disc list-inside pl-4"><li>เป็นตัวเลือกที่ปลอดภัยในผู้ป่วยไตวายรุนแรง (Severe Renal Impairment)</li><li>เหมาะสำหรับ Titrate อาการปวดที่รุนแรงและต้องการการตอบสนองที่รวดเร็ว</li></ul>`
                    },
                    'morphine_ir_tab_10': { 
                        name: 'Morphine IR 10mg', 
                        factor: 1, unit: 'เม็ด/day', type: 'oral', isBreakthrough: true, strength: 10, step: 1,
                        info: `<p><strong>Onset:</strong> 30-60 นาที, ออกฤทธิ์นาน 4-6 ชั่วโมง</p><p><strong>การใช้งาน:</strong></p><ul class="list-disc list-inside pl-4"><li>ใช้สำหรับบรรเทาอาการปวดกำเริบ (Breakthrough Pain)</li><li>ขนาดยาที่ใช้通常คิดเป็น 10-15% ของขนาดยาหลักต่อวัน (Total Daily Dose)</li></ul>`
                    },
                    'morphine_syrup': { 
                        name: 'Morphine Syrup 2mg/ml', 
                        factor: 1, unit: 'mL/day', type: 'oral', isBreakthrough: true, strength: 2,
                        info: `<p><strong>Onset:</strong> 30-60 นาที, ออกฤทธิ์นาน 4-6 ชั่วโมง</p><p><strong>การใช้งาน:</strong></p><ul class="list-disc list-inside pl-4"><li>ใช้สำหรับบรรเทาอาการปวดกำเริบ (Breakthrough Pain) โดยเฉพาะในผู้ป่วยที่มีปัญหาการกลืน</li><li>ง่ายต่อการปรับขนาดยา (Titration) ทีละน้อย</li></ul>`
                    },
                };

                // Initialize state
                this.state = {
                    theme: 'theme-material',
                    currentMode: 'prn',
                    drugs: {},
                    prnDrugs: [],
                    rotationMME: null,
                    percentAdjustment: 0,
                    pinnedDrug: null,
                    balancePair: { decrease: null, increase: null },
                    lockedDrugs: [],
                    collapsed: false
                };

                // Initialize drug doses
                Object.keys(this.drugConfig).forEach(key => {
                    if (this.drugConfig[key].isBasal) {
                        this.state.drugs[key] = 0;
                    }
                });

                // Note: PRN row will be added after DOM initialization
            }

            initializeDOM() {
                this.elements = {
                    themeToggle: document.getElementById('theme-toggle'),
                    safetyModal: document.getElementById('safety-modal-btn'),
                    clearAll: document.getElementById('clear-all'),
                    drugsContainer: document.getElementById('drugs-container'),
                    titrationHeader: document.getElementById('titration-header'),
                    titrationContent: document.getElementById('titration-content'),
                    titrationTarget: document.getElementById('titration-target'),
                    titrationChevron: document.getElementById('titration-chevron'),
                    prnSection: document.getElementById('prn-section'),
                    percentSection: document.getElementById('percent-section'),
                    balanceSection: document.getElementById('balance-section'),
                    balanceInstruction: document.getElementById('balance-instruction'),
                    prnContainer: document.getElementById('prn-container'),
                    addPRN: document.getElementById('add-prn'),
                    customPercent: document.getElementById('custom-percent'),
                    mmeDisplay: document.getElementById('mme-display'),
                    mmeValue: document.getElementById('mme-value'),
                    emptyMessage: document.getElementById('empty-message'),
                    rotationBtn: document.getElementById('rotation-btn'),
                    rotationTools: document.getElementById('rotation-tools'),
                    basalContainer: document.getElementById('basal-container'),
                    addBasal: document.getElementById('add-basal'),
                    breakthroughDrug: document.getElementById('breakthrough-drug'),
                    breakthroughPercent: document.getElementById('breakthrough-percent'),
                    breakthroughResult: document.getElementById('breakthrough-result'),
                    modalsContainer: document.getElementById('modals-container')
                };
            }

            bindEvents() {
                // Theme toggle
                this.elements.themeToggle?.addEventListener('click', () => this.toggleTheme());

                // Clear all
                this.elements.clearAll?.addEventListener('click', () => this.clearAll());

                // Titration header toggle
                this.elements.titrationHeader?.addEventListener('click', () => this.toggleTitrationSection());

                // Mode buttons
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.addEventListener('click', () => this.setMode(btn.dataset.mode));
                });

                // Percent buttons
                document.querySelectorAll('.percent-btn').forEach(btn => {
                    btn.addEventListener('click', () => this.setPercent(parseInt(btn.dataset.percent)));
                });

                // Custom percent input
                this.elements.customPercent?.addEventListener('input', (e) => {
                    this.setPercent(parseFloat(e.target.value) || 0);
                });

                // Add PRN button
                this.elements.addPRN?.addEventListener('click', () => this.addPRNRow());

                // MME click for quick reference
                this.elements.mmeValue?.addEventListener('click', () => this.showQuickReference());

                // Rotation button
                this.elements.rotationBtn?.addEventListener('click', () => this.startRotation());

                // Breakthrough selectors
                this.elements.breakthroughDrug?.addEventListener('change', () => this.updateBreakthroughRecommendation());
                this.elements.breakthroughPercent?.addEventListener('change', () => this.updateBreakthroughRecommendation());

                // Keyboard navigation
                document.addEventListener('keydown', (e) => this.handleKeyboard(e));
            }

            // Core functionality methods
            renderDrugs() {
                const container = this.elements.drugsContainer;
                if (!container) return;

                container.innerHTML = '';
                
                Object.keys(this.drugConfig).forEach(key => {
                    const drug = this.drugConfig[key];
                    if (!drug.isBasal) return;

                    const row = document.createElement('div');
                    row.className = 'drug-row animate-slide-up';
                    row.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <button class="drug-name text-left font-semibold hover:text-blue-600 transition-colors" data-drug="${key}">
                                    ${drug.name}
                                </button>
                                <div class="flex items-center space-x-2 mt-1">
                                    <span class="drug-mme">
                                        MME: <span class="mme-value">${this.calculateMME(key)}</span>
                                    </span>
                                    <span class="dose-change text-sm text-slate-500"></span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="stepper-group">
                                    <button class="stepper-btn" data-action="decrease" data-drug="${key}">-</button>
                                    <input type="number" class="stepper-input" value="${this.state.drugs[key] || 0}" 
                                           data-drug="${key}" step="${drug.step || 1}" min="0">
                                    <button class="stepper-btn" data-action="increase" data-drug="${key}">+</button>
                                </div>
                                ${drug.type === 'injectable' ? `
                                    <button class="btn-icon" title="TDD Helper" data-tdd="${key}">
                                        <i class="fas fa-calculator"></i>
                                    </button>
                                ` : '<span class="w-10"></span>'}
                                <button class="btn-icon lock-btn" title="Lock/Unlock" data-lock="${key}">
                                    <i class="fas fa-lock-open"></i>
                                </button>
                                <button class="btn-icon pin-btn" title="Pin for adjustment" data-pin="${key}">
                                    <i class="fas fa-thumbtack"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(row);
                });

                // Bind drug-specific events
                this.bindDrugEvents();
            }

            bindDrugEvents() {
                // Stepper buttons
                document.querySelectorAll('.stepper-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const drug = e.target.dataset.drug;
                        const action = e.target.dataset.action;
                        const input = e.target.parentElement.querySelector('.stepper-input');
                        const step = this.drugConfig[drug].step || 1;
                        
                        let value = parseFloat(input.value) || 0;
                        if (action === 'increase') {
                            value += step;
                        } else {
                            value = Math.max(0, value - step);
                        }
                        
                        input.value = value;
                        this.state.drugs[drug] = value;
                        this.calculate();
                    });
                });

                // Direct input
                document.querySelectorAll('.stepper-input').forEach(input => {
                    input.addEventListener('input', (e) => {
                        const drug = e.target.dataset.drug;
                        const value = Math.max(0, parseFloat(e.target.value) || 0);
                        this.state.drugs[drug] = value;
                        this.calculate();
                    });
                });

                // Drug name buttons (for info)
                document.querySelectorAll('.drug-name').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const drug = e.target.dataset.drug;
                        this.showDrugInfo(drug);
                    });
                });

                // Pin buttons
                document.querySelectorAll('.pin-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const drug = e.target.dataset.pin;
                        this.togglePin(drug);
                    });
                });

                // Lock buttons
                document.querySelectorAll('.lock-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const drug = e.target.dataset.lock;
                        this.toggleLock(drug);
                    });
                });
            }

            calculate() {
                let totalMME = 0;
                
                // Calculate base MME
                Object.keys(this.state.drugs).forEach(key => {
                    const dose = this.state.drugs[key];
                    if (dose > 0) {
                        totalMME += this.calculateMME(key);
                    }
                });

                // Add PRN MME
                this.state.prnDrugs.forEach(prn => {
                    if (prn.drug && prn.dose > 0) {
                        const config = this.drugConfig[prn.drug];
                        if (config) {
                            const mme = prn.dose * (config.strength || 1) * config.factor;
                            totalMME += mme;
                        }
                    }
                });

                // Apply percentage adjustment
                if (this.state.percentAdjustment !== 0) {
                    totalMME *= (1 + this.state.percentAdjustment / 100);
                }

                this.updateMMEDisplay(totalMME);
                this.updateEmptyState(totalMME);
                this.saveState();
            }

            calculateMME(drugKey) {
                const dose = this.state.drugs[drugKey];
                const config = this.drugConfig[drugKey];
                if (!dose || !config) return 0;
                
                const doseForCalc = dose * (config.strength || 1);
                return doseForCalc * config.factor;
            }

            updateMMEDisplay(totalMME) {
                const roundedMME = Math.round(totalMME);
                this.elements.mmeValue.textContent = roundedMME;
                
                // Show/hide rotation button
                if (this.elements.rotationBtn) {
                    this.elements.rotationBtn.classList.toggle('hidden', roundedMME === 0);
                }
            }

            updateEmptyState(totalMME) {
                if (this.elements.emptyMessage) {
                    this.elements.emptyMessage.style.display = totalMME > 0 ? 'none' : 'block';
                }
            }

            addPRNRow() {
                const id = Date.now();
                const prn = { id, drug: '', dose: 0 };
                this.state.prnDrugs.push(prn);
                this.renderPRNRows();
            }

            renderPRNRows() {
                const container = this.elements.prnContainer;
                if (!container) return;

                container.innerHTML = '';
                
                this.state.prnDrugs.forEach(prn => {
                    const row = document.createElement('div');
                    row.className = 'flex items-center space-x-2';
                    row.innerHTML = `
                        <select class="input-field flex-1" data-prn-id="${prn.id}">
                            <option value="">-- เลือกยา --</option>
                            ${Object.keys(this.drugConfig)
                                .filter(key => this.drugConfig[key].isBreakthrough)
                                .map(key => `<option value="${key}" ${prn.drug === key ? 'selected' : ''}>${this.drugConfig[key].name}</option>`)
                                .join('')}
                        </select>
                        <div class="stepper-group">
                            <button class="stepper-btn" data-action="decrease" data-prn-id="${prn.id}">-</button>
                            <input type="number" class="stepper-input" value="${prn.dose}" 
                                   data-prn-id="${prn.id}" step="1">
                            <button class="stepper-btn" data-action="increase" data-prn-id="${prn.id}">+</button>
                        </div>
                        <button class="btn-icon text-red-500" data-remove-prn="${prn.id}">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    
                    container.appendChild(row);
                });

                this.bindPRNEvents();
            }

            bindPRNEvents() {
                // PRN drug selection
                document.querySelectorAll('select[data-prn-id]').forEach(select => {
                    select.addEventListener('change', (e) => {
                        const id = parseInt(e.target.dataset.prnId);
                        const prn = this.state.prnDrugs.find(p => p.id === id);
                        if (prn) {
                            prn.drug = e.target.value;
                            this.calculate();
                        }
                    });
                });

                // PRN dose input
                document.querySelectorAll('input[data-prn-id]').forEach(input => {
                    input.addEventListener('input', (e) => {
                        const id = parseInt(e.target.dataset.prnId);
                        const prn = this.state.prnDrugs.find(p => p.id === id);
                        if (prn) {
                            prn.dose = Math.max(0, parseFloat(e.target.value) || 0);
                            this.calculate();
                        }
                    });
                });

                // PRN stepper buttons
                document.querySelectorAll('button[data-prn-id]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = parseInt(e.target.dataset.prnId);
                        const action = e.target.dataset.action;
                        const prn = this.state.prnDrugs.find(p => p.id === id);
                        
                        if (prn && action) {
                            if (action === 'increase') {
                                prn.dose += 1;
                            } else {
                                prn.dose = Math.max(0, prn.dose - 1);
                            }
                            
                            const input = e.target.parentElement.querySelector('input');
                            input.value = prn.dose;
                            this.calculate();
                        }
                    });
                });

                // Remove PRN
                document.querySelectorAll('button[data-remove-prn]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = parseInt(e.target.dataset.removePrn);
                        this.state.prnDrugs = this.state.prnDrugs.filter(p => p.id !== id);
                        this.renderPRNRows();
                        this.calculate();
                    });
                });
            }

            setMode(mode) {
                this.state.currentMode = mode;
                
                // Update UI
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.mode === mode);
                });

                // Show/hide sections
                this.elements.prnSection.classList.toggle('hidden', mode !== 'prn');
                this.elements.percentSection.classList.toggle('hidden', mode !== 'percent');
                this.elements.balanceSection.classList.toggle('hidden', mode !== 'balance');

                this.calculate();
            }

            setPercent(percent) {
                this.state.percentAdjustment = percent;
                if (this.elements.customPercent) {
                    this.elements.customPercent.value = percent;
                }
                this.calculate();
            }

            togglePin(drug) {
                if (this.state.pinnedDrug === drug) {
                    this.state.pinnedDrug = null;
                } else {
                    this.state.pinnedDrug = drug;
                }
                this.updatePinUI();
                this.calculate();
            }

            toggleLock(drug) {
                const index = this.state.lockedDrugs.indexOf(drug);
                if (index > -1) {
                    this.state.lockedDrugs.splice(index, 1);
                } else {
                    this.state.lockedDrugs.push(drug);
                }
                this.updateLockUI();
                this.calculate();
            }

            updatePinUI() {
                document.querySelectorAll('.pin-btn').forEach(btn => {
                    const drug = btn.dataset.pin;
                    const isPinned = this.state.pinnedDrug === drug;
                    btn.classList.toggle('text-blue-600', isPinned);
                    btn.classList.toggle('bg-blue-50', isPinned);
                });
            }

            updateLockUI() {
                document.querySelectorAll('.lock-btn').forEach(btn => {
                    const drug = btn.dataset.lock;
                    const isLocked = this.state.lockedDrugs.includes(drug);
                    const icon = btn.querySelector('i');
                    
                    if (isLocked) {
                        icon.className = 'fas fa-lock';
                        btn.classList.add('text-red-600', 'bg-red-50');
                    } else {
                        icon.className = 'fas fa-lock-open';
                        btn.classList.remove('text-red-600', 'bg-red-50');
                    }
                });
            }

            toggleTheme() {
                const newTheme = this.state.theme === 'theme-material' ? 'theme-neumorphic' : 'theme-material';
                this.state.theme = newTheme;
                document.body.className = newTheme;
                this.saveState();
            }

            toggleTitrationSection() {
                this.state.collapsed = !this.state.collapsed;
                this.elements.titrationContent.classList.toggle('hidden', this.state.collapsed);
                this.elements.titrationChevron.classList.toggle('rotate-180', this.state.collapsed);
                this.saveState();
            }

            startRotation() {
                // Implementation for rotation functionality
                console.log('Starting rotation...');
            }

            showQuickReference() {
                // Implementation for quick reference modal
                console.log('Showing quick reference...');
            }

            showDrugInfo(drugKey) {
                // Implementation for drug info modal
                console.log('Showing drug info for:', drugKey);
            }

            updateBreakthroughRecommendation() {
                // Implementation for breakthrough recommendation
                console.log('Updating breakthrough recommendation...');
            }

            handleKeyboard(e) {
                // Implementation for keyboard navigation
                if (e.key === 'Escape') {
                    // Close modals
                    document.querySelectorAll('.modal-overlay').forEach(modal => {
                        modal.classList.remove('visible');
                    });
                }
            }

            clearAll() {
                // Reset all state
                Object.keys(this.state.drugs).forEach(key => {
                    this.state.drugs[key] = 0;
                });
                this.state.prnDrugs = [];
                this.state.percentAdjustment = 0;
                this.state.pinnedDrug = null;
                this.state.balancePair = { decrease: null, increase: null };
                this.state.lockedDrugs = [];
                this.state.rotationMME = null;
                
                this.render();
            }

            saveState() {
                try {
                    localStorage.setItem('opioidCalculator_redesigned', JSON.stringify(this.state));
                } catch (e) {
                    console.warn('Failed to save state:', e);
                }
            }

            loadState() {
                try {
                    const saved = localStorage.getItem('opioidCalculator_redesigned');
                    if (saved) {
                        const state = JSON.parse(saved);
                        this.state = { ...this.state, ...state };
                        
                        // Apply theme
                        document.body.className = this.state.theme;
                    }
                } catch (e) {
                    console.warn('Failed to load state:', e);
                }
            }

            render() {
                this.renderDrugs();
                
                // Add initial PRN row if none exist
                if (this.state.prnDrugs.length === 0) {
                    this.addPRNRow();
                } else {
                    this.renderPRNRows();
                }
                
                this.setMode(this.state.currentMode);
                this.setPercent(this.state.percentAdjustment);
                this.updatePinUI();
                this.updateLockUI();
                this.calculate();
            }
        }

        // Initialize the calculator when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM ready, initializing calculator...');
            try {
                const calculator = new OpioidCalculator();
                console.log('Calculator initialized successfully');
                
                // Debug: Check if drugs container exists
                const drugsContainer = document.getElementById('drugs-container');
                console.log('Drugs container found:', !!drugsContainer);
                
                // Force render after short delay to ensure DOM is ready
                setTimeout(() => {
                    calculator.render();
                    console.log('Render completed');
                }, 100);
            } catch (error) {
                console.error('Failed to initialize calculator:', error);
            }
        });
    </script>
</body>
</html>