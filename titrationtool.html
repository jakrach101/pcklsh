<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opioid Converter - Unified Palliative Care Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
            padding-top: 90px; /* Space for the sticky header */
        }
        .input-field {
            width: 100%;
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            padding: 0.75rem;
            background-color: white;
            transition: all 0.2s ease-in-out;
        }
        .input-field:focus {
            background-color: white;
            border-color: #0891b2; /* cyan-600 */
            box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.2);
            outline: none;
        }
        .input-field:disabled {
            background-color: #e2e8f0;
            cursor: not-allowed;
        }
        .action-btn {
            background-color: white;
            color: #475569; /* slate-600 */
            font-weight: 600;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0; /* slate-200 */
            transition: all 0.2s;
            flex-grow: 1;
            text-align: center;
        }
        .action-btn.active, .action-btn:hover {
            background-color: #0891b2; /* cyan-600 */
            color: white;
            border-color: #0891b2;
        }
        .adjustment-section { transition: opacity 0.3s; }
        .adjustment-section.disabled { opacity: 0.4; pointer-events: none; }
        
        /* New Styles from Part 34 merged */
        .option-card {
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            height: 100%;
            position: relative;
        }
        .option-card:hover { border-color: #93c5fd; }
        input[type="radio"]:checked + .option-card, input[type="checkbox"]:checked + .option-card {
            border-color: #0891b2;
            background-color: #f0f9ff;
            box-shadow: 0 0 0 2px #0891b2;
        }
        .badge-container { position: absolute; top: 0.5rem; right: 0.5rem; display: flex; gap: 0.25rem; }
        .badge {
            background-color: #fb923c;
            color: white;
            padding: 0.125rem 0.5rem;
            font-size: 0.7rem;
            font-weight: 600;
            border-radius: 9999px;
        }
        .helper-details > summary {
            list-style: none;
            cursor: pointer;
            padding: 0.5rem;
            margin: 0.5rem -0.5rem -0.5rem -0.5rem;
            border-radius: 0.25rem;
            font-weight: 500;
            color: #0369a1;
        }
        .helper-details > summary::-webkit-details-marker { display: none; }
        .helper-details > summary::after { content: '▼'; float: right; transition: transform 0.2s; }
        .helper-details[open] > summary::after { transform: rotate(180deg); }
        .helper-content {
            background-color: #e0f2fe;
            padding: 1rem;
            margin: 0.5rem -1rem -1rem -1rem;
            border-radius: 0 0 0.375rem 0.375rem;
            border-top: 1px solid #bae6fd;
        }
        .copy-button {
            display: flex; align-items: center; justify-content: center; gap: 0.75rem;
            width: 100%; padding: 1rem; border-radius: 0.5rem; background-color: #0d9488;
            color: white; font-weight: 600; cursor: pointer; transition: background-color 0.2s;
        }
        .copy-button:hover { background-color: #0f766e; }
        .copy-button.copied { background-color: #059669; }
        .hidden { display: none; }
        #rotation-outcome-section {
            transition: all 0.5s ease-in-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        #rotation-outcome-section.visible {
            max-height: 2000px; /* A large enough value */
            opacity: 1;
        }
    </style>
</head>
<body class="p-4 md:p-6">

    <header id="summary-banner" class="fixed top-0 left-0 right-0 bg-white/80 backdrop-blur-sm shadow-md z-50 p-3">
        <div class="max-w-4xl mx-auto grid grid-cols-2 gap-4 text-center">
            <div>
                <h3 class="text-sm sm:text-base font-semibold text-cyan-700">Current Total MEDD</h3>
                <p id="current-total-medd-display" class="text-3xl sm:text-4xl font-bold text-cyan-800 tracking-tight">0.0</p>
            </div>
            <div id="new-medd-container" class="transition-opacity duration-500 opacity-0">
                <h3 class="text-sm sm:text-base font-semibold text-green-700">New Total MEDD</h3>
                <p id="new-total-medd-display" class="text-3xl sm:text-4xl font-bold text-green-600 tracking-tight">0.0</p>
            </div>
        </div>
    </header>

    <div class="max-w-6xl mx-auto">
        <main class="space-y-6">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-x-8">
                    
                    <div class="space-y-6">
                        <div class="flex justify-between items-center">
                            <h2 class="text-xl font-bold text-gray-800">ยาที่ได้รับ (Current Medications)</h2>
                             <button id="clear-all-btn" class="bg-red-100 text-red-700 hover:bg-red-200 font-semibold py-2 px-3 rounded-lg transition-colors text-sm">ล้างข้อมูล</button>
                        </div>
                        <div id="current-meds-section" class="space-y-3"></div>
                    </div>
                    
                    <div class="space-y-6 mt-6 lg:mt-0">
                        <h2 class="text-xl font-bold text-gray-800">ปรับยาและเลือกยาใหม่ (Adjust & Rotate)</h2>
                        
                        <div class="p-4 border rounded-lg space-y-4 bg-slate-50">
                             <h3 class="text-lg font-semibold text-gray-700">1. การประเมินผู้ป่วยและความเสี่ยง</h3>
                             <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="age-input" class="font-medium text-sm text-gray-700 block mb-1">อายุ (ปี)</label>
                                    <input type="number" id="age-input" class="input-field" placeholder="เช่น 70">
                                </div>
                                <div>
                                    <label for="gfr-input" class="font-medium text-sm text-gray-700 block mb-1">eGFR (ml/min)</label>
                                    <input type="number" id="gfr-input" class="input-field" placeholder="เช่น 60">
                                </div>
                                 <div>
                                    <label for="pps-score" class="font-medium text-sm text-gray-700 block mb-1">PPS Score (%)</label>
                                    <select id="pps-score" class="input-field">
                                        <option value="100">100</option><option value="90">90</option><option value="80">80</option><option value="70" selected>70</option><option value="60">60</option><option value="50">50</option><option value="40">40</option><option value="30">30</option><option value="20">20</option><option value="10">10</option><option value="0">0</option>
                                    </select>
                                </div>
                             </div>
                             <div id="risk-checklist-section" class="space-y-2 pt-2 border-t">
                                </div>
                             <div id="clinical-recommendation-section" class="hidden mt-2 p-3 bg-orange-50 border-l-4 border-orange-400 rounded">
                                <ul id="clinical-recommendation-list" class="list-disc list-inside text-orange-700 text-sm space-y-1"></ul>
                            </div>
                        </div>

                        <div class="p-4 border rounded-lg space-y-4 bg-slate-50">
                             <div>
                                <h3 class="text-lg font-semibold text-gray-700 mb-3">2. วิธีการปรับเพิ่มยา (Escalation)</h3>
                                <div class="flex gap-4">
                                    <label class="flex-1"><input type="radio" name="adjustment-method" value="prn" checked class="sr-only peer"><div class="w-full text-center p-3 rounded-md border-2 bg-white border-gray-300 peer-checked:border-cyan-500 peer-checked:bg-cyan-50 cursor-pointer">ปรับตาม PRN</div></label>
                                    <label class="flex-1"><input type="radio" name="adjustment-method" value="percent" class="sr-only peer"><div class="w-full text-center p-3 rounded-md border-2 bg-white border-gray-300 peer-checked:border-cyan-500 peer-checked:bg-cyan-50 cursor-pointer">ปรับตาม %</div></label>
                                </div>
                            </div>

                            <div id="prn-adjustment-section" class="adjustment-section space-y-3">
                                <h4 class="font-semibold text-gray-600">ยาเสริม (Breakthrough / PRN)</h4>
                                <div id="prn-inputs-section" class="space-y-3"></div>
                                <p id="prn-warning" class="text-sm text-center text-orange-600 hidden">ใช้ยา PRN ไม่ถึง 3 ครั้ง จะไม่นำมาคำนวณเพิ่มใน New MEDD</p>
                            </div>
                            
                            <div id="percent-adjustment-section" class="adjustment-section space-y-3">
                                <h4 class="font-semibold text-gray-600">ปรับเพิ่มตาม % (Escalate by %)</h4>
                                <div class="grid grid-cols-3 gap-2">
                                    <button class="action-btn percent-btn" data-percent="30">30%</button>
                                    <button class="action-btn percent-btn" data-percent="50">50%</button>
                                    <button class="action-btn percent-btn" data-percent="100">100%</button>
                                </div>
                            </div>
                        </div>

                        <div class="p-4 border rounded-lg space-y-4 bg-slate-50">
                            <h3 class="text-lg font-semibold text-gray-700">3. การปรับลดเพื่อความปลอดภัยโดยรวม</h3>
                            <div id="safety-warning-message" class="hidden p-3 bg-red-100 border-l-4 border-red-500 text-red-800 rounded-r-lg">
                                <p class="font-bold">ตรวจพบปัจจัยเสี่ยง!</p>
                                <p class="text-sm">แนะนำให้พิจารณาปรับลดขนาดยาเพื่อความปลอดภัย</p>
                            </div>
                             <div id="double-dip-warning" class="hidden p-3 bg-amber-100 border-l-4 border-amber-500 text-amber-800 rounded-r-lg">
                                <p class="font-bold">ข้อควรระวัง!</p>
                                <p class="text-sm">ขนาดยาใหม่จะถูกปรับลดตามค่าไต/อายุโดยอัตโนมัติ การลดในส่วนนี้จะเป็นการลดเพิ่มเติมจากส่วนนั้น</p>
                            </div>
                            <div class="grid grid-cols-3 gap-2">
                                <button class="action-btn reduction-btn" data-factor="0.75">-25%</button>
                                <button class="action-btn reduction-btn" data-factor="0.65">-35%</button>
                                <button class="action-btn reduction-btn" data-factor="0.50">-50%</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="rotation-outcome-section" class="bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-xl font-bold text-gray-800 mb-4">4. เลือกยาใหม่และสร้าง Order</h2>
                <div>
                    <h3 class="font-semibold text-lg text-gray-800 mb-3">ยาพื้นฐานใหม่ (New Basal Dose)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="basal-options-section"></div>
                </div>
                <div class="mt-6">
                    <div class="flex flex-wrap justify-between items-center gap-y-2 mb-3">
                        <h3 class="font-semibold text-lg text-gray-800">ยาเสริมใหม่ (New PRN Dose)</h3>
                        <div class="text-sm">
                            <label>คำนวณที่:</label>
                            <select id="prn-calc-method" class="input-field !w-auto !inline-block !p-1">
                                <option value="16.67" selected>1/6 (16.7%)</option>
                                <option value="15">15%</option>
                                <option value="10">10%</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="prn-options-section"></div>
                </div>
            </div>

            <div id="final-order-section" class="bg-white p-6 rounded-lg shadow-lg transition-opacity duration-500 opacity-0">
                <h2 class="text-xl font-bold text-gray-800 mb-4">5. สรุปและคัดลอก Order</h2>
                <textarea id="order-preview-area" rows="10" class="input-field w-full font-mono text-sm bg-gray-100" readonly></textarea>
                <button id="copy-order-button" class="copy-button mt-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                    <span id="copy-button-text">คัดลอก Order</span>
                </button>
            </div>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- CONFIGURATION ---
    const BASE_DRUGS = {
        'oral_morphine_lr': { name: 'Morphine (MST/Kapanol)', factor: 1, unit: 'mg/day', type: 'oral', family: 'morphine' },
        'sc_iv_morphine': { name: 'Morphine (SC/IV)', factor: 3, unit: 'mg/day', type: 'injectable', family: 'morphine' },
        'patch_fentanyl': { name: 'Fentanyl Patch', factor: 2.4, unit: 'mcg/hr', type: 'patch', family: 'fentanyl' },
        'iv_fentanyl': { name: 'Fentanyl IV', factor: 0.3, unit: 'mg/day', type: 'injectable', family: 'fentanyl' },
        'oral_tramadol': { name: 'Tramadol', factor: 0.1, unit: 'mg/day', type: 'oral', family: 'tramadol' },
    };

    const PRN_DRUGS = {
        'prn_ir': { name: 'Morphine IR', doseUnit: 'mg', factor: 1, family: 'morphine' },
        'prn_syrup': { name: 'Morphine Syrup', doseUnit: 'ml', factor: 2, family: 'morphine' }, // Assuming 2mg/ml
        'prn_morphine_iv': { name: 'Morphine (SC/IV)', doseUnit: 'mg', factor: 3, family: 'morphine' },
        'prn_fentanyl_iv': { name: 'Fentanyl IV', doseUnit: 'mcg', factor: 0.3/1000, family: 'fentanyl' },
    };

    const RISK_FACTORS = [
        { id: 'age_risk', text: 'ผู้ป่วยสูงอายุ (> 75 ปี)', autoManaged: true },
        { id: 'renal_risk', text: 'การทำงานของไตบกพร่อง (e.g., eGFR < 50)', autoManaged: true },
        { id: 'hepatic', text: 'การทำงานของตับบกพร่อง (e.g., Cirrhosis)' },
        { id: 'nutrition', text: 'ภาวะทุพโภชนาการ / สภาพร่างกายถดถอย' },
        { id: 'history', text: 'เปลี่ยนยาจากผลข้างเคียง (สับสน/ซึม)' },
        { id: 'meds', text: 'ใช้ยาอื่นที่ทำให้ง่วงซึมร่วมด้วย' },
    ];
    
    // --- DOM ELEMENTS ---
    const elements = {
        // ... (All getElementById calls will be here for organization)
        mainContainer: document.querySelector('main'),
        currentMedsSection: document.getElementById('current-meds-section'),
        prnInputsSection: document.getElementById('prn-inputs-section'),
        riskChecklistSection: document.getElementById('risk-checklist-section'),
        currentTotalMeddDisplay: document.getElementById('current-total-medd-display'),
        newMeddContainer: document.getElementById('new-medd-container'),
        newTotalMeddDisplay: document.getElementById('new-total-medd-display'),
        clearAllBtn: document.getElementById('clear-all-btn'),
        prnAdjustmentSection: document.getElementById('prn-adjustment-section'),
        percentAdjustmentSection: document.getElementById('percent-adjustment-section'),
        prnWarning: document.getElementById('prn-warning'),
        safetyWarningMessage: document.getElementById('safety-warning-message'),
        doubleDipWarning: document.getElementById('double-dip-warning'),
        rotationOutcomeSection: document.getElementById('rotation-outcome-section'),
        finalOrderSection: document.getElementById('final-order-section'),
        basalOptionsSection: document.getElementById('basal-options-section'),
        prnOptionsSection: document.getElementById('prn-options-section'),
        orderPreviewArea: document.getElementById('order-preview-area'),
        copyOrderButton: document.getElementById('copy-order-button'),
        copyButtonText: document.getElementById('copy-button-text'),
        clinicalRecommendationSection: document.getElementById('clinical-recommendation-section'),
        clinicalRecommendationList: document.getElementById('clinical-recommendation-list'),
    };

    // --- STATE ---
    let state = {
        currentMedd: 0,
        escalatedMedd: 0,
        newTotalMEDD: 0,
        patient: { age: null, gfr: null, pps: 70, risks: new Set() },
        adjustmentMethod: 'prn',
        escalationPercent: 0,
        safetyReductionFactor: 1.0,
        isAutoReduced: false,
        selectedBasal: null,
        selectedPrns: [],
        prnCalcPercentage: 16.67,
    };
    
    // --- UI RENDERING & INITIALIZATION ---
    function createMedicationInputs() {
        for (const key in BASE_DRUGS) {
            const config = BASE_DRUGS[key];
            elements.currentMedsSection.innerHTML += `<div class="drug-row" data-row-key="${key}">
                <label for="dose-${key}" class="font-medium text-sm text-gray-700 sr-only">${config.name}</label>
                <div class="flex items-center gap-2">
                    <span class="text-gray-600 w-3/5">${config.name}</span>
                    <input type="number" inputmode="decimal" id="dose-${key}" data-key="${key}" class="input-field base-drug-input" placeholder="0">
                    <span class="text-gray-500 w-1/5 text-right">${config.unit}</span>
                </div></div>`;
        }
    }
    
    function createPrnInputs() {
        for (const key in PRN_DRUGS) {
            const config = PRN_DRUGS[key];
            elements.prnInputsSection.innerHTML += `<div class="flex items-center gap-2">
                    <span class="text-gray-600 w-2/5">${config.name}</span>
                    <input type="number" inputmode="decimal" id="${key}-dose" data-key="${key}" data-type="dose" class="input-field prn-input" placeholder="Dose (${config.doseUnit})">
                    <input type="number" inputmode="decimal" id="${key}-times" data-key="${key}" data-type="times" class="input-field prn-input" placeholder="ครั้ง">
                </div>`;
        }
    }

    function createRiskChecklist() {
        elements.riskChecklistSection.innerHTML = RISK_FACTORS.map(factor => `
            <label for="check-${factor.id}" class="flex items-center">
                <input type="checkbox" id="check-${factor.id}" data-id="${factor.id}" class="risk-checkbox h-4 w-4 rounded border-gray-300 text-cyan-600 focus:ring-cyan-500">
                <span class="ml-3 text-sm text-gray-700">${factor.text}</span>
            </label>
        `).join('');
    }

    // --- CALCULATION LOGIC ---
    function getPatientAdjustmentFactor(drugFamily) {
        let factor = 1.0;
        const gfr = state.patient.gfr;
        const age = state.patient.age;

        if (drugFamily === 'morphine') {
            if (gfr < 10) factor *= 0.25; // 75% reduction
            else if (gfr <= 30) factor *= 0.50; // 50% reduction
            else if (gfr <= 50) factor *= 0.75; // 25% reduction
            
            if (age > 75) factor *= 0.75; // 25% reduction for elderly
        } else if (drugFamily === 'fentanyl') {
            if (gfr < 10) factor *= 0.50; // 50% reduction
            else if (gfr <= 30) factor *= 0.75; // 25% reduction
        }
        return factor;
    }

    function calculateAndRenderAll() {
        // 1. Calculate Current MEDD
        let currentTotalMEDD = 0;
        document.querySelectorAll('.base-drug-input').forEach(input => {
            currentTotalMEDD += (parseFloat(input.value) || 0) * BASE_DRUGS[input.dataset.key].factor;
        });
        state.currentMedd = currentTotalMEDD;

        // 2. Calculate Escalated MEDD
        let escalatedMEDD = currentTotalMEDD;
        if (state.adjustmentMethod === 'prn') {
            let prnMedd = 0;
            let totalPrnTimes = 0;
            for (const key in PRN_DRUGS) {
                const dose = parseFloat(document.getElementById(`${key}-dose`).value) || 0;
                const times = parseFloat(document.getElementById(`${key}-times`).value) || 0;
                totalPrnTimes += times;
                prnMedd += (dose * times) * PRN_DRUGS[key].factor;
            }
            elements.prnWarning.classList.toggle('hidden', totalPrnTimes >= 3 || totalPrnTimes === 0);
            if (totalPrnTimes >= 3) {
                escalatedMEDD += prnMedd;
            }
        } else if (state.adjustmentMethod === 'percent') {
            escalatedMEDD *= (1 + (state.escalationPercent / 100));
        }
        state.escalatedMedd = escalatedMEDD;
        
        // 3. Apply Overall Safety Reduction
        state.newTotalMEDD = state.escalatedMedd * state.safetyReductionFactor;

        // --- RENDER UPDATES ---
        renderHeader();
        renderRiskAssessment();
        renderNewRegimenOptions();
        renderOrderPreview();
    }

    // --- UI RENDERING SUB-FUNCTIONS ---
    function renderHeader() {
        elements.currentTotalMeddDisplay.textContent = state.currentMedd.toFixed(1);
        elements.newTotalMeddDisplay.textContent = state.newTotalMEDD.toFixed(1);
        const isAdjusted = Math.abs(state.newTotalMEDD - state.currentMedd) > 0.01 || state.currentMedd > 0;
        elements.newMeddContainer.style.opacity = isAdjusted ? '1' : '0';
        elements.rotationOutcomeSection.classList.toggle('visible', isAdjusted);
        elements.finalOrderSection.style.opacity = isAdjusted ? '1' : '0';
    }
    
    function renderRiskAssessment() {
        // Auto-check based on inputs
        const age = state.patient.age;
        const gfr = state.patient.gfr;
        const ageRiskCheckbox = document.getElementById('check-age_risk');
        const renalRiskCheckbox = document.getElementById('check-renal_risk');

        if (ageRiskCheckbox) {
            const isAgeRisk = age > 75;
            ageRiskCheckbox.checked = isAgeRisk;
            ageRiskCheckbox.disabled = isAgeRisk;
            if(isAgeRisk) state.patient.risks.add('age_risk'); else state.patient.risks.delete('age_risk');
        }
        if (renalRiskCheckbox) {
            const isRenalRisk = gfr < 50 && gfr !== null;
            renalRiskCheckbox.checked = isRenalRisk;
            renalRiskCheckbox.disabled = isRenalRisk;
            if(isRenalRisk) state.patient.risks.add('renal_risk'); else state.patient.risks.delete('renal_risk');
        }
        
        // Show/hide warnings
        elements.safetyWarningMessage.classList.toggle('hidden', state.patient.risks.size === 0);
        state.isAutoReduced = (age > 75 || (gfr !== null && gfr < 50));
        elements.doubleDipWarning.classList.toggle('hidden', !state.isAutoReduced);

        // Clinical recommendations
        const recommendations = [];
        if (state.patient.pps < 50) recommendations.push("PPS < 50: ผู้ป่วยอาจกลืนลำบาก ควรพิจารณาให้ยาทาง SC/IV หรือแผ่นแปะ");
        if (gfr < 10) recommendations.push("GFR < 10: ขนาดยา Morphine/Fentanyl จะถูกปรับลดอัตโนมัติ");
        else if (gfr <= 30) recommendations.push("GFR 10-30: ขนาดยา Morphine/Fentanyl จะถูกปรับลดอัตโนมัติ");
        else if (gfr <= 50) recommendations.push("GFR 31-50: ขนาดยา Morphine จะถูกปรับลดอัตโนมัติ");
        if (age > 75) recommendations.push("ผู้ป่วยสูงอายุ (>75 ปี): ขนาดยา Morphine จะถูกปรับลดอัตโนมัติ");
        
        elements.clinicalRecommendationList.innerHTML = recommendations.map(r => `<li>${r}</li>`).join('');
        elements.clinicalRecommendationSection.classList.toggle('hidden', recommendations.length === 0);
    }

    function renderNewRegimenOptions() {
        const newMedd = state.newTotalMEDD;
        if (newMedd <= 0) {
            elements.basalOptionsSection.innerHTML = '';
            elements.prnOptionsSection.innerHTML = '';
            return;
        }

        const basalDoses = {
            basal_oral_mst: { ...BASE_DRUGS.oral_morphine_lr, baseDose: newMedd },
            basal_morphine_csci: { ...BASE_DRUGS.sc_iv_morphine, name: 'Morphine CSCI', baseDose: newMedd / 3 },
            basal_fentanyl_patch: { ...BASE_DRUGS.patch_fentanyl, baseDose: newMedd / 2.4 },
        };

        elements.basalOptionsSection.innerHTML = Object.keys(basalDoses).map(key => {
            const option = basalDoses[key];
            const patientAdjFactor = getPatientAdjustmentFactor(option.family);
            const adjustedDose = option.baseDose * patientAdjFactor;
            let badgeHtml = '';
            if (patientAdjFactor < 1) badgeHtml += `<div class="badge !bg-sky-600" title="ปรับลดอัตโนมัติตามค่าไต/อายุ">ไต/อายุ</div>`;
            if (state.safetyReductionFactor < 1) badgeHtml += `<div class="badge" title="ปรับลดโดยรวมที่เลือกไว้">ลด ${((1-state.safetyReductionFactor)*100).toFixed(0)}%</div>`;
            
            return `<label>
                <input type="radio" name="basal-option" value="${key}" class="hidden" ${state.selectedBasal === key ? 'checked' : ''}>
                <div class="option-card">
                    <div class="badge-container">${badgeHtml}</div>
                    <p class="font-semibold text-gray-800">${option.name}</p>
                    <p class="text-xl font-bold text-cyan-700">${adjustedDose.toFixed(1)} <span class="text-base font-medium text-gray-600">${option.unit}</span></p>
                </div>
            </label>`;
        }).join('');
        
        const prnDoses = {
            prn_option_ir: { ...PRN_DRUGS.prn_ir, name: "Morphine IR (Tab)", baseDose: newMedd * (state.prnCalcPercentage / 100) },
            prn_option_sc_iv: { ...PRN_DRUGS.prn_morphine_iv, name: "Morphine SC/IV", baseDose: (newMedd * (state.prnCalcPercentage / 100)) / 3 },
            prn_option_fentanyl_iv: { ...PRN_DRUGS.prn_fentanyl_iv, name: "Fentanyl IV", baseDose: (newMedd / (BASE_DRUGS.iv_fentanyl.factor*1000)) * (state.prnCalcPercentage / 100) },
        };

        elements.prnOptionsSection.innerHTML = Object.keys(prnDoses).map(key => {
             const option = prnDoses[key];
            const patientAdjFactor = getPatientAdjustmentFactor(option.family);
            const adjustedDose = option.baseDose * patientAdjFactor;
            let badgeHtml = '';
            if (patientAdjFactor < 1) badgeHtml += `<div class="badge !bg-sky-600" title="ปรับลดอัตโนมัติตามค่าไต/อายุ">ไต/อายุ</div>`;
            
            return `<label>
                <input type="checkbox" name="prn-option" value="${key}" class="hidden" ${state.selectedPrns.includes(key) ? 'checked' : ''}>
                <div class="option-card">
                    <div class="badge-container">${badgeHtml}</div>
                    <p class="font-semibold text-gray-800">${option.name}</p>
                    <p class="text-xl font-bold text-cyan-700">${adjustedDose.toFixed(1)} <span class="text-base font-medium text-gray-600">${option.doseUnit}</span></p>
                </div>
            </label>`;
        }).join('');
    }

    function renderOrderPreview() {
        let orderText = `--- Palliative Care Order ---\n`;
        const timestamp = new Date().toLocaleString('th-TH', { dateStyle: 'short', timeStyle: 'short' });
        orderText += `(Generated: ${timestamp})\n\n`;
        orderText += `Based on New Total MEDD: ${state.newTotalMEDD.toFixed(1)} mg/day\n\n`;

        if (state.selectedBasal) {
             orderText += `New Basal Dose:\n1. [Order for ${state.selectedBasal}]\n`;
        }
        if (state.selectedPrns.length > 0) {
            orderText += `\nNew PRN Dose:\n`;
            state.selectedPrns.forEach((key, index) => {
                 orderText += `${index + 1}. [Order for ${key}]\n`;
            });
        }
        
        let notes = [];
        if (state.patient.gfr < 50) notes.push(`- Dose adjusted for renal function (eGFR ${state.patient.gfr}).`);
        if (state.patient.age > 75) notes.push(`- Dose adjusted for elderly patient (Age ${state.patient.age}).`);
        if (state.safetyReductionFactor < 1) notes.push(`- Overall ${(100 - state.safetyReductionFactor * 100)}% safety reduction applied.`);
        if (notes.length > 0) {
            orderText += `\n--- Clinical Notes ---\n${notes.join('\n')}`;
        }

        elements.orderPreviewArea.value = orderText.trim();
    }
    
    // --- EVENT LISTENERS ---
    function initializeEventListeners() {
        elements.mainContainer.addEventListener('input', (e) => {
            const target = e.target;
            if (target.matches('.base-drug-input, .prn-input')) {
                calculateAndRenderAll();
            } else if (target.matches('#age-input, #gfr-input, #pps-score')) {
                state.patient[target.id.split('-')[0]] = parseFloat(target.value) || null;
                calculateAndRenderAll();
            }
        });
        
        elements.mainContainer.addEventListener('change', (e) => {
            const target = e.target;
            if (target.name === 'adjustment-method') {
                state.adjustmentMethod = target.value;
                elements.prnAdjustmentSection.classList.toggle('disabled', state.adjustmentMethod !== 'prn');
                elements.percentAdjustmentSection.classList.toggle('disabled', state.adjustmentMethod !== 'percent');
                calculateAndRenderAll();
            } else if (target.matches('.risk-checkbox')) {
                if (target.checked) state.patient.risks.add(target.dataset.id);
                else state.patient.risks.delete(target.dataset.id);
                calculateAndRenderAll();
            } else if (target.name === 'basal-option') {
                state.selectedBasal = target.value;
                renderOrderPreview();
            } else if (target.name === 'prn-option') {
                state.selectedPrns = Array.from(document.querySelectorAll('input[name="prn-option"]:checked')).map(el => el.value);
                renderOrderPreview();
            } else if(target.id === 'prn-calc-method') {
                state.prnCalcPercentage = parseFloat(target.value);
                calculateAndRenderAll();
            }
        });

        elements.mainContainer.addEventListener('click', (e) => {
            const target = e.target.closest('.action-btn');
            if (!target) return;

            if (target.matches('.percent-btn')) {
                document.querySelectorAll('.percent-btn').forEach(btn => btn.classList.remove('active'));
                target.classList.add('active');
                state.escalationPercent = parseFloat(target.dataset.percent);
                calculateAndRenderAll();
            } else if (target.matches('.reduction-btn')) {
                 if (target.classList.contains('active')) {
                    target.classList.remove('active');
                    state.safetyReductionFactor = 1.0;
                } else {
                    document.querySelectorAll('.reduction-btn').forEach(btn => btn.classList.remove('active'));
                    target.classList.add('active');
                    state.safetyReductionFactor = parseFloat(target.dataset.factor);
                }
                calculateAndRenderAll();
            }
        });

        elements.clearAllBtn.addEventListener('click', () => {
            // Full reset logic here
            window.location.reload();
        });
        
        elements.copyOrderButton.addEventListener('click', () => {
            elements.orderPreviewArea.select();
            document.execCommand('copy');
            elements.copyButtonText.textContent = 'คัดลอกแล้ว!';
            elements.copyOrderButton.classList.add('copied');
            setTimeout(() => {
                elements.copyButtonText.textContent = 'คัดลอก Order';
                elements.copyOrderButton.classList.remove('copied');
            }, 2000);
        });
    }

    // --- INITIALIZATION ---
    createMedicationInputs();
    createPrnInputs();
    createRiskChecklist();
    initializeEventListeners();
    calculateAndRenderAll(); // Initial calculation
    elements.prnAdjustmentSection.classList.toggle('disabled', state.adjustmentMethod !== 'prn');
    elements.percentAdjustmentSection.classList.toggle('disabled', state.adjustmentMethod !== 'percent');
});
</script>

</body>
</html>
